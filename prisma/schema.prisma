// Prisma Schema for Core System (النظام الأم)
// All tables use 'core_' prefix as per strict rules

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 1. الهيكل التنظيمي ====================

/// المجموعات/الشركات (Businesses)
model core_businesses {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  logo        String?  @db.VarChar(500)
  address     String?  @db.Text
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  taxNumber   String?  @map("tax_number") @db.VarChar(50)
  settings    Json?    @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  stations    core_stations[]
  users       core_users[]
  roles       core_roles[]
  accounts    core_accounts[]
  settings_list core_settings[]
  journalEntries core_journal_entries[]
  auditLogs     core_audit_logs[]

  @@map("core_businesses")
}

/// المحطات (Stations)
model core_stations {
  id            String   @id @default(uuid()) @db.Uuid
  businessId    String   @map("business_id") @db.Uuid
  parentId      String?  @map("parent_id") @db.Uuid
  code          String?  @db.VarChar(20)
  name          String   @db.VarChar(255)
  nameEn        String?  @map("name_en") @db.VarChar(255)
  type          StationType @default(generation_distribution)
  level         Int      @default(1)
  location      String?  @db.VarChar(255)
  address       String?  @db.Text
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  hasGenerators Boolean  @default(false) @map("has_generators")
  hasSolar      Boolean  @default(false) @map("has_solar")
  generatorCapacity Decimal? @map("generator_capacity") @db.Decimal(10, 2)
  solarCapacity     Decimal? @map("solar_capacity") @db.Decimal(10, 2)
  managerName   String?  @map("manager_name") @db.VarChar(255)
  managerPhone  String?  @map("manager_phone") @db.VarChar(20)
  contactPhone  String?  @map("contact_phone") @db.VarChar(20)
  contactEmail  String?  @map("contact_email") @db.VarChar(255)
  workingHours  String?  @map("working_hours") @db.VarChar(100)
  settings      Json?    @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  business       core_businesses @relation(fields: [businessId], references: [id])
  parent         core_stations?  @relation("StationHierarchy", fields: [parentId], references: [id])
  children       core_stations[] @relation("StationHierarchy")
  journalEntries core_journal_entries[]
  stationUsers   core_station_users[]

  @@index([businessId])
  @@index([parentId])
  @@map("core_stations")
}

/// ربط المستخدمين بالمحطات (Station-Users)
model core_station_users {
  id        String   @id @default(uuid()) @db.Uuid
  stationId String   @map("station_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String?  @db.VarChar(50)
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  station core_stations @relation(fields: [stationId], references: [id], onDelete: Cascade)
  user    core_users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([stationId, userId])
  @@index([userId])
  @@map("core_station_users")
}

enum StationType {
  generation_distribution
  solar
  distribution_only
}

/// الإعدادات (Settings)
model core_settings {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String?  @map("business_id") @db.Uuid
  stationId   String?  @map("station_id") @db.Uuid
  key         String   @db.VarChar(100)
  value       Json
  category    String   @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business    core_businesses? @relation(fields: [businessId], references: [id])

  @@unique([businessId, stationId, key])
  @@map("core_settings")
}

// ==================== 2. المستخدمين والصلاحيات ====================

/// المستخدمين (Users)
model core_users {
  id            String    @id @default(uuid()) @db.Uuid
  businessId    String    @map("business_id") @db.Uuid
  name          String    @db.VarChar(255)
  email         String    @unique @db.VarChar(255)
  phone         String?   @db.VarChar(20)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  scopeType     ScopeType @default(station) @map("scope_type")
  scopeIds      Json?     @default("[]") @map("scope_ids")
  isOwner       Boolean   @default(false) @map("is_owner")
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  business      core_businesses @relation(fields: [businessId], references: [id])
  userRoles     core_user_roles[]
  refreshTokens core_refresh_tokens[]
  auditLogs     core_audit_logs[]
  journalEntries core_journal_entries[] @relation("CreatedBy")
  postedEntries  core_journal_entries[] @relation("PostedBy")
  stationUsers   core_station_users[]
  collectors     core_collectors[]

  @@index([businessId])
  @@index([email])
  @@map("core_users")
}

enum ScopeType {
  business
  station
}

/// الأدوار (Roles)
model core_roles {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String?  @map("business_id") @db.Uuid
  name        String   @db.VarChar(100)
  nameEn      String?  @map("name_en") @db.VarChar(100)
  description String?  @db.Text
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business        core_businesses? @relation(fields: [businessId], references: [id])
  rolePermissions core_role_permissions[]
  userRoles       core_user_roles[]

  @@unique([businessId, name])
  @@map("core_roles")
}

/// الصلاحيات (Permissions)
model core_permissions {
  id          String   @id @default(uuid()) @db.Uuid
  module      String   @db.VarChar(50)
  action      String   @db.VarChar(50)
  name        String   @db.VarChar(100)
  nameEn      String?  @map("name_en") @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions core_role_permissions[]

  @@unique([module, action])
  @@map("core_permissions")
}

/// ربط الأدوار بالصلاحيات (Role-Permissions)
model core_role_permissions {
  id           String   @id @default(uuid()) @db.Uuid
  roleId       String   @map("role_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       core_roles       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission core_permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("core_role_permissions")
}

/// ربط المستخدمين بالأدوار (User-Roles)
model core_user_roles {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  roleId    String   @map("role_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user core_users @relation(fields: [userId], references: [id], onDelete: Cascade)
  role core_roles @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("core_user_roles")
}

/// Refresh Tokens
model core_refresh_tokens {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  token       String   @unique @db.VarChar(500)
  expiresAt   DateTime @map("expires_at")
  isRevoked   Boolean  @default(false) @map("is_revoked")
  createdAt   DateTime @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  ipAddress   String?  @map("ip_address") @db.VarChar(45)

  // Relations
  user core_users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("core_refresh_tokens")
}

// ==================== 3. النظام المالي ====================

/// شجرة الحسابات (Chart of Accounts)
model core_accounts {
  id            String      @id @default(uuid()) @db.Uuid
  businessId    String      @map("business_id") @db.Uuid
  parentId      String?     @map("parent_id") @db.Uuid
  code          String      @db.VarChar(20)
  name          String      @db.VarChar(255)
  nameEn        String?     @map("name_en") @db.VarChar(255)
  type          AccountType
  nature        AccountNature
  level         Int         @default(1)
  isParent      Boolean     @default(false) @map("is_parent")
  isActive      Boolean     @default(true) @map("is_active")
  systemAccount String?     @map("system_account") @db.VarChar(50)
  description   String?     @db.Text
  deletedAt     DateTime?   @map("deleted_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  business      core_businesses @relation(fields: [businessId], references: [id])
  parent        core_accounts?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children      core_accounts[] @relation("AccountHierarchy")
  journalLines  core_journal_entry_lines[]
  services      core_services[] @relation("ServiceRevenueAccount")

  @@unique([businessId, code])
  @@index([businessId])
  @@index([parentId])
  @@index([type])
  @@map("core_accounts")
}

enum AccountType {
  asset
  liability
  equity
  revenue
  expense
}

enum AccountNature {
  debit
  credit
}

/// القيود اليومية (Journal Entries)
model core_journal_entries {
  id            String        @id @default(uuid()) @db.Uuid
  businessId    String        @map("business_id") @db.Uuid
  stationId     String?       @map("station_id") @db.Uuid
  entryNumber   String        @map("entry_number") @db.VarChar(50)
  entryDate     DateTime      @map("entry_date") @db.Date
  description   String?       @db.Text
  referenceType String?       @map("reference_type") @db.VarChar(50)
  referenceId   String?       @map("reference_id") @db.Uuid
  totalDebit    Decimal       @default(0) @map("total_debit") @db.Decimal(15, 2)
  totalCredit   Decimal       @default(0) @map("total_credit") @db.Decimal(15, 2)
  status        EntryStatus   @default(draft)
  createdBy     String        @map("created_by") @db.Uuid
  postedBy      String?       @map("posted_by") @db.Uuid
  postedAt      DateTime?     @map("posted_at")
  deletedAt     DateTime?     @map("deleted_at")
  deletedBy     String?       @map("deleted_by") @db.Uuid
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  business      core_businesses @relation(fields: [businessId], references: [id])
  station       core_stations?  @relation(fields: [stationId], references: [id])
  creator       core_users      @relation("CreatedBy", fields: [createdBy], references: [id])
  poster        core_users?     @relation("PostedBy", fields: [postedBy], references: [id])
  lines         core_journal_entry_lines[]

  @@unique([businessId, entryNumber])
  @@index([businessId])
  @@index([stationId])
  @@index([entryDate])
  @@index([status])
  @@map("core_journal_entries")
}

enum EntryStatus {
  draft
  posted
  voided
}

/// سطور القيود (Journal Entry Lines)
model core_journal_entry_lines {
  id            String   @id @default(uuid()) @db.Uuid
  journalEntryId String  @map("journal_entry_id") @db.Uuid
  accountId     String   @map("account_id") @db.Uuid
  debit         Decimal  @default(0) @db.Decimal(15, 2)
  credit        Decimal  @default(0) @db.Decimal(15, 2)
  description   String?  @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  journalEntry  core_journal_entries @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account       core_accounts @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@map("core_journal_entry_lines")
}

/// الفترات المحاسبية (Accounting Periods)
model core_accounting_periods {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  name        String   @db.VarChar(100)
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  isClosed    Boolean  @default(false) @map("is_closed")
  closedAt    DateTime? @map("closed_at")
  closedBy    String?  @map("closed_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([businessId, name])
  @@index([businessId])
  @@map("core_accounting_periods")
}

// ==================== 4. سجل التدقيق ====================

/// سجل التدقيق (Audit Logs)
model core_audit_logs {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  action      String   @db.VarChar(50)
  entityType  String   @map("entity_type") @db.VarChar(100)
  entityId    String   @map("entity_id") @db.Uuid
  oldValue    String?  @map("old_value") @db.Text
  newValue    String?  @map("new_value") @db.Text
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  description String?  @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user        core_users @relation(fields: [userId], references: [id])
  business    core_businesses @relation(fields: [businessId], references: [id])

  @@index([userId])
  @@index([businessId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("core_audit_logs")
}


// ==================== 5. النظام المالي المتقدم ====================

/// مراكز التكلفة (Cost Centers)
model core_cost_centers {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  stationId   String?  @map("station_id") @db.Uuid
  code        String   @db.VarChar(20)
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  type        CostCenterType @default(station)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([businessId, code])
  @@index([businessId])
  @@map("core_cost_centers")
}

enum CostCenterType {
  station
  department
  project
}

/// الحسابات الوسيطة (Clearing Accounts)
model core_clearing_accounts {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  accountId   String   @map("account_id") @db.Uuid
  code        String   @db.VarChar(20)
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  type        ClearingAccountType
  balance     Decimal  @default(0) @db.Decimal(15, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  entries     core_clearing_entries[]

  @@unique([businessId, code])
  @@index([businessId])
  @@map("core_clearing_accounts")
}

enum ClearingAccountType {
  bank          // حساب البنك الوسيط
  revenue       // حساب الإيرادات الوسيط
  expense       // حساب المصروفات الوسيط
  receivable    // حساب الذمم الوسيط
}

/// قيود الحسابات الوسيطة (Clearing Entries)
model core_clearing_entries {
  id                String   @id @default(uuid()) @db.Uuid
  clearingAccountId String   @map("clearing_account_id") @db.Uuid
  entryDate         DateTime @map("entry_date") @db.Date
  amount            Decimal  @db.Decimal(15, 2)
  referenceType     String   @map("reference_type") @db.VarChar(50)
  referenceId       String?  @map("reference_id") @db.Uuid
  referenceNumber   String?  @map("reference_number") @db.VarChar(100)
  description       String?  @db.Text
  status            ClearingEntryStatus @default(pending)
  matchedAt         DateTime? @map("matched_at")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  clearingAccount   core_clearing_accounts @relation(fields: [clearingAccountId], references: [id])
  allocations       core_reconciliation_allocations[]

  @@index([clearingAccountId])
  @@index([entryDate])
  @@index([status])
  @@map("core_clearing_entries")
}

enum ClearingEntryStatus {
  pending     // معلق
  matched     // تمت المطابقة
  allocated   // تم التوزيع
  closed      // مغلق
}

/// قواعد التسوية (Reconciliation Rules)
model core_reconciliation_rules {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  priority    Int      @default(1)
  matchFields Json     @map("match_fields")  // ["reference_number", "amount", "date"]
  tolerance   Json?    // {"amount": 0.01, "date_days": 3}
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  matches     core_reconciliation_matches[]

  @@index([businessId])
  @@map("core_reconciliation_rules")
}

/// التسويات (Reconciliations)
model core_reconciliations {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  type        ReconciliationType
  name        String   @db.VarChar(255)
  periodStart DateTime @map("period_start") @db.Date
  periodEnd   DateTime @map("period_end") @db.Date
  status      ReconciliationStatus @default(draft)
  totalItems  Int      @default(0) @map("total_items")
  matchedItems Int     @default(0) @map("matched_items")
  unmatchedItems Int   @default(0) @map("unmatched_items")
  totalAmount Decimal  @default(0) @map("total_amount") @db.Decimal(15, 2)
  matchedAmount Decimal @default(0) @map("matched_amount") @db.Decimal(15, 2)
  createdBy   String   @map("created_by") @db.Uuid
  finalizedBy String?  @map("finalized_by") @db.Uuid
  finalizedAt DateTime? @map("finalized_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  matches     core_reconciliation_matches[]
  allocations core_reconciliation_allocations[]
  history     core_reconciliation_history[]
  exceptions  core_reconciliation_exceptions[]

  @@index([businessId])
  @@index([type])
  @@index([status])
  @@map("core_reconciliations")
}

enum ReconciliationType {
  bank        // تسوية البنك
  revenue     // تسوية الإيرادات
  expense     // تسوية المصروفات
  receivable  // تسوية الذمم
}

enum ReconciliationStatus {
  draft       // مسودة
  in_progress // قيد التنفيذ
  pending_review // في انتظار المراجعة
  finalized   // مكتملة
  cancelled   // ملغاة
}

/// مطابقات التسوية (Reconciliation Matches)
model core_reconciliation_matches {
  id              String   @id @default(uuid()) @db.Uuid
  reconciliationId String  @map("reconciliation_id") @db.Uuid
  sourceEntryId   String?  @map("source_entry_id") @db.Uuid
  targetEntryId   String?  @map("target_entry_id") @db.Uuid
  matchType       MatchType @map("match_type")
  matchRuleId     String?  @map("match_rule_id") @db.Uuid
  amount          Decimal  @db.Decimal(15, 2)
  difference      Decimal  @default(0) @db.Decimal(15, 2)
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  reconciliation  core_reconciliations @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  matchRule       core_reconciliation_rules? @relation(fields: [matchRuleId], references: [id])

  @@index([reconciliationId])
  @@map("core_reconciliation_matches")
}

enum MatchType {
  one_to_one    // 1:1
  one_to_many   // 1:N
  many_to_one   // N:1
  many_to_many  // N:M
  manual        // يدوي
}

/// توزيعات التسوية (Reconciliation Allocations)
model core_reconciliation_allocations {
  id              String   @id @default(uuid()) @db.Uuid
  reconciliationId String  @map("reconciliation_id") @db.Uuid
  clearingEntryId String   @map("clearing_entry_id") @db.Uuid
  targetAccountId String   @map("target_account_id") @db.Uuid
  amount          Decimal  @db.Decimal(15, 2)
  journalEntryId  String?  @map("journal_entry_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  reconciliation  core_reconciliations @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  clearingEntry   core_clearing_entries @relation(fields: [clearingEntryId], references: [id])

  @@index([reconciliationId])
  @@index([clearingEntryId])
  @@map("core_reconciliation_allocations")
}

/// سجل التسوية (Reconciliation History)
model core_reconciliation_history {
  id              String   @id @default(uuid()) @db.Uuid
  reconciliationId String  @map("reconciliation_id") @db.Uuid
  action          String   @db.VarChar(50)
  details         Json?
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  reconciliation  core_reconciliations @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)

  @@index([reconciliationId])
  @@map("core_reconciliation_history")
}

/// استثناءات التسوية (Reconciliation Exceptions)
model core_reconciliation_exceptions {
  id              String   @id @default(uuid()) @db.Uuid
  reconciliationId String  @map("reconciliation_id") @db.Uuid
  entryId         String?  @map("entry_id") @db.Uuid
  exceptionType   ExceptionType @map("exception_type")
  amount          Decimal  @db.Decimal(15, 2)
  notes           String?  @db.Text
  resolved        Boolean  @default(false)
  resolvedBy      String?  @map("resolved_by") @db.Uuid
  resolvedAt      DateTime? @map("resolved_at")
  resolution      String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  reconciliation  core_reconciliations @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)

  @@index([reconciliationId])
  @@index([resolved])
  @@map("core_reconciliation_exceptions")
}

enum ExceptionType {
  unmatched       // غير متطابق
  amount_mismatch // فرق في المبلغ
  date_mismatch   // فرق في التاريخ
  duplicate       // مكرر
  missing         // مفقود
  other           // أخرى
}

/// قوالب التقارير (Report Templates)
model core_report_templates {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String?  @map("business_id") @db.Uuid
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  type        ReportType
  config      Json     // تكوين التقرير
  isSystem    Boolean  @default(false) @map("is_system")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  generatedReports core_generated_reports[]
  schedules        core_report_schedules[]

  @@index([businessId])
  @@index([type])
  @@map("core_report_templates")
}

enum ReportType {
  income_statement    // قائمة الدخل
  balance_sheet       // الميزانية العمومية
  cash_flow           // التدفقات النقدية
  trial_balance       // ميزان المراجعة
  general_ledger      // دفتر الأستاذ
  journal_book        // دفتر اليومية
  account_statement   // كشف حساب
  custom              // مخصص
}

/// التقارير المُنشأة (Generated Reports)
model core_generated_reports {
  id          String   @id @default(uuid()) @db.Uuid
  templateId  String   @map("template_id") @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  periodStart DateTime @map("period_start") @db.Date
  periodEnd   DateTime @map("period_end") @db.Date
  data        Json     // بيانات التقرير
  parameters  Json?    // معاملات التقرير
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  template    core_report_templates @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([businessId])
  @@index([createdAt])
  @@map("core_generated_reports")
}

/// جدولة التقارير (Report Schedules)
model core_report_schedules {
  id          String   @id @default(uuid()) @db.Uuid
  templateId  String   @map("template_id") @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  frequency   ScheduleFrequency
  dayOfMonth  Int?     @map("day_of_month")
  dayOfWeek   Int?     @map("day_of_week")
  time        String   @db.VarChar(5)  // HH:MM
  recipients  Json     // قائمة المستلمين
  parameters  Json?    // معاملات التقرير
  nextRun     DateTime @map("next_run")
  lastRun     DateTime? @map("last_run")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  template    core_report_templates @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([businessId])
  @@index([nextRun])
  @@map("core_report_schedules")
}

enum ScheduleFrequency {
  daily
  weekly
  monthly
  quarterly
  yearly
}


// ==================== 6. إدارة صندوق التحصيل ====================

/// صناديق التحصيل (Cash Boxes)
model core_cash_boxes {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  stationId   String?  @map("station_id") @db.Uuid
  code        String   @db.VarChar(20)
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  accountId   String?  @map("account_id") @db.Uuid  // الحساب المرتبط
  clearingAccountId String? @map("clearing_account_id") @db.Uuid  // الحساب الوسيط
  openingBalance Decimal @default(0) @map("opening_balance") @db.Decimal(15, 2)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(15, 2)
  maxLimit    Decimal? @map("max_limit") @db.Decimal(15, 2)  // الحد الأقصى
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  collectors  core_collectors[]
  sessions    core_cash_box_sessions[]
  transactions core_cash_box_transactions[]

  @@unique([businessId, code])
  @@index([businessId])
  @@index([stationId])
  @@map("core_cash_boxes")
}

/// المتحصلين (Collectors)
model core_collectors {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  cashBoxId   String?  @map("cash_box_id") @db.Uuid
  code        String   @db.VarChar(20)
  name        String   @db.VarChar(255)
  phone       String?  @db.VarChar(20)
  maxCollectionLimit Decimal? @map("max_collection_limit") @db.Decimal(15, 2)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(15, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        core_users @relation(fields: [userId], references: [id])
  cashBox     core_cash_boxes? @relation(fields: [cashBoxId], references: [id])
  sessions    core_collector_sessions[]
  collections core_collections[]

  @@unique([businessId, code])
  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@map("core_collectors")
}

/// جلسات صندوق التحصيل (Cash Box Sessions)
model core_cash_box_sessions {
  id          String   @id @default(uuid()) @db.Uuid
  cashBoxId   String   @map("cash_box_id") @db.Uuid
  openedBy    String   @map("opened_by") @db.Uuid
  closedBy    String?  @map("closed_by") @db.Uuid
  openingBalance Decimal @map("opening_balance") @db.Decimal(15, 2)
  closingBalance Decimal? @map("closing_balance") @db.Decimal(15, 2)
  expectedBalance Decimal? @map("expected_balance") @db.Decimal(15, 2)
  difference  Decimal? @db.Decimal(15, 2)  // الفرق
  totalIn     Decimal  @default(0) @map("total_in") @db.Decimal(15, 2)
  totalOut    Decimal  @default(0) @map("total_out") @db.Decimal(15, 2)
  status      CashBoxSessionStatus @default(open)
  openedAt    DateTime @default(now()) @map("opened_at")
  closedAt    DateTime? @map("closed_at")
  notes       String?  @db.Text

  // Relations
  cashBox     core_cash_boxes @relation(fields: [cashBoxId], references: [id])
  transactions core_cash_box_transactions[]

  @@index([cashBoxId])
  @@index([status])
  @@index([openedAt])
  @@map("core_cash_box_sessions")
}

enum CashBoxSessionStatus {
  open        // مفتوحة
  closed      // مغلقة
  reconciled  // تمت التسوية
}

/// حركات صندوق التحصيل (Cash Box Transactions)
model core_cash_box_transactions {
  id          String   @id @default(uuid()) @db.Uuid
  cashBoxId   String   @map("cash_box_id") @db.Uuid
  sessionId   String?  @map("session_id") @db.Uuid
  type        CashBoxTransactionType
  amount      Decimal  @db.Decimal(15, 2)
  referenceType String? @map("reference_type") @db.VarChar(50)
  referenceId String?  @map("reference_id") @db.Uuid
  referenceNumber String? @map("reference_number") @db.VarChar(100)
  description String?  @db.Text
  collectorId String?  @map("collector_id") @db.Uuid
  journalEntryId String? @map("journal_entry_id") @db.Uuid
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  cashBox     core_cash_boxes @relation(fields: [cashBoxId], references: [id])
  session     core_cash_box_sessions? @relation(fields: [sessionId], references: [id])

  @@index([cashBoxId])
  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
  @@map("core_cash_box_transactions")
}

enum CashBoxTransactionType {
  collection      // تحصيل
  deposit         // إيداع للبنك
  withdrawal      // سحب
  transfer_in     // تحويل وارد
  transfer_out    // تحويل صادر
  expense         // مصروف
  adjustment      // تسوية
}

/// جلسات المتحصلين (Collector Sessions)
model core_collector_sessions {
  id          String   @id @default(uuid()) @db.Uuid
  collectorId String   @map("collector_id") @db.Uuid
  openingBalance Decimal @map("opening_balance") @db.Decimal(15, 2)
  closingBalance Decimal? @map("closing_balance") @db.Decimal(15, 2)
  totalCollected Decimal @default(0) @map("total_collected") @db.Decimal(15, 2)
  totalDeposited Decimal @default(0) @map("total_deposited") @db.Decimal(15, 2)
  status      CollectorSessionStatus @default(active)
  startedAt   DateTime @default(now()) @map("started_at")
  endedAt     DateTime? @map("ended_at")
  notes       String?  @db.Text

  // Relations
  collector   core_collectors @relation(fields: [collectorId], references: [id])
  collections core_collections[]

  @@index([collectorId])
  @@index([status])
  @@index([startedAt])
  @@map("core_collector_sessions")
}

enum CollectorSessionStatus {
  active      // نشطة
  ended       // منتهية
  reconciled  // تمت التسوية
}

/// التحصيلات (Collections)
model core_collections {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  collectorId String   @map("collector_id") @db.Uuid
  sessionId   String?  @map("session_id") @db.Uuid
  receiptNumber String @map("receipt_number") @db.VarChar(50)
  collectionDate DateTime @map("collection_date") @db.Date
  amount      Decimal  @db.Decimal(15, 2)
  paymentMethod PaymentMethod @default(cash) @map("payment_method")
  referenceType String? @map("reference_type") @db.VarChar(50)  // invoice, subscription, etc.
  referenceId String?  @map("reference_id") @db.Uuid
  customerId  String?  @map("customer_id") @db.Uuid
  customerName String? @map("customer_name") @db.VarChar(255)
  notes       String?  @db.Text
  status      CollectionStatus @default(pending)
  depositedAt DateTime? @map("deposited_at")
  depositReference String? @map("deposit_reference") @db.VarChar(100)
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  collector   core_collectors @relation(fields: [collectorId], references: [id])
  session     core_collector_sessions? @relation(fields: [sessionId], references: [id])

  @@unique([businessId, receiptNumber])
  @@index([businessId])
  @@index([collectorId])
  @@index([sessionId])
  @@index([collectionDate])
  @@index([status])
  @@map("core_collections")
}

enum PaymentMethod {
  cash        // نقدي
  check       // شيك
  bank_transfer // تحويل بنكي
  pos         // نقطة بيع
  mobile      // دفع إلكتروني
}

enum CollectionStatus {
  pending     // معلق
  confirmed   // مؤكد
  deposited   // تم الإيداع
  cancelled   // ملغي
}


// ==================== 9. كتالوج الخدمات والتسعير ====================

/// فئات الخدمات (Service Categories)
model core_service_categories {
  id          String   @id @default(uuid()) @db.Uuid
  businessId  String   @map("business_id") @db.Uuid
  parentId    String?  @map("parent_id") @db.Uuid
  code        String   @db.VarChar(20)
  name        String   @db.VarChar(255)
  nameEn      String?  @map("name_en") @db.VarChar(255)
  description String?  @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  parent      core_service_categories?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    core_service_categories[] @relation("CategoryHierarchy")
  services    core_services[]

  @@unique([businessId, code])
  @@index([businessId])
  @@index([parentId])
  @@map("core_service_categories")
}

/// الخدمات (Services)
model core_services {
  id              String   @id @default(uuid()) @db.Uuid
  businessId      String   @map("business_id") @db.Uuid
  categoryId      String?  @map("category_id") @db.Uuid
  code            String   @db.VarChar(20)
  name            String   @db.VarChar(255)
  nameEn          String?  @map("name_en") @db.VarChar(255)
  description     String?  @db.Text
  serviceType     ServiceType @default(one_time) @map("service_type")
  unit            String?  @db.VarChar(50)  // kWh, unit, month, etc.
  revenueAccountId String? @map("revenue_account_id") @db.Uuid
  taxRate         Decimal? @default(0) @map("tax_rate") @db.Decimal(5, 2)
  isTaxable       Boolean  @default(false) @map("is_taxable")
  requiresMeter   Boolean  @default(false) @map("requires_meter")
  sortOrder       Int      @default(0) @map("sort_order")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  category        core_service_categories? @relation(fields: [categoryId], references: [id])
  revenueAccount  core_accounts? @relation("ServiceRevenueAccount", fields: [revenueAccountId], references: [id])
  prices          core_service_prices[]
  tiers           core_service_tiers[]

  @@unique([businessId, code])
  @@index([businessId])
  @@index([categoryId])
  @@index([serviceType])
  @@map("core_services")
}

/// أسعار الخدمات (Service Prices)
model core_service_prices {
  id          String   @id @default(uuid()) @db.Uuid
  serviceId   String   @map("service_id") @db.Uuid
  priceType   PriceType @default(fixed) @map("price_type")
  price       Decimal  @db.Decimal(15, 2)
  minQuantity Decimal? @map("min_quantity") @db.Decimal(15, 2)
  maxQuantity Decimal? @map("max_quantity") @db.Decimal(15, 2)
  customerType CustomerType? @map("customer_type")
  stationId   String?  @map("station_id") @db.Uuid
  effectiveFrom DateTime @map("effective_from") @db.Date
  effectiveTo DateTime? @map("effective_to") @db.Date
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  service     core_services @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([effectiveFrom])
  @@index([customerType])
  @@map("core_service_prices")
}

/// شرائح الخدمات (Service Tiers) - للتسعير المتدرج
model core_service_tiers {
  id          String   @id @default(uuid()) @db.Uuid
  serviceId   String   @map("service_id") @db.Uuid
  tierName    String   @map("tier_name") @db.VarChar(100)
  fromQuantity Decimal @map("from_quantity") @db.Decimal(15, 2)
  toQuantity  Decimal? @map("to_quantity") @db.Decimal(15, 2)
  pricePerUnit Decimal @map("price_per_unit") @db.Decimal(15, 4)
  fixedCharge Decimal? @default(0) @map("fixed_charge") @db.Decimal(15, 2)
  customerType CustomerType? @map("customer_type")
  effectiveFrom DateTime @map("effective_from") @db.Date
  effectiveTo DateTime? @map("effective_to") @db.Date
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  service     core_services @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([effectiveFrom])
  @@index([customerType])
  @@map("core_service_tiers")
}

enum ServiceType {
  one_time      // خدمة لمرة واحدة (رسوم توصيل، غرامات)
  recurring     // خدمة متكررة (اشتراك شهري)
  consumption   // استهلاك (كهرباء، مياه)
  prepaid       // دفع مسبق
}

enum PriceType {
  fixed         // سعر ثابت
  per_unit      // سعر لكل وحدة
  tiered        // تسعير متدرج (شرائح)
  percentage    // نسبة مئوية
}

enum CustomerType {
  residential   // سكني
  commercial    // تجاري
  industrial    // صناعي
  government    // حكومي
  agricultural  // زراعي
}
