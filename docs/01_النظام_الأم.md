# ุงููุธุงู ุงูุฃู (Core System)

> **ุขุฎุฑ ุชุญุฏูุซ:** 16 ุฏูุณูุจุฑ 2025
> **ุงูุญุงูุฉ:** ุชุตููู ููุงุฆู

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุงููุธุงู ุงูุฃู ูู **ุงูุฃุณุงุณ** ุงูุฐู ุชูุจูู ุนููู ุฌููุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู. ูุญุชูู ุนูู:
1. ุงููููู ุงูุชูุธููู (ุงููุฌููุนุฉ ูุงููุญุทุงุช)
2. ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช
3. ุงููุธุงู ุงููุงูู ุงูุฑุฆูุณู (ุดุฌุฑุฉ ุงูุญุณุงุจุงุช)

**ูู ุงูุฃูุธูุฉ ุงููุฑุนูุฉ** (ุงููุฎุฒููุ ุงููุดุชุฑูุงุชุ ุงูุนููุงุกุ ุงูุฃุตููุ ุฅูุฎ) **ูููุตูุฉ** ููููุง **ูุฑุชุจุทุฉ ูุญุงุณุจูุงู** ุจุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูู ุงููุธุงู ุงูุฃู.

---

## ๐๏ธ ูููู ุงููุธุงู ุงูุฃู

```
ุงููุธุงู ุงูุฃู
โ
โโโ 1. ุงููููู ุงูุชูุธููู
โ   โโโ ุฅุฏุงุฑุฉ ุงููุฌููุนุงุช
โ   โโโ ุฅุฏุงุฑุฉ ุงููุญุทุงุช
โ   โโโ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ
โ
โโโ 2. ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช
โ   โโโ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
โ   โโโ ุฅุฏุงุฑุฉ ุงูุฃุฏูุงุฑ
โ   โโโ ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช
โ
โโโ 3. ุงููุธุงู ุงููุงูู ุงูุฑุฆูุณู
โ   โโโ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
โ   โโโ ุงููููุฏ ุงูููููุฉ
โ   โโโ ุงูุฏูุงุชุฑ ุงููุญุงุณุจูุฉ
โ   โโโ ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุฃุณุงุณูุฉ
โ
โโโ 4. ุงููุธุงู ุงููุงูู ุงููุชูุฏู (ูุฏูุฌ ูู ููู 10)
    โโโ ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงููุชูุฏูุฉ
    โ   โโโ ูุงุฆูุฉ ุงูุฏุฎู
    โ   โโโ ุงูููุฒุงููุฉ ุงูุนููููุฉ
    โ   โโโ ุงูุชุฏููุงุช ุงูููุฏูุฉ
    โโโ ุงูุญุณุงุจุงุช ุงููุณูุทุฉ (Clearing Accounts)
    โโโ ูุญุฑู ุงูุชุณููุฉ (Reconciliation Engine)
    โโโ ุงูุชุญููู ุงููุงูู
```

---

## ๐ ุงูุฃูุธูุฉ ุงููุฑุนูุฉ ุงููุฑุชุจุทุฉ

ูู ูุธุงู ูุฑุนู:
- **ูููุตู** ูู ูุงุฌูุงุชู ูุนูููุงุชู
- **ูุฑุชุจุท ูุญุงุณุจูุงู** ุจุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูู ุงููุธุงู ุงูุฃู
- ูููุดุฆ **ูููุฏ ุชููุงุฆูุฉ** ูู ุงููุธุงู ุงููุงูู

| # | ุงููุธุงู ุงููุฑุนู | ุงูููู | ุงูุงุฑุชุจุงุท ุจุดุฌุฑุฉ ุงูุญุณุงุจุงุช |
|---|--------------|------|------------------------|
| 03 | ูุธุงู ุงูุฃุตูู (ุงูุดุจูุฉ) | `03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md` | ุงูุจููุฉ ุงูุชุญุชูุฉ ููุดุจูุฉ ุงูููุฑุจุงุฆูุฉ |
| 04 | ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ | `04_ูุธุงู_ุงูุนูููุงุช_ุงูููุฏุงููุฉ.md` | ูุตุฑููุงุช ุงูุนูููุงุชุ ุนูุฏ ุงูุนุงูููู |
| 05 | ูุธุงู ุงูุฃุตูู ูุงูุตูุงูุฉ | `03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md` | ุญุณุงุจุงุช ุงูุฃุตูู ุงูุซุงุจุชุฉ ูุงูุฅููุงู |
| 06 | ูุธุงู ุงููุฑุงูุจุฉ ูุงูุชุญูู | `05_ูุธุงู_ุงููุฑุงูุจุฉ_ูุงูุชุญูู.md` | SCADAุ ูุฑุงูุจุฉ ุงูุทุงูุฉ |
| 07 | ูุธุงู ุงููุฎุฒูู ูุงููุดุชุฑูุงุช | `06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md` | ุญุณุงุจุงุช ุงููุฎุฒููุ ุงูููุฑุฏููุ ุงููุดุชุฑูุงุช |
| 08 | ูุธุงู ุงูุนููุงุก ูุงูููุชุฑุฉ | `07_ูุธุงู_ุงูุนููุงุก_ูุงูููุชุฑุฉ.md` | ุญุณุงุจุงุช ุงูุนููุงุกุ ุงูุฅูุฑุงุฏุงุชุ ุงูุชุญุตูู |
| 09 | ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ | `08_ูุธุงู_ุงูููุงุฑุฏ_ุงูุจุดุฑูุฉ.md` | ุญุณุงุจุงุช ุงูุฑูุงุชุจุ ุงููุณุชุญูุงุชุ ุงูุณูู |

> **ููุงุญุธุฉ:** ุชู ุฏูุฌ ุงููุธุงู ุงููุงูู (ููู 10 ุณุงุจูุงู) ูู ูุฐุง ุงูููู (ุงููุณู 4๏ธโฃ ุงููุธุงู ุงููุงูู ุงููุชูุฏู)

---

## 1๏ธโฃ ุงููููู ุงูุชูุธููู

### 1.1 ุฅุฏุงุฑุฉ ุงููุฌููุนุงุช (Businesses)

> **ูุฑุงุฑ:** ูุถุน ุงููุฌููุนุฉ ููุท - ูู ูุณุชุฃุฌุฑ ูุจุฏุฃ ููุฌููุนุฉ ูู ุงูููู ุงูุฃูู

#### ุงูุฌุฏูู: `businesses`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| name | VARCHAR(255) | ุงุณู ุงููุฌููุนุฉ/ุงูุดุฑูุฉ |
| logo | VARCHAR(500) | ุฑุงุจุท ุงูุดุนุงุฑ |
| address | TEXT | ุงูุนููุงู |
| phone | VARCHAR(20) | ุฑูู ุงููุงุชู |
| email | VARCHAR(255) | ุงูุจุฑูุฏ ุงูุฅููุชุฑููู |
| tax_number | VARCHAR(50) | ุงูุฑูู ุงูุถุฑูุจู |
| settings | JSON | ุฅุนุฏุงุฏุงุช ุงููุฌููุนุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |
| updated_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุชุญุฏูุซ |

#### ุงูุดุงุดุงุช:
- ุฅูุดุงุก ูุฌููุนุฉ ุฌุฏูุฏุฉ (ุนูุฏ ุงูุชุณุฌูู)
- ุฅุนุฏุงุฏุงุช ุงููุฌููุนุฉ
- ุงูููู ุงูุชุนุฑููู ูููุฌููุนุฉ

---

### 1.2 ุฅุฏุงุฑุฉ ุงููุญุทุงุช (Stations)

> **ูุฑุงุฑ:** ูุง ูุฑูุน - ุงููุญุทุงุช ูุจุงุดุฑุฉ ุชุญุช ุงููุฌููุนุฉ

#### ุฃููุงุน ุงููุญุทุงุช:

| ุงูููุน | ุงููุตู | ูุซุงู |
|-------|-------|------|
| `generation_distribution` | ุชูููุฏ + ุชูุฒูุน | ุงูุฏูููุฉุ ุงูุตุจุงููุฉุ ุฌูุงูุ ุบูููุ ุงููุฑูุฒูุฉ |
| `solar` | ุทุงูุฉ ุดูุณูุฉ | ูุฏุฑุณุฉ ุงูุตุจุงุญุ ูุฏุฑุณุฉ ุนูุฑุ ูุฏุฑุณุฉ ุฃุณุงูุฉุ ุฃุดุจุงู ุงููุฏุณุ ุงูุนูุงุฑุฉ ุงูุนุจุงุณู |

#### ุงูุฌุฏูู: `stations`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ (FK) |
| name | VARCHAR(255) | ุงุณู ุงููุญุทุฉ |
| type | ENUM | ููุน ุงููุญุทุฉ |
| location | VARCHAR(255) | ุงููููุน |
| latitude | DECIMAL | ุฎุท ุงูุนุฑุถ |
| longitude | DECIMAL | ุฎุท ุงูุทูู |
| has_generators | BOOLEAN | ูู ูุฏููุง ูููุฏุงุช |
| has_solar | BOOLEAN | ูู ูุฏููุง ุทุงูุฉ ุดูุณูุฉ |
| settings | JSON | ุฅุนุฏุงุฏุงุช ุงููุญุทุฉ |
| is_active | BOOLEAN | ูุดุทุฉ/ุบูุฑ ูุดุทุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

#### ุงูุดุงุดุงุช:
- ูุงุฆูุฉ ุงููุญุทุงุช
- ุฅุถุงูุฉ ูุญุทุฉ ุฌุฏูุฏุฉ
- ุชุนุฏูู ุจูุงูุงุช ุงููุญุทุฉ
- ููุญุฉ ุชุญูู ุงููุญุทุฉ
- ุฎุฑูุทุฉ ุงููุญุทุงุช

---

### 1.3 ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ

#### ุงูุฌุฏูู: `settings`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ (NULL = ุฅุนุฏุงุฏ ุนุงู) |
| station_id | UUID | ุงููุญุทุฉ (NULL = ุฅุนุฏุงุฏ ุงููุฌููุนุฉ) |
| key | VARCHAR(100) | ููุชุงุญ ุงูุฅุนุฏุงุฏ |
| value | JSON | ูููุฉ ุงูุฅุนุฏุงุฏ |
| category | VARCHAR(50) | ุชุตููู ุงูุฅุนุฏุงุฏ |

#### ุชุตูููุงุช ุงูุฅุนุฏุงุฏุงุช:
- `general` - ุฅุนุฏุงุฏุงุช ุนุงูุฉ
- `billing` - ุฅุนุฏุงุฏุงุช ุงูููุชุฑุฉ
- `accounting` - ุฅุนุฏุงุฏุงุช ุงููุญุงุณุจุฉ
- `notifications` - ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
- `integrations` - ุฅุนุฏุงุฏุงุช ุงูุชูุงููุงุช

---

## 2๏ธโฃ ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช

### 2.1 ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู

#### ุงูุฌุฏูู: `users`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| name | VARCHAR(255) | ุงูุงุณู ุงููุงูู |
| email | VARCHAR(255) | ุงูุจุฑูุฏ ุงูุฅููุชุฑููู |
| phone | VARCHAR(20) | ุฑูู ุงููุงุชู |
| password_hash | VARCHAR(255) | ูููุฉ ุงููุฑูุฑ (ูุดูุฑุฉ) |
| scope_type | ENUM | ูุทุงู ุงูุตูุงุญูุฉ (business/station) |
| scope_ids | JSON | ุงููุญุทุงุช ุงููุณููุญ ุจูุง |
| is_owner | BOOLEAN | ูู ูู ุงููุงูู |
| is_active | BOOLEAN | ูุดุท/ุบูุฑ ูุดุท |
| last_login | TIMESTAMP | ุขุฎุฑ ุชุณุฌูู ุฏุฎูู |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

#### ุฃููุงุน ุงููุทุงู (Scope):

| ุงููุทุงู | ุงููุตู |
|--------|-------|
| `business` | ูุฑู ูู ุงููุฌููุนุฉ (ุฌููุน ุงููุญุทุงุช) |
| `station` | ูุฑู ูุญุทุงุช ูุญุฏุฏุฉ ููุท |

---

### 2.2 ุฅุฏุงุฑุฉ ุงูุฃุฏูุงุฑ

#### ุงูุฌุฏูู: `roles`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ (NULL = ุฏูุฑ ุงูุชุฑุงุถู) |
| name | VARCHAR(100) | ุงุณู ุงูุฏูุฑ |
| description | TEXT | ูุตู ุงูุฏูุฑ |
| is_system | BOOLEAN | ุฏูุฑ ูุธุงู (ูุง ููุญุฐู) |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

#### ุงูุฃุฏูุงุฑ ุงูุงูุชุฑุงุถูุฉ:

| ุงูุฏูุฑ | ุงููุตู |
|-------|-------|
| `owner` | ุงููุงูู - ูู ุงูุตูุงุญูุงุช |
| `admin` | ูุฏูุฑ - ูุนุธู ุงูุตูุงุญูุงุช |
| `accountant` | ูุญุงุณุจ - ุงูุตูุงุญูุงุช ุงููุงููุฉ |
| `collector` | ูุญุตูู - ุงูุชุญุตูู ููุท |
| `reader` | ูุงุฑุฆ ุนุฏุงุฏุงุช - ุงููุฑุงุกุงุช ููุท |
| `viewer` | ูุดุงูุฏ - ุนุฑุถ ููุท |

---

### 2.3 ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช

#### ุงูุฌุฏูู: `permissions`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| module | VARCHAR(50) | ุงููุญุฏุฉ |
| action | VARCHAR(50) | ุงูุฅุฌุฑุงุก |
| name | VARCHAR(100) | ุงุณู ุงูุตูุงุญูุฉ |
| description | TEXT | ุงููุตู |

#### ุงูุฌุฏูู: `role_permissions`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| role_id | UUID | ุงูุฏูุฑ |
| permission_id | UUID | ุงูุตูุงุญูุฉ |

#### ุงูุฌุฏูู: `user_roles`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| user_id | UUID | ุงููุณุชุฎุฏู |
| role_id | UUID | ุงูุฏูุฑ |

#### ุฃูุซูุฉ ุนูู ุงูุตูุงุญูุงุช:

| ุงููุญุฏุฉ | ุงูุฅุฌุฑุงุกุงุช |
|--------|----------|
| `stations` | view, create, edit, delete |
| `subscribers` | view, create, edit, delete |
| `invoices` | view, create, edit, delete, void |
| `payments` | view, create, edit, delete, void |
| `accounts` | view, create, edit, delete |
| `journal_entries` | view, create, edit, delete, post |
| `reports` | view, export |
| `settings` | view, edit |

---

## 3๏ธโฃ ุงููุธุงู ุงููุงูู ุงูุฑุฆูุณู

### 3.1 ุดุฌุฑุฉ ุงูุญุณุงุจุงุช

> **ุงููุจุฏุฃ:** ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูู ุงูููุจ ุงูุฐู ุชุชุตู ุจู ุฌููุน ุงูุฃูุธูุฉ ุงููุฑุนูุฉ

#### ุงูุฌุฏูู: `accounts`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| parent_id | UUID | ุงูุญุณุงุจ ุงูุฃุจ (NULL = ุญุณุงุจ ุฑุฆูุณู) |
| code | VARCHAR(20) | ุฑูุฒ ุงูุญุณุงุจ |
| name | VARCHAR(255) | ุงุณู ุงูุญุณุงุจ |
| type | ENUM | ููุน ุงูุญุณุงุจ |
| nature | ENUM | ุทุจูุนุฉ ุงูุญุณุงุจ (debit/credit) |
| level | INT | ุงููุณุชูู ูู ุงูุดุฌุฑุฉ |
| is_parent | BOOLEAN | ูู ูู ุญุณุงุจ ุฃุจ |
| is_active | BOOLEAN | ูุดุท/ุบูุฑ ูุดุท |
| system_account | VARCHAR(50) | ุญุณุงุจ ูุธุงู (ููุฑุจุท ุงูุชููุงุฆู) |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

#### ุฃููุงุน ุงูุญุณุงุจุงุช:

| ุงูููุน | ุงููุตู |
|-------|-------|
| `asset` | ุฃุตูู |
| `liability` | ุฎุตูู |
| `equity` | ุญููู ุงูููููุฉ |
| `revenue` | ุฅูุฑุงุฏุงุช |
| `expense` | ูุตุฑููุงุช |

#### ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุงูุงูุชุฑุงุถูุฉ:

```
1 - ุงูุฃุตูู
โโโ 11 - ุงูุฃุตูู ุงููุชุฏุงููุฉ
โ   โโโ 111 - ุงูููุฏูุฉ ูุงูุจููู
โ   โ   โโโ 1111 - ุงูุตูุฏูู
โ   โ   โโโ 1112 - ุงูุจููู
โ   โโโ 112 - ุงูุนููุงุก โ 07_ูุธุงู_ุงูุนููุงุก_ูุงูููุชุฑุฉ.md
โ   โโโ 113 - ุงููุฎุฒูู โ 06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md
โ   โ   โโโ 1131 - ูุฎุฒูู ุนุฏุงุฏุงุช
โ   โ   โโโ 1132 - ูุฎุฒูู ููุงุทุน
โ   โ   โโโ 1133 - ูุฎุฒูู ุฃุฎุชุงู
โ   โ   โโโ 1134 - ูุฎุฒูู ุดุงุดุงุช STS
โ   โโโ 114 - ุงูุนูุฏ ูุงูุณูู โ 04_ูุธุงู_ุงูุนูููุงุช_ุงูููุฏุงููุฉ.md + 08_ูุธุงู_ุงูููุงุฑุฏ_ุงูุจุดุฑูุฉ.md
โ   โโโ 115 - ุชุฃูููุงุช ูุฏู ุงูุบูุฑ
โโโ 12 - ุงูุฃุตูู ุงูุซุงุจุชุฉ โ 03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md + 03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md
โ   โโโ 121 - ุงููููุฏุงุช
โ   โโโ 122 - ุงูุฃููุงุญ ุงูุดูุณูุฉ
โ   โโโ 123 - ุงูููุงุจู ูุงูุดุจูุงุช
โ   โโโ 129 - ูุฌูุน ุงูุฅููุงู

2 - ุงูุฎุตูู
โโโ 21 - ุงูุฎุตูู ุงููุชุฏุงููุฉ
โ   โโโ 211 - ุงูููุฑุฏูู โ 06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md
โ   โโโ 212 - ุชุฃูููุงุช ูู ุงูุนููุงุก โ 07_ูุธุงู_ุงูุนููุงุก_ูุงูููุชุฑุฉ.md
โ   โโโ 213 - ูุณุชุญูุงุช ุงูููุธููู โ 08_ูุธุงู_ุงูููุงุฑุฏ_ุงูุจุดุฑูุฉ.md
โ   โโโ 214 - ุฅูุฑุงุฏุงุช ูุคุฌูุฉ (ุงูุฏูุน ุงููุณุจู) โ 07_ูุธุงู_ุงูุนููุงุก_ูุงูููุชุฑุฉ.md
โโโ 22 - ุงูุฎุตูู ุทูููุฉ ุงูุฃุฌู

3 - ุญููู ุงูููููุฉ
โโโ 31 - ุฑุฃุณ ุงููุงู
โโโ 32 - ุญุณุงุจุงุช ุงูุดุฑูุงุก
โโโ 33 - ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ

4 - ุงูุฅูุฑุงุฏุงุช โ 07_ูุธุงู_ุงูุนููุงุก_ูุงูููุชุฑุฉ.md
โโโ 41 - ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก
โ   โโโ 411 - ุฅูุฑุงุฏุงุช ููุฑุจุงุก (ุนุฏุงุฏุงุช ุชูููุฏูุฉ)
โ   โโโ 412 - ุฅูุฑุงุฏุงุช ููุฑุจุงุก (ุฏูุน ูุณุจู STS/IoT)
โ   โโโ 413 - ุฅูุฑุงุฏุงุช ููุฑุจุงุก (ุฏุนู ุญูููู)
โโโ 42 - ุฅูุฑุงุฏุงุช ุงูุฎุฏูุงุช
โ   โโโ 421 - ุฅูุฑุงุฏุงุช ุงุดุชุฑุงูุงุช ุฌุฏูุฏุฉ
โ   โโโ 422 - ุฅูุฑุงุฏุงุช ุชุฑููุฉ ุงุดุชุฑุงูุงุช
โ   โโโ 423 - ุฅูุฑุงุฏุงุช ุจูุน ุนุฏุงุฏุงุช
โโโ 43 - ุฅูุฑุงุฏุงุช ุฃุฎุฑู

5 - ุงููุตุฑููุงุช
โโโ 51 - ูุตุฑููุงุช ุงูุชุดุบูู โ 04_ูุธุงู_ุงูุนูููุงุช_ุงูููุฏุงููุฉ.md + 03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md
โ   โโโ 511 - ุงููููุฏ
โ   โโโ 512 - ุงูุตูุงูุฉ
โ   โโโ 513 - ูุทุน ุงูุบูุงุฑ โ 06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md
โโโ 52 - ูุตุฑููุงุช ุฅุฏุงุฑูุฉ
โโโ 53 - ูุตุฑููุงุช ุงูุฑูุงุชุจ โ 08_ูุธุงู_ุงูููุงุฑุฏ_ุงูุจุดุฑูุฉ.md
โโโ 54 - ุงูุฅููุงู โ 03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md
โโโ 55 - ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (ุงูุนุฏุงุฏุงุช)
```

---

### 3.2 ุงููููุฏ ุงูููููุฉ

#### ุงูุฌุฏูู: `journal_entries`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| station_id | UUID | ุงููุญุทุฉ (ุงุฎุชูุงุฑู) |
| entry_number | VARCHAR(20) | ุฑูู ุงูููุฏ |
| entry_date | DATE | ุชุงุฑูุฎ ุงูููุฏ |
| description | TEXT | ุงูุจูุงู |
| reference_type | VARCHAR(50) | ููุน ุงููุฑุฌุน (invoice, payment, etc) |
| reference_id | UUID | ูุนุฑู ุงููุฑุฌุน |
| source_system | VARCHAR(50) | ุงููุธุงู ุงููุตุฏุฑ |
| total_debit | DECIMAL | ุฅุฌูุงูู ุงููุฏูู |
| total_credit | DECIMAL | ุฅุฌูุงูู ุงูุฏุงุฆู |
| status | ENUM | ุงูุญุงูุฉ (draft/posted/void) |
| posted_by | UUID | ุงููุณุชุฎุฏู ุงูุฐู ุฑุญูู |
| posted_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุชุฑุญูู |
| created_by | UUID | ุงููุณุชุฎุฏู ุงูููุดุฆ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

#### ุงูุฌุฏูู: `journal_entry_lines`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| journal_entry_id | UUID | ุงูููุฏ |
| account_id | UUID | ุงูุญุณุงุจ |
| debit | DECIMAL | ูุฏูู |
| credit | DECIMAL | ุฏุงุฆู |
| description | TEXT | ุงูุจูุงู |
| cost_center_id | UUID | ูุฑูุฒ ุงูุชูููุฉ (ุงุฎุชูุงุฑู) |

#### ูุตุงุฏุฑ ุงููููุฏ (source_system):

| ุงููุตุฏุฑ | ุงููุธุงู | ุงูููู |
|--------|-------|------|
| `manual` | ููุฏ ูุฏูู | - |
| `customers` | ูุธุงู ุงูุนููุงุก ูุงูููุชุฑุฉ | `07_ูุธุงู_ุงูุนููุงุก_ูุงูููุชุฑุฉ.md` |
| `inventory` | ูุธุงู ุงููุฎุฒูู ูุงููุดุชุฑูุงุช | `06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md` |
| `purchases` | ูุธุงู ุงููุฎุฒูู ูุงููุดุชุฑูุงุช | `06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md` |
| `assets` | ูุธุงู ุงูุฃุตูู ูุงูุตูุงูุฉ | `03_ูุธุงู_ุงูุฃุตูู_ูุงูุตูุงูุฉ.md` |
| `field_ops` | ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ | `04_ูุธุงู_ุงูุนูููุงุช_ุงูููุฏุงููุฉ.md` |
| `hr` | ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ | `08_ูุธุงู_ุงูููุงุฑุฏ_ุงูุจุดุฑูุฉ.md` |

---

### 3.3 ุงูุฏูุงุชุฑ ุงููุญุงุณุจูุฉ

#### ุงูุชูุงุฑูุฑ ุงูุฃุณุงุณูุฉ:

| ุงูุชูุฑูุฑ | ุงููุตู |
|---------|-------|
| ุฏูุชุฑ ุงูููููุฉ | ุฌููุน ุงููููุฏ ูุฑุชุจุฉ ุจุงูุชุงุฑูุฎ |
| ุฏูุชุฑ ุงูุฃุณุชุงุฐ | ุญุฑูุฉ ูู ุญุณุงุจ |
| ููุฒุงู ุงููุฑุงุฌุนุฉ | ุฃุฑุตุฏุฉ ุฌููุน ุงูุญุณุงุจุงุช |
| ูุงุฆูุฉ ุงูุฏุฎู | ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช |
| ุงูููุฒุงููุฉ ุงูุนููููุฉ | ุงููุฑูุฒ ุงููุงูู |

---

### 3.4 ูุฑุงูุฒ ุงูุชูููุฉ (ุงุฎุชูุงุฑู)

#### ุงูุฌุฏูู: `cost_centers`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| station_id | UUID | ุงููุญุทุฉ (ุงุฎุชูุงุฑู) |
| code | VARCHAR(20) | ุงูุฑูุฒ |
| name | VARCHAR(255) | ุงูุงุณู |
| type | ENUM | ุงูููุน |
| is_active | BOOLEAN | ูุดุท |

#### ุฃููุงุน ูุฑุงูุฒ ุงูุชูููุฉ:

| ุงูููุน | ุงููุตู |
|-------|-------|
| `station` | ูุญุทุฉ |
| `department` | ูุณู |
| `project` | ูุดุฑูุน |

---

## ๐ ููุญุงุช ุงูุชุญูู

### ููุญุฉ ุชุญูู ุงููุงูู:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ข ุดุฑูุฉ ุงูุทุงูุฉ ุงููุชุญุฏุฉ - ููุญุฉ ุงูุชุญูู                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ ๐ ูุธุฑุฉ ุนุงูุฉ:                                               โ
โ โโโ ุงููุญุทุงุช: 10                                             โ
โ โโโ ุงููุณุชุฎุฏููู: 25                                          โ
โ โโโ ุงูุฃูุธูุฉ ุงููุดุทุฉ: 8                                       โ
โ                                                             โ
โ ๐ฐ ุงูููุฎุต ุงููุงูู:                                           โ
โ โโโ ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช: 50,000,000 ุฑูุงู                       โ
โ โโโ ุฅุฌูุงูู ุงููุตุฑููุงุช: 35,000,000 ุฑูุงู                       โ
โ โโโ ุตุงูู ุงูุฑุจุญ: 15,000,000 ุฑูุงู                             โ
โ                                                             โ
โ ๐ ุงูุฃูุธูุฉ ุงููุฑุนูุฉ:                                         โ
โ โโโ ุงูุนููุงุก: 1,500 ูุดุชุฑู ูุดุท                                โ
โ โโโ ุงููุฎุฒูู: 500 ุตูู                                        โ
โ โโโ ุงูููุฑุฏูู: 50 ููุฑุฏ                                       โ
โ โโโ ุงูุฃุตูู: 200 ุฃุตู                                         โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โฑ๏ธ ุงูุฌุฏูู ุงูุฒููู

| ุงููููุฉ | ุงููุฏุฉ |
|--------|-------|
| ุงููููู ุงูุชูุธููู (ุงููุฌููุนุฉ + ุงููุญุทุงุช) | ุฃุณุจูุนุงู |
| ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช | ุฃุณุจูุน |
| ุดุฌุฑุฉ ุงูุญุณุงุจุงุช | ุฃุณุจูุน |
| ุงููููุฏ ูุงูุฏูุงุชุฑ ุงููุญุงุณุจูุฉ | ุฃุณุจูุนุงู |
| ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุฃุณุงุณูุฉ | ุฃุณุจูุน |
| ููุญุงุช ุงูุชุญูู | ุฃุณุจูุน |
| **ุงููุธุงู ุงููุงูู ุงููุชูุฏู (ูุฏูุฌ):** | |
| ุชุตููู ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงููุชูุฏูุฉ | ุฃุณุจูุน |
| ุจูุงุก ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงููุชูุฏูุฉ | ุฃุณุจูุน |
| ุชุตููู ูุญุฑู ุงูุชุณููุฉ | ุฃุณุจูุน |
| ุจูุงุก ุฌุฏุงูู ุงูุชุณููุฉ | ุฃุณุจูุน |
| ุจูุงุก API ุงูุชุณููุฉ | ุฃุณุจูุนุงู |
| ุจูุงุก ูุงุฌูุฉ ุงูุชุณููุฉ | ุฃุณุจูุน |
| **ุงูุฅุฌูุงูู** | **15 ุฃุณุจูุน** |

---

## ๐ ููุงุญุธุงุช

1. **ุงููุธุงู ุงูุฃู ูุฌุจ ุฃู ููุชูู ุฃููุงู** ูุจู ุจูุงุก ุฃู ูุธุงู ูุฑุนู
2. **ุดุฌุฑุฉ ุงูุญุณุงุจุงุช** ูู ููุทุฉ ุงูุฑุจุท ูุฌููุน ุงูุฃูุธูุฉ ุงููุฑุนูุฉ
3. **ูู ูุธุงู ูุฑุนู** ูููุดุฆ ูููุฏู ุชููุงุฆูุงู ูู ุงููุธุงู ุงููุงูู
4. **ุงูุตูุงุญูุงุช** ุชูุทุจู ุนูู ูุณุชูู ุงููุธุงู ุงูุฃู ูุชูุชูู ููุฃูุธูุฉ ุงููุฑุนูุฉ


---

## 4๏ธโฃ ุงููุธุงู ุงููุงูู ุงููุชูุฏู

> **ููุงุญุธุฉ:** ุชู ุฏูุฌ ูุฐุง ุงููุณู ูู ููู ุงููุธุงู ุงููุงูู (10) ููููู ุฌุฒุกุงู ูู ุงููุธุงู ุงูุฃู

### 4.1 ุงูุชูุงุฑูุฑ ุงููุงููุฉ (Financial Reports)

#### 4.1.1 ูุงุฆูุฉ ุงูุฏุฎู (Income Statement)

**ุงูุฃูุณุงู:**
- ุงูุฅูุฑุงุฏุงุช (Revenue)
- ุชูุงููู ุงูุจุถุงุฆุน ุงููุจุงุนุฉ (Cost of Goods Sold)
- ุงูุฑุจุญ ุงูุฅุฌูุงูู (Gross Profit)
- ุงููุตุฑููุงุช ุงูุชุดุบูููุฉ (Operating Expenses)
- ุงูุฑุจุญ ุงูุชุดุบููู (Operating Profit)
- ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ุงูุฃุฎุฑู (Other Income & Expenses)
- ุงูุฑุจุญ ูุจู ุงูุถุฑูุจุฉ (Profit Before Tax)
- ุงูุถุฑูุจุฉ (Tax)
- ุงูุฑุจุญ ุงูุตุงูู (Net Profit)

**ุงููุชุฑุงุช:**
- ุดูุฑู
- ุฑุจุน ุณููู
- ุณููู
- ูุฎุตุต

#### 4.1.2 ุงูููุฒุงููุฉ ุงูุนููููุฉ (Balance Sheet)

**ุงูุฃูุณุงู:**
- ุงูุฃุตูู ุงููุชุฏุงููุฉ (Current Assets)
- ุงูุฃุตูู ุงูุซุงุจุชุฉ (Fixed Assets)
- ุฅุฌูุงูู ุงูุฃุตูู (Total Assets)
- ุงูุฎุตูู ุงููุชุฏุงููุฉ (Current Liabilities)
- ุงูุฎุตูู ุทูููุฉ ุงูุฃุฌู (Long-term Liabilities)
- ุฅุฌูุงูู ุงูุฎุตูู (Total Liabilities)
- ุญููู ุงูููููุฉ (Equity)
- ุฅุฌูุงูู ุงูุฎุตูู ูุญููู ุงูููููุฉ (Total Liabilities & Equity)

#### 4.1.3 ุงูุชุฏููุงุช ุงูููุฏูุฉ (Cash Flow Statement)

**ุงูุฃูุณุงู:**
- ุงูุชุฏููุงุช ูู ุงูุฃูุดุทุฉ ุงูุชุดุบูููุฉ (Operating Activities)
- ุงูุชุฏููุงุช ูู ุฃูุดุทุฉ ุงูุงุณุชุซูุงุฑ (Investing Activities)
- ุงูุชุฏููุงุช ูู ุฃูุดุทุฉ ุงูุชูููู (Financing Activities)
- ุตุงูู ุงูุชุบูุฑ ูู ุงูููุฏ (Net Change in Cash)
- ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู (Opening Balance)
- ุงูุฑุตูุฏ ุงูุฎุชุงูู (Closing Balance)

#### 4.1.4 ุงูุชูุงุฑูุฑ ุงููุฎุตุตุฉ

**ุงูููุฒุงุช:**
- ุงุฎุชูุงุฑ ุงูุญุณุงุจุงุช ุงููุทููุจุฉ
- ุงุฎุชูุงุฑ ุงููุชุฑุฉ ุงูุฒูููุฉ
- ุงุฎุชูุงุฑ ุงูุชูุณูู (ุฌุฏููุ ุฑุณู ุจูุงูู)
- ุชุตุฏูุฑ ุงูุชูุฑูุฑ (PDF, Excel, CSV)

---

### 4.2 ุงูุญุณุงุจุงุช ุงููุณูุทุฉ (Clearing Accounts)

#### 4.2.1 ุฃููุงุน ุงูุญุณุงุจุงุช ุงููุณูุทุฉ

| ุงูููุน | ุงููุตู | ุงูุงุณุชุฎุฏุงู |
|-------|-------|-----------|
| ุญุณุงุจ ุงูุจูู ุงููุณูุท | ุชุฌููุน ุงููุฏููุนุงุช ูุจู ุงูุชุณููุฉ | ุจูุงุจุงุช ุงูุฏูุนุ ุงูุชุญูููุงุช |
| ุญุณุงุจ ุงูุฅูุฑุงุฏุงุช ุงููุณูุท | ุชุฌููุน ุงูุฅูุฑุงุฏุงุช ูุจู ุงูุชูุฒูุน | ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุกุ ุงูุฎุฏูุงุช |
| ุญุณุงุจ ุงููุตุฑููุงุช ุงููุณูุท | ุชุฌููุน ุงููุตุฑููุงุช ูุจู ุงูุชูุฒูุน | ูุดุชุฑูุงุชุ ุฑูุงุชุจ |
| ุญุณุงุจ ุงูุฐูู ุงููุณูุท | ุชุฌููุน ุงูุฐูู ูุจู ุงูุชุณููุฉ | ุนููุงุกุ ููุฑุฏูู |

#### 4.2.2 ุฏูุฑุฉ ุงูุญุณุงุจ ุงููุณูุท

```
1. ุงุณุชูุงู ุงูุญุฑูุฉ
   โ
2. ุชุณุฌูู ูู ุงูุญุณุงุจ ุงููุณูุท
   โ
3. ุงููุทุงุจูุฉ ูุน ุงูุญุฑูุงุช ุงูููุงุจูุฉ
   โ
4. ุงูุชูุฒูุน ุนูู ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ
   โ
5. ุฅุบูุงู ุงูุญุณุงุจ ุงููุณูุท
```

#### 4.2.3 ุฌุฏุงูู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ

```sql
-- ุงูุญุณุงุจุงุช ุงููุณูุทุฉ
clearing_accounts (
    id, code, name, type, account_id,
    balance, is_active, created_at
)

-- ูููุฏ ุงูุญุณุงุจุงุช ุงููุณูุทุฉ
clearing_entries (
    id, clearing_account_id, entry_date, amount,
    reference_type, reference_id, status, created_at
)
```

---

### 4.3 ูุญุฑู ุงูุชุณููุฉ (Reconciliation Engine)

#### 4.3.1 ุฃููุงุน ุงูุชุณููุฉ

| ุงูููุน | ุงููุตู | ุงููุตุฏุฑ | ุงููุฏู |
|-------|-------|--------|-------|
| ุชุณููุฉ ุงูุจูู | ูุทุงุจูุฉ ูุดู ุงูุจูู ูุน ุงูุณุฌูุงุช | ูุดู ุงูุจูู | ุญุณุงุจ ุงูุจูู |
| ุชุณููุฉ ุงูุฅูุฑุงุฏุงุช | ูุทุงุจูุฉ ุงูุฅูุฑุงุฏุงุช ูุน ุงูููุงุชูุฑ | ุจูุงุจุงุช ุงูุฏูุน | ููุงุชูุฑ ุงูุนููุงุก |
| ุชุณููุฉ ุงููุตุฑููุงุช | ูุทุงุจูุฉ ุงููุตุฑููุงุช ูุน ุงููุณุชูุฏุงุช | ูุดู ุงูุจูู | ููุงุชูุฑ ุงูููุฑุฏูู |
| ุชุณููุฉ ุงูุฐูู | ูุทุงุจูุฉ ุงูุฐูู ูุน ุงููุฏููุนุงุช | ุงููุฏููุนุงุช | ุฃุฑุตุฏุฉ ุงูุนููุงุก |

#### 4.3.2 ุฃููุงุน ุนูุงูุงุช ุงูุชุณููุฉ

| ุงูุนูุงูุฉ | ุงููุตู | ูุซุงู |
|---------|-------|------|
| 1:1 | ูุงุญุฏ ุฅูู ูุงุญุฏ | ูุงุชูุฑุฉ ูุงุญุฏุฉ โ ุฏูุนุฉ ูุงุญุฏุฉ |
| 1:N | ูุงุญุฏ ุฅูู ูุชุนุฏุฏ | ูุงุชูุฑุฉ ูุงุญุฏุฉ โ ุนุฏุฉ ุฏูุนุงุช |
| N:1 | ูุชุนุฏุฏ ุฅูู ูุงุญุฏ | ุนุฏุฉ ููุงุชูุฑ โ ุฏูุนุฉ ูุงุญุฏุฉ |
| N:M | ูุชุนุฏุฏ ุฅูู ูุชุนุฏุฏ | ุนุฏุฉ ููุงุชูุฑ โ ุนุฏุฉ ุฏูุนุงุช |

#### 4.3.3 ุฎุทูุงุช ุงูุชุณููุฉ

```
1. ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช
   โโโ ูุดู ุงูุจูู
   โโโ ุจูุงูุงุช ุจูุงุจุงุช ุงูุฏูุน
   โโโ ุงูุจูุงูุงุช ุงูุฏุงุฎููุฉ
   โ
2. ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ
   โโโ ูุทุงุจูุฉ ุจุงููุฑุฌุน
   โโโ ูุทุงุจูุฉ ุจุงููุจูุบ
   โโโ ูุทุงุจูุฉ ุจุงูุชุงุฑูุฎ
   โ
3. ุงููุทุงุจูุฉ ุงููุฏููุฉ
   โโโ ุงูุนูุงุตุฑ ุบูุฑ ุงููุชุทุงุจูุฉ
   โโโ ุงูุงุณุชุซูุงุกุงุช
   โ
4. ุงูุชูุฒูุน
   โโโ ุชูุฒูุน ุนูู ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ
   โโโ ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ
   โ
5. ุงูุฅุบูุงู
   โโโ ุชุฃููุฏ ุงูุชุณููุฉ
   โโโ ุฅูุดุงุก ุงูุชูุฑูุฑ
```

#### 4.3.4 ููุงุนุฏ ุงูุชุณููุฉ ุงูุชููุงุฆูุฉ

```python
# ูุซุงู: ููุงุนุฏ ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ
reconciliation_rules = [
    {
        "name": "ูุทุงุจูุฉ ุจุงููุฑุฌุน",
        "priority": 1,
        "match_fields": ["reference_number"],
        "tolerance": 0
    },
    {
        "name": "ูุทุงุจูุฉ ุจุงููุจูุบ ูุงูุชุงุฑูุฎ",
        "priority": 2,
        "match_fields": ["amount", "date"],
        "tolerance": {"amount": 0.01, "date_days": 3}
    },
    {
        "name": "ูุทุงุจูุฉ ุจุงูุนููู ูุงููุจูุบ",
        "priority": 3,
        "match_fields": ["customer_id", "amount"],
        "tolerance": {"amount": 0.01}
    }
]
```

#### 4.3.5 ุฌุฏุงูู ุงูุชุณููุฉ

```sql
-- ููุงุนุฏ ุงูุชุณููุฉ
reconciliation_rules (
    id, name, priority, match_fields, tolerance,
    is_active, created_at
)

-- ุงูุชุณููุงุช
reconciliations (
    id, type, period_start, period_end,
    status, created_by, created_at, finalized_at
)

-- ูุทุงุจูุงุช ุงูุชุณููุฉ
reconciliation_matches (
    id, reconciliation_id, source_entry_id, target_entry_id,
    match_type, match_rule_id, created_at
)

-- ุชูุฒูุนุงุช ุงูุชุณููุฉ
reconciliation_allocations (
    id, reconciliation_id, clearing_entry_id, 
    target_account_id, amount, created_at
)

-- ุณุฌู ุงูุชุณููุฉ
reconciliation_history (
    id, reconciliation_id, action, details,
    created_by, created_at
)

-- ุงุณุชุซูุงุกุงุช ุงูุชุณููุฉ
reconciliation_exceptions (
    id, reconciliation_id, entry_id, exception_type,
    notes, resolved, resolved_by, resolved_at
)
```

---

### 4.4 ุงูุชุญููู ุงููุงูู

#### 4.4.1 ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุงูู (KPIs)

| ุงููุคุดุฑ | ุงููุตู | ุงูุตูุบุฉ |
|--------|-------|--------|
| ูุงูุด ุงูุฑุจุญ ุงูุฅุฌูุงูู | ูุณุจุฉ ุงูุฑุจุญ ุงูุฅุฌูุงูู | (ุงูุฅูุฑุงุฏุงุช - ุงูุชูุงููู) / ุงูุฅูุฑุงุฏุงุช ร 100 |
| ูุงูุด ุงูุฑุจุญ ุงูุตุงูู | ูุณุจุฉ ุงูุฑุจุญ ุงูุตุงูู | ุงูุฑุจุญ ุงูุตุงูู / ุงูุฅูุฑุงุฏุงุช ร 100 |
| ูุณุจุฉ ุงูุชุญุตูู | ููุงุกุฉ ุงูุชุญุตูู | ุงููุญุตูู / ุงููุณุชุญู ร 100 |
| ูุนุฏู ุฏูุฑุงู ุงูุฐูู | ุณุฑุนุฉ ุงูุชุญุตูู | ุงูุฅูุฑุงุฏุงุช / ูุชูุณุท ุงูุฐูู |

#### 4.4.2 ุงูุชุญููู ุงูููุงุฑู

- ููุงุฑูุฉ ุงููุชุฑุงุช (ุดูุฑูุ ุฑุจุน ุณูููุ ุณููู)
- ููุงุฑูุฉ ุงููุญุทุงุช
- ููุงุฑูุฉ ุงูููุฒุงููุฉ ูุน ุงููุนูู
- ุชุญููู ุงูุงูุญุฑุงูุงุช

#### 4.4.3 ุงูุชูุจุคุงุช ุงููุงููุฉ

- ุชููุนุงุช ุงูุฅูุฑุงุฏุงุช
- ุชููุนุงุช ุงูุชุฏููุงุช ุงูููุฏูุฉ
- ุชุญููู ุงูุงุชุฌุงูุงุช

---

### 4.5 ุดุงุดุฉ ุณุฌู ูููุฏ ุงูููููุฉ (Journal Entries Log)

#### 4.5.1 ุงูุบุฑุถ

ุนุฑุถ ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูุชู ุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ูู ุนูููุงุช ุงูุณุฏุงุฏ ูุงูุชุณููุงุช ูุงูููุชุฑุฉ.

#### 4.5.2 ููููุงุช ุงูุดุงุดุฉ

| ุงููุณู | ุงูุนูุงุตุฑ |
|-------|----------|
| **ุงูููุงุชุฑ** | ุงูุชุงุฑูุฎ (ูู - ุฅูู)ุ ููุน ุงูููุฏุ ุงููุตุฏุฑุ ุงูุญุงูุฉ |
| **ุฌุฏูู ุงููููุฏ** | ุฑูู ุงูููุฏุ ุงูุชุงุฑูุฎุ ุงููุตูุ ุงููุฏููุ ุงูุฏุงุฆูุ ุงููุจูุบุ ุงููุตุฏุฑ |
| **ุชูุงุตูู ุงูููุฏ** | ุนูุฏ ุงูููุฑ: ุงููุฑุฌุน (ุฑูู ุงููุงุชูุฑุฉ/ุงูุฅูุฏุงุน)ุ ุงูุนูููุ ุงูููุช |
| **ุงูุฅุฌูุงููุงุช** | ุฅุฌูุงูู ุงููุฏููุ ุฅุฌูุงูู ุงูุฏุงุฆูุ ุงููุฑู |
| **ุงูุชุตุฏูุฑ** | Excelุ PDFุ CSV |

#### 4.5.3 ุฃููุงุน ุงููููุฏ ุงูุชููุงุฆูุฉ

| ุงูููุน | ุงููุตุฏุฑ | ุงููุตู |
|------|--------|------|
| `payment_received` | ูุธุงู ุงูุนููุงุก | ููุฏ ุงุณุชูุงู ุฏูุนุฉ ูู ุนููู |
| `invoice_issued` | ูุธุงู ุงูููุชุฑุฉ | ููุฏ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ (ุฅูุฑุงุฏ ูุณุชุญู) |
| `bank_deposit_matched` | ุงูุชูุงูู ุงูุจููู | ููุฏ ูุทุงุจูุฉ ุฅูุฏุงุน ุจููู |
| `sts_recharge` | ูุธุงู STS | ููุฏ ุดุญู ุฑุตูุฏ ูุณุจู ุงูุฏูุน |
| `reconciliation` | ูุญุฑู ุงูุชุณููุฉ | ููุฏ ุชุณููุฉ ุญุณุงุจ ูุณูุท |
| `salary_payment` | ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ | ููุฏ ุตุฑู ุฑุงุชุจ |
| `purchase_order` | ุงููุดุชุฑูุงุช | ููุฏ ุฃูุฑ ุดุฑุงุก |
| `depreciation` | ุงูุฃุตูู | ููุฏ ุฅููุงู ุดูุฑู |

#### 4.5.4 ุงููููุฏ ุงูุชููุงุฆูุฉ ูู ุงูุชุณููุฉ

| ุงูุนูููุฉ | ุงููุฏูู | ุงูุฏุงุฆู |
|---------|--------|--------|
| ุชุณููุฉ ุฅูุฑุงุฏุงุช | ุญุณุงุจ ุงูุจูู | ุญุณุงุจ ุงูุฅูุฑุงุฏุงุช ุงููุณูุท |
| ุชุณููุฉ ูุตุฑููุงุช | ุญุณุงุจ ุงููุตุฑููุงุช | ุญุณุงุจ ุงูุจูู ุงููุณูุท |
| ุชุณููุฉ ุฐูู ุนููุงุก | ุญุณุงุจ ุงูุจูู | ุญุณุงุจ ุงูุนููุงุก |
| ุชุณููุฉ ุฐูู ููุฑุฏูู | ุญุณุงุจ ุงูููุฑุฏูู | ุญุณุงุจ ุงูุจูู |

---

### 4.6 ุฌุฏุงูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ

```sql
-- ุฅุนุฏุงุฏุงุช ุงูุชูุงุฑูุฑ
report_templates (
    id, name, type, config, created_at
)

-- ุงูุชูุงุฑูุฑ ุงููููุดุฃุฉ
generated_reports (
    id, template_id, period_start, period_end, 
    data, created_by, created_at
)

-- ุฌุฏููุฉ ุงูุชูุงุฑูุฑ
report_schedules (
    id, template_id, frequency, recipients, 
    next_run, is_active
)
```

---

### 4.7 ุดุงุดุงุช ุงููุธุงู ุงููุงูู ุงููุชูุฏู

| ุงูุดุงุดุฉ | ุงููุตู |
|--------|-------|
| ููุญุฉ ุงูุชุญูู ุงููุงููุฉ | ููุฎุต ุงูุฃุฏุงุก ุงููุงููุ ูุคุดุฑุงุช ุฑุฆูุณูุฉุ ุฑุณูู ุจูุงููุฉ |
| ุงูุชูุงุฑูุฑ ุงููุงููุฉ | ูุงุฆูุฉ ุงูุชูุงุฑูุฑุ ุฅูุดุงุก ุชูุฑูุฑ ุฌุฏูุฏุ ุฌุฏููุฉ ุงูุชูุงุฑูุฑุ ุชุตุฏูุฑ |
| ุงูุญุณุงุจุงุช ุงููุณูุทุฉ | ูุงุฆูุฉ ุงูุญุณุงุจุงุช ุงููุณูุทุฉุ ุชูุงุตูู ุงูุญุณุงุจุ ุงูุญุฑูุงุช ุบูุฑ ุงููุณูุงุฉ |
| ูุฑูุฒ ุงูุชุณููุฉ | ูุงุฆูุฉ ุงูุชุณููุงุชุ ููุญุฉ ุงูุชุณููุฉุ ุณูุฉ ุงูุชุณููุฉุ ุณุฌู ุงูุชุณููุฉ |
| ุงููุทุงุจูุฉ | ุงูุนูุงุตุฑ ุบูุฑ ุงููุชุทุงุจูุฉุ ุฃุฏูุงุช ุงููุทุงุจูุฉุ ุชุฃููุฏ ุงููุทุงุจูุฉ |
| ุงูุชูุฒูุน | ุชูุฒูุน ุงูุญุฑูุงุชุ ูุนุงููุฉ ุงูุชูุฒูุนุ ุชุฃููุฏ ุงูุชูุฒูุน |
| ุงูุงุณุชุซูุงุกุงุช | ูุงุฆูุฉ ุงูุงุณุชุซูุงุกุงุชุ ูุนุงูุฌุฉ ุงูุงุณุชุซูุงุกุงุชุ ุชูุฑูุฑ ุงูุงุณุชุซูุงุกุงุช |
| ุงูุชุญููู ุงููุงูู | ูุคุดุฑุงุช ุงูุฃุฏุงุกุ ุงูุชุญููู ุงูููุงุฑูุ ุงูุชูุจุคุงุช |

---

### 4.8 ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ ูู ุงูุชุณููุฉ

| ุงูุญุณุงุจ | ุงูุฑูุฒ | ุงูุงุณุชุฎุฏุงู |
|--------|-------|-----------|
| ุญุณุงุจ ุงูุจูู ุงููุณูุท | 1115 | ุชุฌููุน ุงููุฏููุนุงุช |
| ุญุณุงุจ ุงูุฅูุฑุงุฏุงุช ุงููุณูุท | 4100 | ุชุฌููุน ุงูุฅูุฑุงุฏุงุช |
| ุญุณุงุจ ุงููุตุฑููุงุช ุงููุณูุท | 5100 | ุชุฌููุน ุงููุตุฑููุงุช |
| ูุฑููุงุช ุงูุชุณููุฉ | 5900 | ุงููุฑููุงุช ุงูุตุบูุฑุฉ |

---

### 4.9 APIs ุงููุธุงู ุงููุงูู

| API | ุงููุตู |
|-----|-------|
| `/api/finance/reports/*` | ุงูุชูุงุฑูุฑ ุงููุงููุฉ |
| `/api/finance/clearing/*` | ุงูุญุณุงุจุงุช ุงููุณูุทุฉ |
| `/api/finance/reconciliation/*` | ุงูุชุณููุงุช |
| `/api/finance/analysis/*` | ุงูุชุญููู ุงููุงูู |
| `/api/v1/journal-entries` | ูุงุฆูุฉ ุงููููุฏ (ูุน ููุงุชุฑ) |
| `/api/v1/journal-entries/:id` | ุชูุงุตูู ููุฏ |
| `/api/v1/journal-entries/:id/lines` | ุณุทูุฑ ุงูููุฏ |
| `/api/v1/journal-entries/export` | ุชุตุฏูุฑ (Excel/PDF/CSV) |
| `/api/v1/journal-entries/summary` | ุฅุฌูุงููุงุช ุงููุชุฑุฉ |

---

### 4.10 ููุงุญุธุงุช ูููุฉ ูููุธุงู ุงููุงูู

1. **ุงูุชูุงุฑูุฑ ุงููุงููุฉ** ูุฌุจ ุฃู ุชููู ุฏูููุฉ 100%
2. **ูุญุฑู ุงูุชุณููุฉ** ูุฌุจ ุฃู ูุฏุนู ุฌููุน ุฃููุงุน ุงูุนูุงูุงุช
3. **ุงูุญุณุงุจุงุช ุงููุณูุทุฉ** ูุฌุจ ุฃู ุชูุตูุฑ ูู ููุงูุฉ ูู ูุชุฑุฉ
4. **ุณุฌู ุงูุชุฏููู** ูุฌุจ ุฃู ูุญุชูุธ ุจูู ุงูุชุบููุฑุงุช
5. **ุงูุฃุฏุงุก** ูุฌุจ ุฃู ูููู ุณุฑูุนุงู ุญุชู ูุน ูููุงุช ุจูุงูุงุช ูุจูุฑุฉ


---

## 5๏ธโฃ ูุฑูุฒ ุงูุชุณููุฉ ุงููุฑู (Flexible Reconciliation Center)

> **ุงููุตุฏุฑ:** ุชุญุฏูุซ 34-35 ูู ููู PHASE_1_DETAILED - ูุญุฑู ุงูุชุณููุฉ ุนุจุฑ ุงูุญุณุงุจุงุช ุงููุณูุทุฉ

### 5.1 ุงููุจุฏุฃ ุงูุฃุณุงุณู

**ูุง ูุชู ุงูุชุฑุญูู ูุจุงุดุฑุฉ ุฅูู ุญุณุงุจ ุฏุงุฆู. ูู ุงูุนูููุงุช ุชูุฑ ุฃููุงู ุนุจุฑ ุญุณุงุจ ูุณูุท ููุงุจู.**

```
ุงูุนูููุฉ ุงูููููุฉ โ ุงูุญุณุงุจ ุงููุณูุท โ ุงููุฑุงุฌุนุฉ ูุงููุทุงุจูุฉ โ ุงูุญุณุงุจ ุงูุฏุงุฆู
```

---

### 5.2 ุฌุฏูู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ ุงูููุตู

| ุงูููุงู | ุงูุญุณุงุจ ุงูุฏุงุฆู | ุงูุญุณุงุจ ุงููุณูุท |
|-------|-------------|------------|
| ุตูุฏูู ุงูุชุญุตูู | ุญ/ ุงูุตูุฏูู ุงูุฑุฆูุณู | ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู |
| ุจูู ุงูุญูุดุจู | ุญ/ ุจูู ุงูุญูุดุจู | ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู |
| ูุธุงู ุงูููุชุฑุฉ ุงูุนุงุฏู | ุญ/ ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ | ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ |
| ูุธุงู ุงูุฏูุน ุงููุณุจู | ุญ/ ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู | ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู |
| ูุธุงู ุตูุฏูู ุงูุฏุนู | ุญ/ ุฅูุฑุงุฏุงุช ุตูุฏูู ุงูุฏุนู | ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุตูุฏูู ุงูุฏุนู |
| ุงูููุฑุฏูู | ุญ/ ุงูููุฑุฏูู | ุญ/ ูุณูุท ุงูููุฑุฏูู |

---

### 5.3 ูุงุฌูุงุช ุงูุฅุฏุฎุงู ุงููููู

#### 5.3.1 ูุณุคูู ุตูุฏูู ุงูุชุญุตูู

**ุนูุฏ ุงุณุชูุงู ูุจูุบ ูู ูุชุญุตู:**
```
ูุณุชูู ูุจูุบ 100,000 ูู ูุชุญุตู ูุธุงู ุงูููุชุฑุฉ
    โ
ุงูููุฏ ูู ุงูุญุณุงุจ ุงููุณูุท:
โโ ูุฏูู: 100,000 ุฅูู ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู
โโ ุฏุงุฆู: 100,000 ุฅูู ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ
```

**ุนูุฏ ุชูุฑูุฏ ุงูููุฏ ููุจูู:**
```
ูููู ุจุชูุฑูุฏ 500,000 ููุฏูุง ุฅูู ุจูู ุงูุญูุดุจู
    โ
ุงูููุฏ ูู ุงูุญุณุงุจ ุงููุณูุท:
โโ ูุฏูู: 500,000 ุฅูู ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู
โโ ุฏุงุฆู: 500,000 ูู ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู
```

#### 5.3.2 ุงููุญุงุณุจ - ุจุนุฏ ูุฑุงุฌุนุฉ ูุดู ุงูุญุณุงุจ

```
ูุฑู ุฅูุฏุงุนูุง ุจูููุฉ 500,000 ูู ูุดู ุงูุญุณุงุจ ุงููุนูู
    โ
ุงูููุฏ ูู ุงูุญุณุงุจ ุงูุฏุงุฆู:
โโ ูุฏูู: 500,000 ุฅูู ุญ/ ุจูู ุงูุญูุดุจู (ุงูุญุณุงุจ ุงูุฏุงุฆู)
โโ ุฏุงุฆู: 500,000 ูู ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู
```

---

### 5.4 ุงููุงุฌูุฉ ูุชุนุฏุฏุฉ ุงูุฃููุงุญ (Multi-Panel Interface)

**ุงููุตู:** ุดุงุดุฉ ุชุนุฑุถ ุนุฏุฉ ุญุณุงุจุงุช ูุณูุทุฉ ุฌูุจุงู ุฅูู ุฌูุจ

**ูุซุงู ุนูู ุงูุฃููุงุญ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงูููุญ 1: ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู โ ุงูููุญ 2: ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โก 100,000 - ููุชุฑุฉ 15/12        โ โก 300,000 - ุฅูุฏุงุน 15/12              โ
โ โก 50,000 - ุฏูุน ูุณุจู 15/12      โ โก 200,000 - ุฅูุฏุงุน 15/12              โ
โ โ 150,000 - ุชูุฑูุฏ 15/12 (ุฏุงุฆู) โ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงูููุญ 3: ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ โ ุงูููุญ 4: ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจูโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โก 100,000 - ููุงุชูุฑ 15/12       โ โก 50,000 - ุดุญู 15/12                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 5.5 ุณูุฉ ุงูุชุณููุฉ (Reconciliation Basket)

**ุงููุตู:** ูุณู ูู ุฃุณูู ุงูุดุงุดุฉ ูุญุชูู ุนูู ุนููุฏูู

| ุนููุฏ ุงููุฏูู | ุนููุฏ ุงูุฏุงุฆู |
|-------------|-------------|
| ูุฌููุน ุงูุญุฑูุงุช ุงููุฏููุฉ ุงููุญุฏุฏุฉ | ูุฌููุน ุงูุญุฑูุงุช ุงูุฏุงุฆูุฉ ุงููุญุฏุฏุฉ |

**ุงูุดุฑุท ุงููุญูุฏ ููุชุณููุฉ:** ุฅุฌูุงูู ุงููุฏูู = ุฅุฌูุงูู ุงูุฏุงุฆู

---

### 5.6 ุณููุงุฑูููุงุช ุงูุชุณููุฉ ุงููุนูุฏุฉ

#### ุงูุณููุงุฑูู 1: ุชุณููุฉ 1:N (ูุงุญุฏ ุฅูู ูุชุนุฏุฏ)

**ุงูุญุงูุฉ:**
```
ูุณุคูู ุงูุตูุฏูู ูุงู ุจุชูุฑูุฏ ูุจูุบ ุฅุฌูุงูู ูุงุญุฏ 150,000 ุฅูู ุงูุจูู
ูุฐุง ุงููุจูุบ ูู ูุฌููุน ุฅูุฑุงุฏุงุช ูุธุงููู:
โโ 100,000 ูู ุงูููุชุฑุฉ
โโ 50,000 ูู ุงูุฏูุน ุงููุณุจู
```

**ุงูุญุฑูุงุช:**
- ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู: ุญุฑูุฉ ุฏุงุฆูุฉ 150,000
- ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู: ุญุฑูุฉ ูุฏููุฉ 100,000 (ูู ุงูููุชุฑุฉ)
- ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู: ุญุฑูุฉ ูุฏููุฉ 50,000 (ูู ุงูุฏูุน ุงููุณุจู)

**ุฅุฌุฑุงุก ุงููุฑุงุฌุน:**
1. ูุญุฏุฏ ุงูุญุฑูุชูู ุงููุฏููุชูู (100,000 ู 50,000) ูุงูุญุฑูุฉ ุงูุฏุงุฆูุฉ (150,000)
2. ูุถุบุท ุนูู ุฒุฑ "ุฃุถู ุฅูู ุงูุณูุฉ"
3. ุชุธูุฑ ูู "ุณูุฉ ุงูุชุณููุฉ":
   - ุนููุฏ ุงููุฏูู: 100,000 + 50,000 = **150,000**
   - ุนููุฏ ุงูุฏุงุฆู: **150,000**
4. ุจูุง ุฃู ุฅุฌูุงูู ุงููุฏูู = ุฅุฌูุงูู ุงูุฏุงุฆูุ ูุถูุก ุฒุฑ "ุชุณููุฉ"
5. ุนูุฏ ุงูุถุบุทุ ูุชู ุฑุจุท ุงูุญุฑูุงุช ุงูุซูุงุซ ูุนุงู ุจูุนุฑู ุชุณููุฉ ูุงุญุฏ

#### ุงูุณููุงุฑูู 2: ุชุณููุฉ N:1 (ูุชุนุฏุฏ ุฅูู ูุงุญุฏ)

**ุงูุญุงูุฉ:**
```
ูุณุคูู ุงูุตูุฏูู ูุงู ุจุชูุฑูุฏ ูุจูุบ ูุงุญุฏ 500,000 ููุจูู
ููู ุงูุจูู ูุงู ุจุชุฌุฒุฆุฉ ุงูุฅูุฏุงุน ูู ูุดู ุงูุญุณุงุจ ุฅูู ุญุฑูุชูู:
โโ 300,000
โโ 200,000
```

**ุงูุญุฑูุงุช:**
- ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู: ุญุฑูุฉ ุฏุงุฆูุฉ 500,000
- ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู: ุญุฑูุฉ ูุฏููุฉ 300,000
- ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู: ุญุฑูุฉ ูุฏููุฉ 200,000

#### ุงูุณููุงุฑูู 3: ุชุณููุฉ N:M (ูุชุนุฏุฏ ุฅูู ูุชุนุฏุฏ)

**ุงูุญุงูุฉ:**
```
ุนุฏุฉ ุนูููุงุช ุชูุฑูุฏ ูู ุงูุตูุฏูู (ุฅุฌูุงูู 800,000)
ุชุทุงุจู ุนุฏุฉ ุนูููุงุช ุฅูุฏุงุน ูู ุงูุจูู (ุฅุฌูุงูู 800,000)
```

**ุงูุญุฑูุงุช:**
- ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู: ุญุฑูุงุช ุฏุงุฆูุฉ (300,000 + 500,000)
- ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู: ุญุฑูุงุช ูุฏููุฉ (200,000 + 150,000 + 450,000)

---

### 5.7 ุชุทุจูู ุงูุชุณููุฉ ุนูู ุฃููุงุน ูุฎุชููุฉ

**ูุชุณููุฉ ุงูุฅูุฑุงุฏุงุช:**
```
ุชุชู ูุทุงุจูุฉ ุงูุญุฑูุงุช ุงูุฏุงุฆูุฉ ูู ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ
ูุน
ุงูุญุฑูุงุช ุงููุฏููุฉ ูู ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู
```

**ูุชุณููุฉ ุงููุตุฑููุงุช:**
```
ุชุชู ูุทุงุจูุฉ ุญุฑูุฉ ุฏุงุฆูุฉ ูู ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู (ุฏูุนุฉ ูููุฑุฏ)
ูุน
ุญุฑูุฉ ูุฏููุฉ ูู ุญ/ ูุณูุท ุงูููุฑุฏูู
```

---

## 6๏ธโฃ ุฅุฏุงุฑุฉ ุตูุฏูู ุงูุชุญุตูู ูุงูุชุญุตูู ุงููุฏูู

### 6.1 ุดุงุดุฉ ุฅุฏุงุฑุฉ ุตูุฏูู ุงูุชุญุตูู

#### 6.1.1 ููููุงุช ุงูุดุงุดุฉ

| ุงููุณู | ุงูุนูุงุตุฑ |
|-------|----------|
| **ุงูุฑุตูุฏ ุงูุญุงูู** | ุฑุตูุฏ ุงูุตูุฏููุ ุขุฎุฑ ุชุญุฏูุซ |
| **ุงูุญุฑูุงุช ุงูููููุฉ** | ูุงุฆูุฉ ุงูุงุณุชูุงูุงุช ูุงูุชูุฑูุฏุงุช |
| **ุงููุชุญุตููู** | ูุงุฆูุฉ ุงููุชุญุตููู ููุจุงูุบูู |
| **ุงูุชูุฑูุฏุงุช** | ุณุฌู ุงูุชูุฑูุฏุงุช ููุจูู |

#### 6.1.2 ุณูุฑ ุนูู ุงูุชุญุตูู ุงููุฏูู

```
1. ุงููุชุญุตู ูุฌูุน ุงููุจุงูุบ ูู ุงูุนููุงุก
   โ
2. ุงููุชุญุตู ูุณูู ุงููุจูุบ ููุณุคูู ุงูุตูุฏูู
   โ
3. ูุณุคูู ุงูุตูุฏูู ูุณุฌู ุงูุงุณุชูุงู ูู ุงููุธุงู
   โโ ุงุณู ุงููุชุญุตู
   โโ ุงููุจูุบ ุงููุณุชูู
   โโ ููุน ุงูุฅูุฑุงุฏ (ููุชุฑุฉ/ุฏูุน ูุณุจู/ุฏุนู)
   โโ ูุงุฆูุฉ ุงูููุงุชูุฑ ุงููุณุฏุฏุฉ
   โ
4. ุงููุธุงู ููุดุฆ ููุฏ ุชููุงุฆู ูู ุงูุญุณุงุจ ุงููุณูุท
   โ
5. ููุงูุฉ ุงูููู: ูุณุคูู ุงูุตูุฏูู ูููุฑุฏ ููุจูู
   โ
6. ุงููุธุงู ููุดุฆ ููุฏ ุชูุฑูุฏ ูู ุงูุญุณุงุจ ุงููุณูุท
```

#### 6.1.3 ุงููููุฏ ุงููุญุงุณุจูุฉ ููุชุญุตูู ุงููุฏูู

**ุนูุฏ ุงุณุชูุงู ูุจูุบ ูู ูุชุญุตู:**
```
ูุฏูู: ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู ......... X ุฑูุงู
  ุฏุงุฆู: ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ ....... X ุฑูุงู
```

**ุนูุฏ ุชูุฑูุฏ ุงููุจูุบ ููุจูู:**
```
ูุฏูู: ุญ/ ูุณูุท ุจูู [ุงุณู ุงูุจูู] ......... X ุฑูุงู
  ุฏุงุฆู: ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู ......... X ุฑูุงู
```

**ุนูุฏ ุชุฃููุฏ ุงูุฅูุฏุงุน ูู ูุดู ุงูุจูู:**
```
ูุฏูู: ุญ/ ุจูู [ุงุณู ุงูุจูู] (ุฏุงุฆู) ......... X ุฑูุงู
  ุฏุงุฆู: ุญ/ ูุณูุท ุจูู [ุงุณู ุงูุจูู] ......... X ุฑูุงู
```

---

### 6.2 ุฌุฏูู ุงููุชุญุตููู

```sql
-- ุงููุชุญุตููู
collectors (
    id UUID PRIMARY KEY,
    business_id UUID NOT NULL,
    user_id UUID REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    assigned_area VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
)

-- ุชุณูููุงุช ุงููุชุญุตููู
collector_submissions (
    id UUID PRIMARY KEY,
    collector_id UUID REFERENCES collectors(id),
    cashier_id UUID REFERENCES users(id),
    submission_date DATE NOT NULL,
    total_amount DECIMAL(15,2) NOT NULL,
    revenue_type VARCHAR(50), -- billing, prepaid, subsidy
    notes TEXT,
    journal_entry_id UUID REFERENCES journal_entries(id),
    created_at TIMESTAMP DEFAULT NOW()
)

-- ุชูุงุตูู ุงูุชุณููู (ุงูููุงุชูุฑ ุงููุณุฏุฏุฉ)
collector_submission_details (
    id UUID PRIMARY KEY,
    submission_id UUID REFERENCES collector_submissions(id),
    invoice_id UUID,
    customer_id UUID,
    amount DECIMAL(15,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
)
```

---

### 6.3 ุฌุฏูู ุชูุฑูุฏุงุช ุงูุตูุฏูู

```sql
-- ุชูุฑูุฏุงุช ุงูุตูุฏูู ููุจูู
cash_deposits (
    id UUID PRIMARY KEY,
    business_id UUID NOT NULL,
    deposit_date DATE NOT NULL,
    bank_account_id UUID NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    deposit_slip_number VARCHAR(50),
    deposited_by UUID REFERENCES users(id),
    confirmed BOOLEAN DEFAULT false,
    confirmed_by UUID REFERENCES users(id),
    confirmed_at TIMESTAMP,
    journal_entry_id UUID REFERENCES journal_entries(id),
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
)
```

---

## 7๏ธโฃ ุฃุฏุงุฉ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ

### 7.1 ุงููุฏู

ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงููุชุฑุงููุฉ ูู ุงูุณููุงุช ุงูุณุงุจูุฉ ุฅูู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ ููุจุฏุก ูู ุชูุธูููุง ูุชุณููุชูุง.

### 7.2 ุฎุทูุงุช ุงูุงุณุชูุฑุงุฏ

```
1. ุฅุนุฏุงุฏ ููู Excel ุจุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ
   โโ ุญุฑูุงุช ุงูุตูุงุฏูู
   โโ ุญุฑูุงุช ุงูุจููู
   โโ ุฅุฌูุงููุงุช ุงูุฅูุฑุงุฏุงุช
   โ
2. ุฑูุน ุงูููู ุฅูู ุงููุธุงู
   โ
3. ุงููุธุงู ูุณุชูุฑุฏ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ุฅูู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ
   โ
4. ุงูุจูุงูุงุช ุชุตุจุญ ุฌุงูุฒุฉ ููุชุณููุฉ ูุงููุทุงุจูุฉ ูู ุงูููู ุงูุฃูู
```

### 7.3 ุชูุณูู ููู ุงูุงุณุชูุฑุงุฏ

| ุงูุญูู | ุงููุตู | ูุซุงู |
|-------|-------|------|
| ุงูุชุงุฑูุฎ | ุชุงุฑูุฎ ุงูุญุฑูุฉ | 2024-01-15 |
| ููุน ุงูุญุณุงุจ | ุงูุญุณุงุจ ุงููุณูุท | ูุณูุท ุตูุฏูู ุงูุชุญุตูู |
| ุงููุฏูู | ุงููุจูุบ ุงููุฏูู | 100,000 |
| ุงูุฏุงุฆู | ุงููุจูุบ ุงูุฏุงุฆู | 0 |
| ุงููุฑุฌุน | ุฑูู ูุฑุฌุนู | DEP-2024-001 |
| ุงููุตู | ูุตู ุงูุญุฑูุฉ | ุฅูุฏุงุน ููุฏู |

### 7.4 ุฌุฏูู ุงูุจูุงูุงุช ุงููุณุชูุฑุฏุฉ

```sql
-- ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ ุงููุณุชูุฑุฏุฉ
imported_historical_data (
    id UUID PRIMARY KEY,
    business_id UUID NOT NULL,
    import_batch_id UUID NOT NULL,
    import_date TIMESTAMP DEFAULT NOW(),
    original_date DATE NOT NULL,
    clearing_account_id UUID NOT NULL,
    debit_amount DECIMAL(15,2) DEFAULT 0,
    credit_amount DECIMAL(15,2) DEFAULT 0,
    reference VARCHAR(100),
    description TEXT,
    is_reconciled BOOLEAN DEFAULT false,
    reconciliation_id UUID,
    created_at TIMESTAMP DEFAULT NOW()
)
```

---

## 8๏ธโฃ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุงูููุตูุฉ (40+ ุญุณุงุจ)

> **ุงููุตุฏุฑ:** ุชุญุฏูุซ 2 ูู ููู PHASE_1_DETAILED - ุดุฌุฑุฉ ุงูุญุณุงุจุงุช ุงูููุตูุฉ

### 8.1 ุงูุฃุตูู (Assets) - 1000-1300

```
1000 - ุงูููุฏูุฉ ูุงูุจููู
  1001 - ุงูููุฏูุฉ ุจุงูุตูุฏูู
  1002 - ุญุณุงุจ ุงูุจูู A
  1003 - ุญุณุงุจ ุงูุจูู B
  1004 - ุญุณุงุจุงุช ุฃุฎุฑู

1100 - ุงูุนููุงุก (ุงูุฐูู ุงููุฏููุฉ)
  1101 - ุงูุนููุงุก (ุนุฏุงุฏุงุช ุชูููุฏูุฉ)
  1102 - ุงูุนููุงุก (ุนุฏุงุฏุงุช STS)
  1103 - ุงูุนููุงุก (ุตูุฏูู ุงูุฏุนู)

1200 - ุงููุฎุฒูู
  1201 - ุนุฏุงุฏุงุช ุฌุฏูุฏุฉ
  1202 - ุดุงุดุงุช STS ุฌุฏูุฏุฉ
  1203 - ุฃุฎุชุงู ุฌุฏูุฏุฉ
  1204 - ููุงุทุน ุฌุฏูุฏุฉ
  1205 - ุฃุณูุงู ูููุงุฏ

1300 - ุงูุชุฃูููุงุช ูุงููุฏุงุฆุน
  1301 - ุชุฃูููุงุช ูุฏู ุงูููุฑุฏูู
  1302 - ูุฏุงุฆุน ุจูููุฉ
```

### 8.2 ุงูุฎุตูู (Liabilities) - 2000-2300

```
2000 - ุงูููุฑุฏูู (ุงูุฐูู ุงูุฏุงุฆูุฉ)
  2001 - ููุฑุฏูู ูุญูููู
  2002 - ููุฑุฏูู ุฎุงุฑุฌููู

2100 - ุชุฃูููุงุช ูู ุงูุนููุงุก
  2101 - ุชุฃูููุงุช ุนุฏุงุฏุงุช ุชูููุฏูุฉ
  2102 - ุชุฃูููุงุช ุนุฏุงุฏุงุช STS

2200 - ุงูุฅูุฑุงุฏุงุช ุงููุคุฌูุฉ
  2201 - ุฅูุฑุงุฏุงุช ูุคุฌูุฉ (ุฏูุน ูุณุจู)
  2202 - ุฅูุฑุงุฏุงุช ูุคุฌูุฉ (ุฏุนู ุญูููู)

2300 - ุญุณุงุจุงุช ูุณูุทุฉ (Clearing Accounts)
  2301 - ูุณูุท ุตูุฏูู ุงูุชุญุตูู
  2302 - ูุณูุท ุจูู A
  2303 - ูุณูุท ุจูู B
  2304 - ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ
  2305 - ูุณูุท ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู
  2306 - ูุณูุท ุตูุฏูู ุงูุฏุนู
```

### 8.3 ุงูุฅูุฑุงุฏุงุช (Revenues) - 4000-4200

```
4000 - ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก
  4001 - ุฅูุฑุงุฏุงุช ููุฑุจุงุก (ุนุฏุงุฏุงุช ุชูููุฏูุฉ)
  4002 - ุฅูุฑุงุฏุงุช ููุฑุจุงุก (ุฏูุน ูุณุจู)
  4003 - ุฅูุฑุงุฏุงุช ููุฑุจุงุก (ุฏุนู ุญูููู)

4100 - ุฅูุฑุงุฏุงุช ุงูุงุดุชุฑุงูุงุช
  4101 - ุฑุณูู ุงูุงุดุชุฑุงู (ุนุฏุงุฏุงุช ุชูููุฏูุฉ)
  4102 - ุฑุณูู ุงูุงุดุชุฑุงู (ุนุฏุงุฏุงุช STS)

4200 - ุฅูุฑุงุฏุงุช ุฃุฎุฑู
  4201 - ุฅูุฑุงุฏุงุช ุจูุน ุนุฏุงุฏุงุช
  4202 - ุฅูุฑุงุฏุงุช ุฑุณูู ุชุฑููุฉ
  4203 - ุฅูุฑุงุฏุงุช ุฑุณูู ุงุณุชุจุฏุงู
```

### 8.4 ุงููุตุฑููุงุช (Expenses) - 5000-5200

```
5000 - ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ
  5001 - ุชูููุฉ ุงูุนุฏุงุฏุงุช ุงููุจุงุนุฉ
  5002 - ุชูููุฉ ุงูููููุงุช ุงููุณุชุฎุฏูุฉ

5100 - ูุตุฑููุงุช ุงูุตูุงูุฉ ูุงูุชุดุบูู
  5101 - ูุตุฑููุงุช ุตูุงูุฉ ุงูุนุฏุงุฏุงุช
  5102 - ูุตุฑููุงุช ุงุณุชุจุฏุงู ุงูููููุงุช

5200 - ูุตุฑููุงุช ุฃุฎุฑู
  5201 - ูุตุฑููุงุช ุฅุฏุงุฑูุฉ
  5202 - ูุตุฑููุงุช ุชุณููู
```

---

## 9๏ธโฃ ุขููุฉ ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุฌููุฉ

### 9.1 ุงููููุฏ ุงููุฑุฏูุฉ (ููุนูููุงุช ุงููููุฉ)

#### ุฃ) ุฏูุน ุฑุณูู ุงูุงุดุชุฑุงู ุงูุฌุฏูุฏ (ุนุฏุงุฏ ุนุงุฏู)
```
ูุฏูู: 1002 - ุญุณุงุจ ุงูุจูู A (ุฃู ุงูููุฏูุฉ) ........... X ุฑูุงู
  ุฏุงุฆู: 4101 - ุฑุณูู ุงูุงุดุชุฑุงู ..................... Y ุฑูุงู
  ุฏุงุฆู: 2101 - ุชุฃูููุงุช ูู ุงูุนููุงุก ............... Z ุฑูุงู
```

#### ุจ) ุฅุตุฏุงุฑ ูุงุชูุฑุฉ ููุฑุจุงุก
```
ูุฏูู: 1101 - ุงูุนููุงุก (ุนุฏุงุฏุงุช ุชูููุฏูุฉ) .......... X ุฑูุงู
  ุฏุงุฆู: 4001 - ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก (ุชูููุฏูุฉ) ........ X ุฑูุงู
```

#### ุฌ) ุชุฑููุฉ ุนุฏุงุฏ ูู ุชูููุฏู ุฅูู STS
```
ุงูููุฏ ุงูุฃูู - ุฅูุบุงุก ุงูุชุฃููู:
ูุฏูู: 2101 - ุชุฃูููุงุช ูู ุงูุนููุงุก ............... X ุฑูุงู
  ุฏุงุฆู: 1102 - ุงูุนููุงุก (ุนุฏุงุฏุงุช STS) ........... X ุฑูุงู

ุงูููุฏ ุงูุซุงูู - ุชุณุฌูู ุฑุณูู ุงูุชุฑููุฉ:
ูุฏูู: 1002 - ุญุณุงุจ ุงูุจูู ...................... A ุฑูุงู
ูุฏูู: 1102 - ุงูุนููุงุก (ุนุฏุงุฏุงุช STS) ........... B ุฑูุงู
  ุฏุงุฆู: 4102 - ุฑุณูู ุงูุงุดุชุฑุงู (STS) ........... (A+B) ุฑูุงู
```

#### ุฏ) ุงุณุชูุงู ุฏูุนุฉ ูู ุตูุฏูู ุงูุฏุนู ุงูุญูููู
```
ูุฏูู: ุญุณุงุจ ุงูุจูู (ุฒูุงุฏุฉ ูู ุงูุฃุตูู)
  ุฏุงุฆู: ุญุณุงุจ ุงูุนููุงุก (ุฃู ุญุณุงุจ ูุณูุท ูุตูุฏูู ุงูุฏุนู)
```

### 9.2 ุงููููุฏ ุงููุฌูุนุฉ (ููุนูููุงุช ุงููุชูุฑุฑุฉ)

#### ุฃ) ุฏูุฑุฉ ุงูููุชุฑุฉ (ูู 10 ุฃูุงู)
```
ุงูุฎุทูุฉ 1: ุญุณุงุจ ุงูุฅุฌูุงูู
- ูุธุงู ุงูููุชุฑุฉ ูุฌูุน ูู ุงูููุงุชูุฑ ุงููููุดุฃุฉ ูู ูุฐู ุงูุฏูุฑุฉ
- ุงูุฅุฌูุงูู = ูุฌููุน ูู ุงูููุงุชูุฑ

ุงูุฎุทูุฉ 2: ุฅูุดุงุก ููุฏ ูุฌูุน ูุงุญุฏ
ูุฏูู: 1101 - ุงูุนููุงุก (ุนุฏุงุฏุงุช ุชูููุฏูุฉ) ......... TOTAL ุฑูุงู
  ุฏุงุฆู: 4001 - ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก (ุชูููุฏูุฉ) ...... TOTAL ุฑูุงู

ููุงุญุธุฉ: ุงูุชูุงุตูู (ูู ูุงุชูุฑุฉ ูููุตูุฉ) ุชุจูู ูู ูุธุงู ุงูููุชุฑุฉ
```

#### ุจ) ุนูููุงุช ุงูุฏูุน ุงููุณุจู (STS ู IoT) - ุขููุฉ ุงูุชุณููุฉ ุงูููููุฉ

**ุงูุฎุทูุฉ 1: ุงูุชุณุฌูู ุงูููุฑู ูู ุงูุณุฌู ุงููุฑุนู**
- ูู ุนูููุฉ ุดุญู ุชูุณุฌู ููุฑุงู ูู ุฌุฏูู `prepaid_transactions`
- ุงูุฌุฏูู ูุญุชูู ุนูู: ุงูููุชุ ุงููุจูุบุ ุทุฑููุฉ ุงูุฏูุนุ ุฑูู ุงูุนุฏุงุฏ

**ุงูุฎุทูุฉ 2: ูููุฉ ุงูุชุณููุฉ ุงูููููุฉ (ุชุนูู ุงูุณุงุนุฉ 11:55 ูุณุงุกู)**
- ุชุฌููุน ูู ูุนุงููุงุช ุงูููู ูู ุงูุณุฌู ุงููุฑุนู
- ุชุตููููุง ุญุณุจ ุทุฑููุฉ ุงูุฏูุน:
  * ุงููุจุงูุบ ุงููุฏููุนุฉ ุนุจุฑ ุจูู A
  * ุงููุจุงูุบ ุงููุฏููุนุฉ ุนุจุฑ ุจูู B
  * ุงููุจุงูุบ ุงููุฏููุนุฉ ููุฏุงู

**ุงูุฎุทูุฉ 3: ุฅูุดุงุก ููุฏ ููููุฉ ุฅุฌูุงูู ูุงุญุฏ**
```
ูุฏูู: 1002 - ุญุณุงุจ ุงูุจูู A ................... X ุฑูุงู
ูุฏูู: 1003 - ุญุณุงุจ ุงูุจูู B ................... Y ุฑูุงู
ูุฏูู: 1001 - ุงูููุฏูุฉ ........................ Z ุฑูุงู
  ุฏุงุฆู: 4002 - ุฅูุฑุงุฏุงุช ุงูููุฑุจุงุก (ุฏูุน ูุณุจู) ..... (X+Y+Z) ุฑูุงู
```

---

### 9.3 ููุงุฆุฏ ุงููุธุงู ุงููุฌูู

| ุงููุงุฆุฏุฉ | ุงููุตู |
|--------|-------|
| **ูุธุงู ูุญุงุณุจู ูุธูู** | ุจุฏูุงู ูู 3000 ููุฏ ุดุญู ููููุ ููุฏ ูุงุญุฏ ููุท |
| **ูุตู ุงูุงูุชูุงูุงุช** | ุงูููุชุฑุฉ ุชูุชู ุจุงูุชูุงุตููุ ุงููุญุงุณุจุฉ ุจุงูุตูุฑุฉ ุงููููุฉ |
| **ุฃุฏุงุก ุฃูุถู** | ุชูููู ุงููุชุงุจุงุช ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญุงุณุจูุฉ |
| **ุณูููุฉ ุงููุฑุงุฌุนุฉ** | ุงููุญุงุณุจ ูุฑุงุฌุน ูููุฏ ููููุฉ ููุงุถุญุฉ |
| **ุชูุงุฑูุฑ ููุซููุฉ** | ูุงุฆูุฉ ุงูุฏุฎู ูุงูููุฒุงููุฉ ุชุนูุณ ุงููุถุน ุงููุนูู |
| **ูุญุงุณุจุฉ ุฏูููุฉ** | ูู ุนูููุฉ ููุง ุฃุซุฑ ูุญุงุณุจู ูุณุฌู ุจุดูู ุตุญูุญ |
| **ูุง ุฅุฏุฎุงู ูุฒุฏูุฌ** | ุฏูุฑ ุงููุญุงุณุจ ูู "ูุฏุฎู ุจูุงูุงุช" ุฅูู "ูุญูู ูุงูู" |


---

## 10. ูุธุงู ุงูุฎุฑุงุฆุท ูุงูุชูุฃู ุงูุฑููู

> **ููุงุญุธุฉ:** ุชู ููู ูุธุงู ุงูุฎุฑุงุฆุท ูุงูุชูุฃู ุงูุฑููู ููุดุจูุฉ ุฅูู:
> 
> **๐ `05_ูุธุงู_ุงููุฑุงูุจุฉ_ูุงูุชุญูู.md`** - ุงููุณู 8 ู 9
> 
> ูุดูู:
> - ูุธุงู ุงูุฎุฑุงุฆุท ุงููุฑูุฒู (GIS)
> - ุงูุชูุฃู ุงูุฑููู ููุดุจูุฉ ุงูููุฑุจุงุฆูุฉ (Digital Twin)
> - ุนูุฏ ูููุงุทุน ุงูุดุจูุฉ
> - ุฃุฏุงุฉ ุฑุณู ูุชูุซูู ุงูุดุจูุฉ
> - ุชุญููู ุงูุฎูุงุถ ุงูุฌูุฏ ูุงูุฃุญูุงู
> - ุฃุตูู ุงูุดุจูุฉ ุงููุฌูุนุฉ

---

## 11. ูุชุงููุฌ ุงูุฎุฏูุงุช ูุงูุชุณุนูุฑ (Service Catalog & Pricing)

> **ุงูุบุฑุถ:** ูุธุงู ูุฑูุฒู ูุชุนุฑูู ูุชุณุนูุฑ ุฌููุน ุงูุฎุฏูุงุช ุงูุชู ููุฏููุง ุงููููููุ ููุณุชุฎุฏู ูู ุญุณุงุจ ุชูููุฉ ุฃูุงูุฑ ุงูุนูู ูุงูููุชุฑุฉ.

### 11.1 ุฌุฏูู ูุชุงููุฌ ุงูุฎุฏูุงุช (service_catalog)

```sql
CREATE TABLE service_catalog (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id),
    
    service_code VARCHAR(30) UNIQUE NOT NULL,
    service_name VARCHAR(100) NOT NULL,
    service_name_en VARCHAR(100),
    description TEXT,
    
    category VARCHAR(50) NOT NULL,  -- 'installation', 'maintenance', 'migration', 'survey', 'other'
    
    default_cost DECIMAL(12, 2) NOT NULL,
    cost_type VARCHAR(20) DEFAULT 'fixed',  -- 'fixed', 'per_unit', 'per_hour', 'per_meter'
    unit_of_measure VARCHAR(20),
    
    technician_fee DECIMAL(12, 2) DEFAULT 0,
    fee_type VARCHAR(20) DEFAULT 'fixed',
    fee_percentage DECIMAL(5, 2),
    
    is_active BOOLEAN DEFAULT true,
    is_billable_to_customer BOOLEAN DEFAULT true,
    
    revenue_account_id UUID REFERENCES accounts(id),
    expense_account_id UUID REFERENCES accounts(id),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 11.2 ุงูุจูุงูุงุช ุงูุฃูููุฉ ููุชุงููุฌ ุงูุฎุฏูุงุช

| ุฑูุฒ ุงูุฎุฏูุฉ | ุงููุตู | ุงูุชูููุฉ | ุฃุฌุฑ ุงูููู |
|------------|-------|---------|-----------|
| INSTALL-METER | ุชุฑููุจ ุนุฏุงุฏ ุฌุฏูุฏ (ุดุงูู ูู ุงููุฏูู) | 5,000 | 2,000 |
| INSTALL-DP | ุชุฑููุจ ุทุจููู ุชุฌููุน ููุจุฑ ุฌุฏูุฏ | 15,000 | 5,000 |
| INSTALL-WIRE | ุชูุฏูุฏ ุฃุณูุงู ุชูุตูู (ููู ูุชุฑ) | 100 | 30 |
| REPLACE-CIU | ุงุณุชุจุฏุงู ุดุงุดุฉ ุนุฑุถ STS | 1,000 | 500 |
| REPLACE-METER | ุงุณุชุจุฏุงู ุนุฏุงุฏ ุชุงูู | 3,000 | 1,500 |
| SURVEY-SITE | ุฅุฌุฑุงุก ูุณุญ ููููุน ูุดุชุฑู ุฌุฏูุฏ | 500 | 300 |
| MIGRATE-CUST | ุชุฑุญูู ูุดุชุฑู ููุดุจูุฉ ุงูุฐููุฉ | 8,000 | 3,000 |
| DISCONNECT | ูุตู ุฎุฏูุฉ ูุดุชุฑู | 1,000 | 500 |
| RECONNECT | ุฅุนุงุฏุฉ ุชูุตูู ุฎุฏูุฉ ูุดุชุฑู | 1,500 | 700 |

### 11.3 ุฌุฏูู ุชุณุนูุฑ ุงูุฎุฏูุงุช ุญุณุจ ุงููุญุทุฉ (station_service_pricing)

```sql
CREATE TABLE station_service_pricing (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID REFERENCES stations(id),
    service_id UUID REFERENCES service_catalog(id),
    
    custom_cost DECIMAL(12, 2),
    custom_technician_fee DECIMAL(12, 2),
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(station_id, service_id)
);
```

### 11.4 ุดุงุดุฉ ุฅุฏุงุฑุฉ ูุชุงููุฌ ุงูุฎุฏูุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ูุชุงููุฌ ุงูุฎุฏูุงุช ูุงูุชุณุนูุฑ                          [+ ุฎุฏูุฉ ุฌุฏูุฏุฉ] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุงูุชุตููู: [ุงููู โผ]  ุงูุญุงูุฉ: [ูุดุท โผ]                                 โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโ โ
โ  โ ุงูุฑูุฒ      โ ุงูุฎุฏูุฉ              โ ุงูุชูููุฉ  โ ุฃุฌุฑ ุงููููโ ุงูุญุงูุฉโ โ
โ  โโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโค โ
โ  โINSTALL-METERโ ุชุฑููุจ ุนุฏุงุฏ ุฌุฏูุฏ    โ 5,000    โ 2,000    โ ๐ข    โ โ
โ  โINSTALL-DP  โ ุชุฑููุจ ุทุจููู        โ 15,000   โ 5,000    โ ๐ข    โ โ
โ  โSURVEY-SITE โ ูุณุญ ูููุน           โ 500      โ 300      โ ๐ข    โ โ
โ  โโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 11.5 APIs ูุชุงููุฌ ุงูุฎุฏูุงุช

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/services` | ูุงุฆูุฉ ุงูุฎุฏูุงุช |
| GET | `/api/v1/services/:id` | ุชูุงุตูู ุฎุฏูุฉ |
| POST | `/api/v1/services` | ุฅุถุงูุฉ ุฎุฏูุฉ ุฌุฏูุฏุฉ |
| PUT | `/api/v1/services/:id` | ุชุนุฏูู ุฎุฏูุฉ |
| GET | `/api/v1/services/by-category/:category` | ุฎุฏูุงุช ุญุณุจ ุงูุชุตููู |
| GET | `/api/v1/services/pricing/:station_id` | ุชุณุนูุฑ ูุญุทุฉ ูุนููุฉ |



---

# 12. ูุธุงู ุฃูุงูุฑ ุงูุฏูุน ุงููุฑูุฒู (Central Payment Orders)

> **ุงูุบุฑุถ:** ุฅุฏุงุฑุฉ ุฌููุน ุฃูุงูุฑ ุงูุฏูุน ุงูุตุงุฏุฑุฉ ูู ูุฎุชูู ุงูุฃูุธูุฉ (ุญุฒู ุงูุนููุ ููุงุชูุฑ ุงูููุฑุฏููุ ุงูุฑูุงุชุจ) ูู ููุงู ูุฑูุฒู

## 12.1 ุฌุฏูู ุฃูุงูุฑ ุงูุฏูุน (payment_orders)

```sql
CREATE TABLE payment_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID REFERENCES stations(id),
    
    -- ุฑูู ุฃูุฑ ุงูุฏูุน
    payment_order_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ูุตุฏุฑ ุฃูุฑ ุงูุฏูุน
    source_system VARCHAR(30) NOT NULL,
    -- 'field_operations' (ุญุฒู ุงูุนูู)
    -- 'inventory' (ููุงุชูุฑ ุงูููุฑุฏูู)
    -- 'hr' (ุงูุฑูุงุชุจ ูุงูุญูุงูุฒ)
    -- 'customers' (ุงุณุชุฑุฏุงุฏ ุชุฃูููุงุช)
    -- 'manual' (ูุฏูู)
    
    source_type VARCHAR(30) NOT NULL,
    -- 'work_package', 'supplier_invoice', 'salary', 'incentive', 'deposit_refund', 'other'
    
    source_id UUID,  -- ูุนุฑู ุงูุณุฌู ุงููุตุฏุฑ
    source_reference VARCHAR(50),  -- ุฑูู ูุฑุฌุนู ููุนุฑุถ
    
    -- ุงููุณุชููุฏ
    beneficiary_type VARCHAR(20) NOT NULL,
    -- 'employee', 'team', 'contractor', 'supplier', 'customer'
    
    beneficiary_id UUID,
    beneficiary_name VARCHAR(100) NOT NULL,
    beneficiary_account VARCHAR(50),  -- ุฑูู ุงูุญุณุงุจ ุงูุจููู (ุฅู ูุฌุฏ)
    
    -- ุงููุจูุบ
    amount DECIMAL(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'YER',
    
    -- ุงููุตู
    description TEXT,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending',
    -- 'pending': ุจุงูุชุธุงุฑ ุงูุงุนุชูุงุฏ
    -- 'approved': ูุนุชูุฏ ูุฌุงูุฒ ููุตุฑู
    -- 'paid': ุชู ุงูุตุฑู
    -- 'cancelled': ููุบู
    
    -- ุงูููุงููุงุช
    created_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    -- ุงูุตุฑู
    paid_by UUID REFERENCES users(id),
    paid_at TIMESTAMP,
    payment_method VARCHAR(20),  -- 'cash', 'bank_transfer', 'check'
    payment_reference VARCHAR(100),  -- ุฑูู ุงูุญูุงูุฉ ุฃู ุงูุดูู
    
    -- ุงูููุฏ ุงููุญุงุณุจู
    journal_entry_id UUID REFERENCES journal_entries(id),
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ููุฑุณ ููุจุญุซ ุงูุณุฑูุน
CREATE INDEX idx_payment_orders_status ON payment_orders(status);
CREATE INDEX idx_payment_orders_source ON payment_orders(source_system, source_type);
CREATE INDEX idx_payment_orders_beneficiary ON payment_orders(beneficiary_type, beneficiary_id);
```

## 12.2 ุดุงุดุฉ ุฅุฏุงุฑุฉ ุฃูุงูุฑ ุงูุฏูุน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฐ ุฃูุงูุฑ ุงูุฏูุน                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุงูุญุงูุฉ: [ุงููู โผ]  ุงููุตุฏุฑ: [ุงููู โผ]  ูู: [____] ุฅูู: [____]  [๐ ุจุญุซ]     โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ # โ ุฑูู ุงูุฃูุฑ โ ุงููุตุฏุฑ โ ุงููุณุชููุฏ โ ุงููุจูุบ โ ุงูุญุงูุฉ โ ุงูุชุงุฑูุฎ โ ุฅุฌุฑุงุก โโ
โ  โโโโโผโโโโโโโโโโโโผโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโผโโโโโโโโโผโโโโโโโโโโผโโโโโโโโคโ
โ  โ 1 โ PO-001    โ ุญุฒูุฉ   โ ูุฑูู ุฃุญูุฏโ 14,000 โ โณ ุจุงูุชุธุงุฑโ 15/12  โ [ุงุนุชูุงุฏ]โโ
โ  โ 2 โ PO-002    โ ููุฑุฏ   โ ุดุฑูุฉ ABC โ 50,000 โ โ ูุนุชูุฏ โ 14/12  โ [ุตุฑู] โโ
โ  โ 3 โ PO-003    โ ุฑุงุชุจ   โ ูุญูุฏ ุนูู โ 8,000  โ ๐ต ูุตุฑููโ 13/12  โ [ุนุฑุถ] โโ
โ  โ 4 โ PO-004    โ ุญุงูุฒ   โ ุณุงูู ุฃุญูุฏโ 2,500  โ โณ ุจุงูุชุธุงุฑโ 15/12  โ [ุงุนุชูุงุฏ]โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                                                             โ
โ  ๐ ููุฎุต: ุจุงูุชุธุงุฑ (5) = 45,000 ุฑ.ู | ูุนุชูุฏ (3) = 120,000 ุฑ.ู              โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 12.3 ุดุงุดุฉ ุตุฑู ุฃูุฑ ุงูุฏูุน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ต ุตุฑู ุฃูุฑ ุงูุฏูุน: PO-2025-0042                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุงููุณุชููุฏ: ูุฑูู ุงูุชุฑููุจุงุช - ุฃุญูุฏ                                           โ
โ  ุงููุจูุบ: 14,000 ุฑูุงู                                                        โ
โ  ุงููุตุฏุฑ: ุญุฒูุฉ ุนูู PKG-2025-0042 (ุชุฑููุจ ุนุฏุงุฏุงุช ุญู ุงููุตุฑ)                    โ
โ                                                                             โ
โ  โโ ุชูุงุตูู ุงูุตุฑู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                                                                       โ  โ
โ  โ  ุทุฑููุฉ ุงูุตุฑู: (โ) ููุฏู  ( ) ุชุญููู ุจููู  ( ) ุดูู                      โ  โ
โ  โ                                                                       โ  โ
โ  โ  ุฑูู ุงููุฑุฌุน: [                    ] (ุฑูู ุงูุฅูุตุงู ุฃู ุงูุญูุงูุฉ)         โ  โ
โ  โ                                                                       โ  โ
โ  โ  ููุงุญุธุงุช: [                                          ]               โ  โ
โ  โ                                                                       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                             โ
โ  โ๏ธ ุณูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุชููุงุฆูุงู:                                        โ
โ     ูุฏูู: 5001 - ูุตุฑููุงุช ุงูุนูุงูุฉ ... 14,000 ุฑูุงู                           โ
โ     ุฏุงุฆู: 1001 - ุงูุตูุฏูู ........... 14,000 ุฑูุงู                           โ
โ                                                                             โ
โ  [ุชุฃููุฏ ุงูุตุฑู]  [ุฅูุบุงุก]                                                    โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 12.4 ุงููููุฏ ุงููุญุงุณุจูุฉ ูุฃูุงูุฑ ุงูุฏูุน

| ููุน ุฃูุฑ ุงูุฏูุน | ุงูููุฏ ุงููุญุงุณุจู |
|--------------|----------------|
| **ุญุฒูุฉ ุนูู** | ูุฏูู: ูุตุฑููุงุช ุงูุนูุงูุฉ โ ุฏุงุฆู: ุงูุตูุฏูู/ุงูุจูู |
| **ูุงุชูุฑุฉ ููุฑุฏ** | ูุฏูู: ุงูููุฑุฏูู โ ุฏุงุฆู: ุงูุตูุฏูู/ุงูุจูู |
| **ุฑุงุชุจ** | ูุฏูู: ูุตุฑููุงุช ุงูุฑูุงุชุจ โ ุฏุงุฆู: ุงูุตูุฏูู/ุงูุจูู |
| **ุญุงูุฒ** | ูุฏูู: ูุตุฑููุงุช ุงูุญูุงูุฒ โ ุฏุงุฆู: ุงูุตูุฏูู/ุงูุจูู |
| **ุงุณุชุฑุฏุงุฏ ุชุฃููู** | ูุฏูู: ุงูุชุฃูููุงุช โ ุฏุงุฆู: ุงูุตูุฏูู/ุงูุจูู |

## 12.5 Trigger: ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุนูุฏ ุงูุตุฑู

```sql
CREATE OR REPLACE FUNCTION on_payment_order_paid()
RETURNS TRIGGER AS $$
DECLARE
    v_debit_account_id UUID;
    v_credit_account_id UUID;
    v_journal_entry_id UUID;
BEGIN
    -- ููุท ุนูุฏ ุงูุงูุชูุงู ูุญุงูุฉ "paid"
    IF NEW.status = 'paid' AND OLD.status = 'approved' THEN
        
        -- ุชุญุฏูุฏ ุงูุญุณุงุจ ุงููุฏูู ุญุณุจ ููุน ุฃูุฑ ุงูุฏูุน
        SELECT id INTO v_debit_account_id FROM accounts WHERE code = 
            CASE NEW.source_type
                WHEN 'work_package' THEN '5001'      -- ูุตุฑููุงุช ุงูุนูุงูุฉ
                WHEN 'supplier_invoice' THEN '2001' -- ุงูููุฑุฏูู
                WHEN 'salary' THEN '5002'           -- ูุตุฑููุงุช ุงูุฑูุงุชุจ
                WHEN 'incentive' THEN '5003'        -- ูุตุฑููุงุช ุงูุญูุงูุฒ
                WHEN 'deposit_refund' THEN '2101'   -- ุงูุชุฃูููุงุช
                ELSE '5099'                          -- ูุตุฑููุงุช ุฃุฎุฑู
            END;
        
        -- ุชุญุฏูุฏ ุงูุญุณุงุจ ุงูุฏุงุฆู ุญุณุจ ุทุฑููุฉ ุงูุฏูุน
        SELECT id INTO v_credit_account_id FROM accounts WHERE code = 
            CASE NEW.payment_method
                WHEN 'cash' THEN '1001'         -- ุงูุตูุฏูู
                WHEN 'bank_transfer' THEN '1002' -- ุงูุจูู
                WHEN 'check' THEN '1002'         -- ุงูุจูู
                ELSE '1001'
            END;
        
        -- ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู
        INSERT INTO journal_entries (station_id, entry_date, description, source_type, source_id, created_by)
        VALUES (NEW.station_id, CURRENT_DATE, 'ุตุฑู ุฃูุฑ ุฏูุน: ' || NEW.payment_order_number, 
                'payment_order', NEW.id, NEW.paid_by)
        RETURNING id INTO v_journal_entry_id;
        
        -- ุฅุถุงูุฉ ุณุทูุฑ ุงูููุฏ
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit, credit, description)
        VALUES 
            (v_journal_entry_id, v_debit_account_id, NEW.amount, 0, NEW.description),
            (v_journal_entry_id, v_credit_account_id, 0, NEW.amount, 'ุตุฑู ูู ' || NEW.beneficiary_name);
        
        -- ุฑุจุท ุงูููุฏ ุจุฃูุฑ ุงูุฏูุน
        NEW.journal_entry_id := v_journal_entry_id;
        
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_payment_order_paid
    BEFORE UPDATE ON payment_orders
    FOR EACH ROW
    EXECUTE FUNCTION on_payment_order_paid();
```

## 12.6 APIs ูุธุงู ุฃูุงูุฑ ุงูุฏูุน

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/payment-orders` | ูุงุฆูุฉ ุฃูุงูุฑ ุงูุฏูุน (ูุน ููุชุฑุฉ) |
| GET | `/api/v1/payment-orders/:id` | ุชูุงุตูู ุฃูุฑ ุฏูุน |
| POST | `/api/v1/payment-orders` | ุฅูุดุงุก ุฃูุฑ ุฏูุน ูุฏูู |
| PUT | `/api/v1/payment-orders/:id/approve` | ุงุนุชูุงุฏ ุฃูุฑ ุงูุฏูุน |
| PUT | `/api/v1/payment-orders/:id/pay` | ุชุณุฌูู ุงูุตุฑู |
| PUT | `/api/v1/payment-orders/:id/cancel` | ุฅูุบุงุก ุฃูุฑ ุงูุฏูุน |
| GET | `/api/v1/payment-orders/summary` | ููุฎุต ุฃูุงูุฑ ุงูุฏูุน (ูููุญุฉ ุงูุชุญูู) |
| GET | `/api/v1/payment-orders/pending` | ุฃูุงูุฑ ุงูุฏูุน ุจุงูุชุธุงุฑ ุงูุงุนุชูุงุฏ |


---

# 12. ูุธุงู ุงูุนูุฏ ุงููุงููุฉ (Financial Custody System)

> **ุงูุบุฑุถ:** ุฅุฏุงุฑุฉ ุงููุจุงูุบ ุงูููุฏูุฉ ุงููุตุฑููุฉ ูุนูุฏุฉ ููููุธูููุ ูุน ุชุชุจุน ูุงูู ูุชุตููุฉ ูุญุงุณุจูุฉ ุฏูููุฉ

## 12.1 ุฃููุงุน ุงูุนูุฏ ุงููุงููุฉ

| ุงูููุน | ุงููุตู | ุงูุญุฏ ุงูุฃูุตู | ุงูุชุตููุฉ |
|-------|-------|-------------|---------|
| **ุนูุฏุฉ ุณูุฑ** | ูุตุงุฑูู ุงูุณูุฑ ูุงูุฅูุงูุฉ | 10,000 ุฑูุงู | ุฎูุงู 7 ุฃูุงู ูู ุงูุนูุฏุฉ |
| **ุนูุฏุฉ ูุซุฑูุฉ** | ูุตุงุฑูู ุงูููุชุจ ุงูููููุฉ | 2,000 ุฑูุงู | ุดูุฑูุฉ |
| **ุนูุฏุฉ ูุดุชุฑูุงุช** | ุดุฑุงุก ุทุงุฑุฆ | 5,000 ุฑูุงู | ุฎูุงู 3 ุฃูุงู |
| **ุนูุฏุฉ ูุดุฑูุน** | ูุตุงุฑูู ุชูููุฐ ูุดุฑูุน | ุญุณุจ ุงูููุฒุงููุฉ | ุนูุฏ ุฅุบูุงู ุงููุดุฑูุน |
| **ุณููุฉ ุฑุงุชุจ** | ุณููุฉ ุนูู ุงูุฑุงุชุจ | ุฑุงุชุจ ุดูุฑ | ุฎุตู ูู ุงูุฑุงุชุจ |

## 12.2 ุฌุฏูู ุงูุนูุฏ ุงููุงููุฉ (financial_custodies)

```sql
CREATE TABLE financial_custodies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id) NOT NULL,
    
    -- ุฑูู ุงูุนูุฏุฉ
    custody_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- ููุน ุงูุนูุฏุฉ
    custody_type VARCHAR(30) NOT NULL,
    -- 'travel': ุนูุฏุฉ ุณูุฑ
    -- 'petty_cash': ุนูุฏุฉ ูุซุฑูุฉ
    -- 'purchase': ุนูุฏุฉ ูุดุชุฑูุงุช
    -- 'project': ุนูุฏุฉ ูุดุฑูุน
    -- 'salary_advance': ุณููุฉ ุฑุงุชุจ
    
    -- ุงููุณุชูู
    employee_id UUID REFERENCES employees(id) NOT NULL,
    employee_name VARCHAR(200),
    department_id UUID,
    
    -- ุงููุฑุฌุน (ุงุฎุชูุงุฑู)
    reference_type VARCHAR(30), -- 'project', 'trip', 'none'
    reference_id UUID,
    
    -- ุงููุจูุบ
    requested_amount DECIMAL(15, 2) NOT NULL,
    approved_amount DECIMAL(15, 2),
    currency VARCHAR(3) DEFAULT 'SAR',
    
    -- ุงูุชุตููุฉ
    spent_amount DECIMAL(15, 2) DEFAULT 0,
    returned_amount DECIMAL(15, 2) DEFAULT 0,
    deducted_amount DECIMAL(15, 2) DEFAULT 0, -- ููุณูู
    
    -- ุงูุชูุงุฑูุฎ
    request_date DATE NOT NULL DEFAULT CURRENT_DATE,
    issue_date DATE,
    expected_settlement_date DATE,
    actual_settlement_date DATE,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending',
    -- 'pending': ุจุงูุชุธุงุฑ ุงูููุงููุฉ
    -- 'approved': ููุงูู ุนูููุง
    -- 'issued': ูุตุฑููุฉ
    -- 'pending_settlement': ุจุงูุชุธุงุฑ ุงูุชุตููุฉ
    -- 'settled': ููุตูุงุฉ
    -- 'rejected': ูุฑููุถุฉ
    -- 'cancelled': ููุบุงุฉ
    
    -- ุงูููุงููุงุช
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    rejection_reason TEXT,
    
    -- ุงูุตุฑู
    issued_by UUID REFERENCES users(id),
    issued_at TIMESTAMP,
    payment_method VARCHAR(20), -- 'cash', 'bank_transfer', 'check'
    
    -- ุงูุชุตููุฉ
    settled_by UUID REFERENCES users(id),
    settled_at TIMESTAMP,
    
    -- ุงููููุฏ ุงููุญุงุณุจูุฉ
    issue_journal_entry_id UUID,
    settlement_journal_entry_id UUID,
    
    -- ุงูุบุฑุถ ูุงูููุงุญุธุงุช
    purpose TEXT NOT NULL,
    notes TEXT,
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ููุงุฑุณ
CREATE INDEX idx_financial_custodies_employee ON financial_custodies(employee_id);
CREATE INDEX idx_financial_custodies_status ON financial_custodies(status);
CREATE INDEX idx_financial_custodies_type ON financial_custodies(custody_type);
```

## 12.3 ุฌุฏูู ูุณุชูุฏุงุช ุงูุชุตููุฉ (custody_settlement_documents)

```sql
CREATE TABLE custody_settlement_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    custody_id UUID REFERENCES financial_custodies(id) NOT NULL,
    
    -- ููุน ุงููุณุชูุฏ
    document_type VARCHAR(30) NOT NULL,
    -- 'invoice': ูุงุชูุฑุฉ
    -- 'receipt': ุฅูุตุงู
    -- 'ticket': ุชุฐูุฑุฉ ุณูุฑ
    -- 'hotel_bill': ูุงุชูุฑุฉ ููุฏู
    -- 'fuel_receipt': ุฅูุตุงู ูููุฏ
    -- 'other': ุฃุฎุฑู
    
    -- ุงูุชูุงุตูู
    document_number VARCHAR(50),
    document_date DATE NOT NULL,
    vendor_name VARCHAR(200),
    description TEXT,
    
    -- ุงููุจูุบ
    amount DECIMAL(15, 2) NOT NULL,
    vat_amount DECIMAL(15, 2) DEFAULT 0,
    total_amount DECIMAL(15, 2),
    
    -- ุงููุฑูู
    attachment_url TEXT,
    attachment_name VARCHAR(200),
    
    -- ุงูุชุญูู
    is_verified BOOLEAN DEFAULT false,
    verified_by UUID REFERENCES users(id),
    verified_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 12.4 ุงููููุฏ ุงููุญุงุณุจูุฉ ููุนูุฏ ุงููุงููุฉ

### ุนูุฏ ุตุฑู ุงูุนูุฏุฉ:
```sql
-- ููุฏ ุตุฑู ุนูุฏุฉ ุณูุฑ
ูุฏูู: 1150 - ุนูุฏ ููุธููู .................. 5,000 ุฑูุงู
  ุฏุงุฆู: 1101 - ุงูุตูุฏูู ................... 5,000 ุฑูุงู
```

### ุนูุฏ ุงูุชุตููุฉ (ูุตุฑููุงุช ุฃูู ูู ุงูุนูุฏุฉ):
```sql
-- ููุฏ ุชุตููุฉ ุนูุฏุฉ (ูุตุฑูู 4,200 + ูุฑุชุฌุน 800)
ูุฏูู: 6201 - ูุตุงุฑูู ุณูุฑ ูุฅูุงูุฉ ........... 4,200 ุฑูุงู
ูุฏูู: 1101 - ุงูุตูุฏูู ..................... 800 ุฑูุงู
  ุฏุงุฆู: 1150 - ุนูุฏ ููุธููู ................ 5,000 ุฑูุงู
```

### ุนูุฏ ุงูุชุตููุฉ (ูุตุฑููุงุช ุฃูุซุฑ ูู ุงูุนูุฏุฉ):
```sql
-- ููุฏ ุชุตููุฉ ุนูุฏุฉ (ูุตุฑูู 5,500 - ุนูุฏุฉ 5,000 = ูุณุชุญู 500)
ูุฏูู: 6201 - ูุตุงุฑูู ุณูุฑ ูุฅูุงูุฉ ........... 5,500 ุฑูุงู
  ุฏุงุฆู: 1150 - ุนูุฏ ููุธููู ................ 5,000 ุฑูุงู
  ุฏุงุฆู: 2101 - ูุณุชุญูุงุช ููุธููู ............ 500 ุฑูุงู
```

## 12.5 ุดุงุดุฉ ุทูุจ ุนูุฏุฉ ูุงููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฐ ุทูุจ ุนูุฏุฉ ูุงููุฉ ุฌุฏูุฏุฉ                                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                 โ
โ  โโ ูุนูููุงุช ุงูุทูุจ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ููุน ุงูุนูุฏุฉ: [ุนูุฏุฉ ุณูุฑ           โผ]                                        โ  โ
โ  โ ุงููุจูุบ ุงููุทููุจ: [5,000          ] ุฑูุงู                                    โ  โ
โ  โ ุชุงุฑูุฎ ุงูุชุตููุฉ ุงููุชููุน: [25/12/2025]                                       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  โโ ุงูุบุฑุถ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ [ุฒูุงุฑุฉ ุนูู ููุฑุน ุฌุฏุฉ - ุงุฌุชูุงุน ูุน ุงูุนููู ุงูุฑุฆูุณู                          ] โ  โ
โ  โ [ูุฏุฉ ุงูุฑุญูุฉ: 3 ุฃูุงู                                                     ] โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  โโ ุชูุงุตูู ุงูุณูุฑ (ูุนูุฏุฉ ุงูุณูุฑ) โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงููุฌูุฉ: [ุฌุฏุฉ                    ]                                         โ  โ
โ  โ ุชุงุฑูุฎ ุงููุบุงุฏุฑุฉ: [20/12/2025]    ุชุงุฑูุฎ ุงูุนูุฏุฉ: [23/12/2025]               โ  โ
โ  โ ูุณููุฉ ุงูุณูุฑ: [โ ุทูุฑุงู  โ ุณูุงุฑุฉ  โ ูุทุงุฑ]                                  โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  [ุฅุฑุณุงู ููููุงููุฉ]  [ุญูุธ ููุณูุฏุฉ]  [ุฅูุบุงุก]                                       โ
โ                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 12.6 ุดุงุดุฉ ุชุตููุฉ ุงูุนูุฏุฉ ุงููุงููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ุชุตููุฉ ุงูุนูุฏุฉ ุงููุงููุฉ - FC-2025-0001                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                 โ
โ  ุงูููุธู: ุฃุญูุฏ ูุญูุฏ    โ    ููุน ุงูุนูุฏุฉ: ุนูุฏุฉ ุณูุฑ    โ    ุงููุจูุบ: 5,000 ุฑูุงู    โ
โ                                                                                 โ
โ  โโ ุงููุณุชูุฏุงุช โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ [+ ุฅุถุงูุฉ ูุณุชูุฏ]                                                           โ  โ
โ  โ                                                                           โ  โ
โ  โ # โ ุงูููุน      โ ุงูุฑูู     โ ุงูุชุงุฑูุฎ   โ ุงูุจุงุฆุน        โ ุงููุจูุบ   โ โ    โ  โ
โ  โ 1 โ ุชุฐูุฑุฉ ุทูุฑุงูโ TK-12345 โ 20/12    โ ุงูุฎุทูุท ุงูุณุนูุฏูุฉโ 1,500   โ [๐] โ  โ
โ  โ 2 โ ูุงุชูุฑุฉ ููุฏูโ INV-789  โ 23/12    โ ููุฏู ุงูุฑูุชุฒ   โ 2,000   โ [๐] โ  โ
โ  โ 3 โ ุฅูุตุงู ูููุฏ โ R-456    โ 21/12    โ ูุญุทุฉ ุงููููุฏ   โ 200     โ [๐] โ  โ
โ  โ 4 โ ุฅูุตุงู ุทุนุงู โ R-789    โ 22/12    โ ูุทุนู         โ 500     โ [๐] โ  โ
โ  โ                                                                           โ  โ
โ  โ ุฅุฌูุงูู ุงููุณุชูุฏุงุช: 4,200 ุฑูุงู                                              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  โโ ููุฎุต ุงูุชุตููุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ูุจูุบ ุงูุนูุฏุฉ: 5,000 ุฑูุงู                                                   โ  โ
โ  โ ุงููุตุฑููุงุช ุงููุซุจุชุฉ: 4,200 ุฑูุงู                                             โ  โ
โ  โ ุงููุจูุบ ุงููุฑุชุฌุน: 800 ุฑูุงู                                                  โ  โ
โ  โ                                                                           โ  โ
โ  โ ุทุฑููุฉ ุงูุฅุฑุฌุงุน: [โ ููุฏุงู  โ ุฎุตู ูู ุงูุฑุงุชุจ  โ ุชุญููู ุจููู]                  โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                                 โ
โ  [ุชุฃููุฏ ุงูุชุตููุฉ]  [ุญูุธ ููุณูุฏุฉ]  [ุฅูุบุงุก]                                        โ
โ                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 12.7 Trigger: ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ

```sql
CREATE OR REPLACE FUNCTION create_custody_journal_entries()
RETURNS TRIGGER AS $$
DECLARE
    v_journal_entry_id UUID;
BEGIN
    -- ููุฏ ุงูุตุฑู
    IF NEW.status = 'issued' AND OLD.status = 'approved' THEN
        INSERT INTO journal_entries (
            business_id, entry_number, entry_date, entry_type,
            reference_type, reference_id, description, status
        ) VALUES (
            NEW.business_id, generate_journal_number(), CURRENT_DATE, 'custody_issue',
            'financial_custody', NEW.id, 'ุตุฑู ุนูุฏุฉ: ' || NEW.custody_number, 'posted'
        ) RETURNING id INTO v_journal_entry_id;
        
        -- ูุฏูู: ุนูุฏ ููุธููู
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit_amount, description)
        VALUES (v_journal_entry_id, get_account_id('1150'), NEW.approved_amount, 'ุนูุฏุฉ: ' || NEW.employee_name);
        
        -- ุฏุงุฆู: ุงูุตูุฏูู ุฃู ุงูุจูู
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, credit_amount, description)
        VALUES (v_journal_entry_id, 
                CASE WHEN NEW.payment_method = 'cash' THEN get_account_id('1101') 
                     ELSE get_account_id('1102') END,
                NEW.approved_amount, 'ุตุฑู ุนูุฏุฉ');
        
        NEW.issue_journal_entry_id := v_journal_entry_id;
    END IF;
    
    -- ููุฏ ุงูุชุตููุฉ
    IF NEW.status = 'settled' AND OLD.status = 'pending_settlement' THEN
        INSERT INTO journal_entries (
            business_id, entry_number, entry_date, entry_type,
            reference_type, reference_id, description, status
        ) VALUES (
            NEW.business_id, generate_journal_number(), CURRENT_DATE, 'custody_settlement',
            'financial_custody', NEW.id, 'ุชุตููุฉ ุนูุฏุฉ: ' || NEW.custody_number, 'posted'
        ) RETURNING id INTO v_journal_entry_id;
        
        -- ูุฏูู: ุงููุตุงุฑูู
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit_amount, description)
        VALUES (v_journal_entry_id, get_expense_account(NEW.custody_type), NEW.spent_amount, 'ูุตุงุฑูู ุนูุฏุฉ');
        
        -- ูุฏูู: ุงูุตูุฏูู (ุงููุฑุชุฌุน) ุฅู ูุฌุฏ
        IF NEW.returned_amount > 0 THEN
            INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit_amount, description)
            VALUES (v_journal_entry_id, get_account_id('1101'), NEW.returned_amount, 'ูุฑุชุฌุน ุนูุฏุฉ');
        END IF;
        
        -- ุฏุงุฆู: ุนูุฏ ููุธููู
        INSERT INTO journal_entry_lines (journal_entry_id, account_id, credit_amount, description)
        VALUES (v_journal_entry_id, get_account_id('1150'), NEW.approved_amount, 'ุฅููุงู ุนูุฏุฉ');
        
        NEW.settlement_journal_entry_id := v_journal_entry_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_custody_journal_entries
BEFORE UPDATE ON financial_custodies
FOR EACH ROW
EXECUTE FUNCTION create_custody_journal_entries();
```

## 12.8 ุชูุฑูุฑ ุงูุนูุฏ ุงููุงููุฉ ุงูููุชูุญุฉ

```sql
CREATE VIEW v_open_financial_custodies AS
SELECT 
    fc.id,
    fc.custody_number,
    fc.custody_type,
    fc.employee_name,
    fc.approved_amount,
    fc.issue_date,
    fc.expected_settlement_date,
    CASE 
        WHEN fc.expected_settlement_date < CURRENT_DATE THEN 'overdue'
        WHEN fc.expected_settlement_date <= CURRENT_DATE + INTERVAL '3 days' THEN 'due_soon'
        ELSE 'normal'
    END AS urgency,
    CURRENT_DATE - fc.issue_date AS days_outstanding,
    fc.status
FROM financial_custodies fc
WHERE fc.status IN ('issued', 'pending_settlement')
ORDER BY fc.expected_settlement_date;
```

## 12.9 APIs ูุธุงู ุงูุนูุฏ ุงููุงููุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/financial-custodies` | ูุงุฆูุฉ ุงูุนูุฏ ุงููุงููุฉ |
| POST | `/api/v1/financial-custodies` | ุทูุจ ุนูุฏุฉ ุฌุฏูุฏุฉ |
| GET | `/api/v1/financial-custodies/:id` | ุชูุงุตูู ุนูุฏุฉ |
| POST | `/api/v1/financial-custodies/:id/approve` | ุงูููุงููุฉ ุนูู ุงูุนูุฏุฉ |
| POST | `/api/v1/financial-custodies/:id/reject` | ุฑูุถ ุงูุนูุฏุฉ |
| POST | `/api/v1/financial-custodies/:id/issue` | ุตุฑู ุงูุนูุฏุฉ |
| POST | `/api/v1/financial-custodies/:id/settle` | ุชุตููุฉ ุงูุนูุฏุฉ |
| POST | `/api/v1/financial-custodies/:id/documents` | ุฅุถุงูุฉ ูุณุชูุฏ ุชุตููุฉ |
| GET | `/api/v1/financial-custodies/open` | ุงูุนูุฏ ุงูููุชูุญุฉ |
| GET | `/api/v1/financial-custodies/overdue` | ุงูุนูุฏ ุงููุชุฃุฎุฑุฉ |
| GET | `/api/v1/employees/:id/financial-custodies` | ุนูุฏ ููุธู |

---

# 15. ุงููููุฏ ุงูุงูุชุชุงุญูุฉ (Opening Balance Entries)

> **ุงูุบุฑุถ:** ุชุณุฌูู ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ ููุฃุตูู ูุงููุฎุฒูู ูุงูุฐูู ุนูุฏ ุจุฏุก ุชุดุบูู ุงููุธุงู

## 15.1 ุฌุฏูู ุงููููุฏ ุงูุงูุชุชุงุญูุฉ

```sql
CREATE TABLE opening_balance_entries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ูุนูููุงุช ุงูููุฏ
    entry_number VARCHAR(20) UNIQUE NOT NULL,
    entry_date DATE NOT NULL,
    description TEXT,
    
    -- ุงูููุน
    entry_type VARCHAR(30) NOT NULL,
    -- 'fixed_assets': ุงูุฃุตูู ุงูุซุงุจุชุฉ
    -- 'inventory': ุงููุฎุฒูู
    -- 'receivables': ุฐูู ุงูุนููุงุก
    -- 'payables': ุฐูู ุงูููุฑุฏูู
    -- 'cash': ุงูููุฏูุฉ ูุงูุจููู
    -- 'comprehensive': ุดุงูู
    
    -- ุงููุฑุฌุน
    source_batch_id UUID,  -- ุฏูุนุฉ ุงูุงุณุชูุฑุงุฏ ุงููุฑุชุจุทุฉ
    
    -- ุงููุจุงูุบ ุงูุฅุฌูุงููุฉ
    total_debit DECIMAL(15, 2) NOT NULL,
    total_credit DECIMAL(15, 2) NOT NULL,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'draft',
    -- 'draft': ูุณูุฏุฉ
    -- 'pending_approval': ุจุงูุชุธุงุฑ ุงูุงุนุชูุงุฏ
    -- 'approved': ูุนุชูุฏ
    -- 'posted': ูุฑุญู
    
    -- ุงูุชุฏููู
    prepared_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    posted_by UUID REFERENCES users(id),
    
    -- ุงูุชูุงุฑูุฎ
    created_at TIMESTAMP DEFAULT NOW(),
    approved_at TIMESTAMP,
    posted_at TIMESTAMP
);

-- ุชูุงุตูู ุงูููุฏ ุงูุงูุชุชุงุญู
CREATE TABLE opening_balance_details (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entry_id UUID REFERENCES opening_balance_entries(id) ON DELETE CASCADE,
    
    account_id UUID REFERENCES chart_of_accounts(id) NOT NULL,
    
    debit_amount DECIMAL(15, 2) DEFAULT 0,
    credit_amount DECIMAL(15, 2) DEFAULT 0,
    
    description TEXT,
    
    -- ุงููุฑุฌุน ุงูุชูุตููู
    reference_type VARCHAR(30),  -- 'asset', 'inventory_item', 'customer', 'supplier'
    reference_id UUID,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 15.2 ููุฏ ุงูุงูุชุชุงุญ ููุฃุตูู ุงูุซุงุจุชุฉ

### ูุซุงู ุนูู ุงูููุฏ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ููุฏ ููููุฉ ุงูุชุชุงุญู - ุฅุฏุฎุงู ุงูุฃุตูู ุงููุงุฆูุฉ                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                 โ
โ ุฑูู ุงูููุฏ: OB-2025-001                                                         โ
โ ุงูุชุงุฑูุฎ: 01/12/2025                                                            โ
โ ุงูุจูุงู: ุฅุฏุฎุงู ุงูุฃุตูู ุงูุซุงุจุชุฉ ุงููุงุฆูุฉ ูู ุงููุธุงู ุงูุฌุฏูุฏ                          โ
โ                                                                                 โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ุงูุญุณุงุจ                              โ ูุฏูู          โ ุฏุงุฆู          โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโค โ
โ โ 1500 - ุงูุฃุตูู ุงูุซุงุจุชุฉ - ูููุฏุงุช      โ 2,000,000     โ               โ โ
โ โ 1501 - ุงูุฃุตูู ุงูุซุงุจุชุฉ - ุดุจูุงุช       โ 5,000,000     โ               โ โ
โ โ 1502 - ุงูุฃุตูู ุงูุซุงุจุชุฉ - ุทุจุงุจููู     โ 1,500,000     โ               โ โ
โ โ 1503 - ุงูุฃุตูู ุงูุซุงุจุชุฉ - ูุจุงูู       โ 3,000,000     โ               โ โ
โ โ 1504 - ุงูุฃุตูู ุงูุซุงุจุชุฉ - ูุนุฏุงุช       โ   500,000     โ               โ โ
โ โ 1599 - ูุฌูุน ุงูุฅููุงู                 โ               โ 2,500,000     โ โ
โ โ 3001 - ุฑุฃุณ ุงููุงู / ุฃุฑุตุฏุฉ ุงูุชุชุงุญูุฉ  โ               โ 9,500,000     โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโค โ
โ โ ุงูุฅุฌูุงูู                            โ 12,000,000    โ 12,000,000    โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ โ
โ                                                                                 โ
โ ููุงุญุธุฉ: ูุฐุง ุงูููุฏ ูุชู ุฅุฌุฑุงุคู ูุฑุฉ ูุงุญุฏุฉ ููุท ุนูุฏ ุจุฏุก ุชุดุบูู ุงููุธุงู               โ
โ                                                                                 โ
โ [ุงุนุชูุงุฏ ุงูููุฏ]  [ุชุฑุญูู]  [ุทุจุงุนุฉ]                                               โ
โ                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.3 Trigger ุฅูุดุงุก ุงูููุฏ ุงูุงูุชุชุงุญู ุชููุงุฆูุงู

```sql
-- Function ูุฅูุดุงุก ููุฏ ุงูุชุชุงุญู ูู ุฏูุนุฉ ุงุณุชูุฑุงุฏ ุงูุฃุตูู
CREATE OR REPLACE FUNCTION create_asset_opening_entry(p_batch_id UUID)
RETURNS UUID AS $$
DECLARE
    v_entry_id UUID;
    v_total DECIMAL(15, 2);
    v_depreciation DECIMAL(15, 2);
    r RECORD;
BEGIN
    -- ุฅูุดุงุก ุงูููุฏ ุงูุฑุฆูุณู
    INSERT INTO opening_balance_entries (
        entry_number,
        entry_date,
        description,
        entry_type,
        source_batch_id,
        total_debit,
        total_credit,
        status
    )
    SELECT 
        'OB-' || TO_CHAR(NOW(), 'YYYY') || '-' || LPAD(NEXTVAL('opening_entry_seq')::TEXT, 3, '0'),
        CURRENT_DATE,
        'ููุฏ ุงูุชุชุงุญู - ุงุณุชูุฑุงุฏ ุงูุฃุตูู ุฏูุนุฉ ' || batch_number,
        'fixed_assets',
        id,
        0, 0,
        'draft'
    FROM asset_import_batches
    WHERE id = p_batch_id
    RETURNING id INTO v_entry_id;
    
    -- ุฅุถุงูุฉ ุชูุงุตูู ุงูููุฏ ููู ูุฆุฉ ุฃุตูู
    FOR r IN (
        SELECT 
            ac.gl_account_id,
            SUM(a.acquisition_cost) as total_cost,
            SUM(a.accumulated_depreciation) as total_depreciation
        FROM assets a
        JOIN asset_categories ac ON a.category_id = ac.id
        JOIN asset_import_details aid ON a.id = aid.asset_id
        WHERE aid.batch_id = p_batch_id
        GROUP BY ac.gl_account_id
    ) LOOP
        -- ููุฏ ุงูุฃุตู (ูุฏูู)
        INSERT INTO opening_balance_details (entry_id, account_id, debit_amount, description)
        VALUES (v_entry_id, r.gl_account_id, r.total_cost, 'ุชูููุฉ ุงูุฃุตูู');
        
        v_total := v_total + r.total_cost;
        v_depreciation := v_depreciation + r.total_depreciation;
    END LOOP;
    
    -- ููุฏ ูุฌูุน ุงูุฅููุงู (ุฏุงุฆู)
    IF v_depreciation > 0 THEN
        INSERT INTO opening_balance_details (entry_id, account_id, credit_amount, description)
        VALUES (v_entry_id, get_account_id('1599'), v_depreciation, 'ูุฌูุน ุงูุฅููุงู ุงููุชุฑุงูู');
    END IF;
    
    -- ููุฏ ุฑุฃุณ ุงููุงู (ุฏุงุฆู)
    INSERT INTO opening_balance_details (entry_id, account_id, credit_amount, description)
    VALUES (v_entry_id, get_account_id('3001'), v_total - v_depreciation, 'ุฃุฑุตุฏุฉ ุงูุชุชุงุญูุฉ');
    
    -- ุชุญุฏูุซ ุฅุฌูุงููุงุช ุงูููุฏ
    UPDATE opening_balance_entries
    SET total_debit = v_total,
        total_credit = v_total
    WHERE id = v_entry_id;
    
    RETURN v_entry_id;
END;
$$ LANGUAGE plpgsql;
```

## 15.4 APIs ุงููููุฏ ุงูุงูุชุชุงุญูุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/opening-entries` | ูุงุฆูุฉ ุงููููุฏ ุงูุงูุชุชุงุญูุฉ |
| GET | `/api/v1/opening-entries/:id` | ุชูุงุตูู ููุฏ |
| POST | `/api/v1/opening-entries` | ุฅูุดุงุก ููุฏ ุงูุชุชุงุญู |
| POST | `/api/v1/opening-entries/from-import/:batchId` | ุฅูุดุงุก ูู ุฏูุนุฉ ุงุณุชูุฑุงุฏ |
| PUT | `/api/v1/opening-entries/:id/approve` | ุงุนุชูุงุฏ ุงูููุฏ |
| POST | `/api/v1/opening-entries/:id/post` | ุชุฑุญูู ุงูููุฏ |
| GET | `/api/v1/opening-entries/:id/print` | ุทุจุงุนุฉ ุงูููุฏ |

---

## 16. ูุธุงู ุฅุฏุงุฑุฉ ุงููุฌููุนุฉ ูุชุนุฏุฏุฉ ุงููุณุชููุงุช (Multi-Level Organization Management)

> **ุงููุฏู:** ุชุญููู ุงููุธุงู ูู ุญู ููุญุทุฉ ูุงุญุฏุฉ ุฅูู ููุตุฉ ุญููููุฉ ูุฅุฏุงุฑุฉ ูุฌููุนุฉ ุดุฑูุงุช ุทุงูุฉ

### 16.1 ุงููููู ุงูุชูุธููู ุงููุฑูู

#### ุงูุจููุฉ ุงููุฑููุฉ (4 ูุณุชููุงุช):

```
ุงููุณุชูู 1: ุงูุดุฑูุฉ ุงููุงุจุถุฉ (Company/Group)
โโโ ุดุฑูุฉ ุงูุทุงูุฉ ุงููุชุญุฏุฉ
    โ
    โโโ ุงููุณุชูู 2: ุงููุฑูุน/ุงูููุงุทู (Branches)
    โ   โโโ ูุฑุน ุงูุญุฏูุฏุฉ
    โ   โ   โ
    โ   โ   โโโ ุงููุณุชูู 3: ุงููุญุทุงุช (Stations)
    โ   โ       โโโ ูุญุทุฉ ุงููููุฏุงุช G1
    โ   โ       โโโ ูุญุทุฉ ุงููููุฏุงุช G2
    โ   โ       โโโ ูุญุทุฉ ุงูุทุงูุฉ ุงูุดูุณูุฉ S1
    โ   โ       โโโ ูุญุทุฉ ุงูุทุงูุฉ ุงูุดูุณูุฉ S2
    โ   โ
    โ   โโโ ูุฑุน ุตูุนุงุก
    โ       โโโ ุงููุณุชูู 3: ุงููุญุทุงุช
    โ           โโโ ูุญุทุฉ ุงููููุฏุงุช G6
    โ           โโโ ูุญุทุฉ ุงูุทุงูุฉ ุงูุดูุณูุฉ S6
    โ
    โโโ ุงููุณุชูู 4: ุงูุฃุตูู (Assets)
        โโโ ุงููููุฏุงุช
        โโโ ุงูุฃููุงุญ ุงูุดูุณูุฉ
        โโโ ุงูุฅููุฑุชุฑุงุช
        โโโ ุงูููุงุจู ูุงูุฃุนูุฏุฉ
        โโโ ุงููุดุชุฑููู
```

### 16.2 ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### 16.2.1 ุฌุฏูู ุงูุดุฑูุงุช (companies)

```sql
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(20) UNIQUE NOT NULL,
    name_ar VARCHAR(200) NOT NULL,
    name_en VARCHAR(200),
    legal_name VARCHAR(300),
    registration_number VARCHAR(50),
    tax_number VARCHAR(50),
    
    -- ูุนูููุงุช ุงูุชูุงุตู
    address TEXT,
    city VARCHAR(100),
    country VARCHAR(100) DEFAULT 'ุงูููู',
    phone VARCHAR(20),
    email VARCHAR(100),
    website VARCHAR(200),
    
    -- ุงูุฅุนุฏุงุฏุงุช
    fiscal_year_start INT DEFAULT 1, -- ุดูุฑ ุจุฏุงูุฉ ุงูุณูุฉ ุงููุงููุฉ
    default_currency VARCHAR(3) DEFAULT 'YER',
    timezone VARCHAR(50) DEFAULT 'Asia/Aden',
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 16.2.2 ุฌุฏูู ุงููุฑูุน (branches)

```sql
CREATE TABLE branches (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id),
    code VARCHAR(20) NOT NULL,
    name_ar VARCHAR(200) NOT NULL,
    name_en VARCHAR(200),
    
    -- ูุนูููุงุช ุงููุฑุน
    region VARCHAR(100),
    city VARCHAR(100),
    address TEXT,
    phone VARCHAR(20),
    email VARCHAR(100),
    
    -- ุงููุฏูุฑ ุงููุณุคูู
    manager_id UUID REFERENCES users(id),
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(company_id, code)
);
```

#### 16.2.3 ุชุญุฏูุซ ุฌุฏูู ุงููุญุทุงุช (stations)

```sql
-- ุฅุถุงูุฉ ุนููุฏ branch_id ูููุญุทุงุช
ALTER TABLE stations ADD COLUMN branch_id UUID REFERENCES branches(id);

-- ุชุญุฏูุซ ุงููุญุทุงุช ุงูุญุงููุฉ
-- UPDATE stations SET branch_id = (SELECT id FROM branches WHERE code = 'DEFAULT');
```

### 16.3 ูุญุฑู ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช ุงููุชูุฏู

#### 16.3.1 ุงูุฃุฏูุงุฑ ุงูุฌุฏูุฏุฉ

```sql
-- ุฅุถุงูุฉ ุงูุฃุฏูุงุฑ ุงูุฌุฏูุฏุฉ
INSERT INTO roles (code, name_ar, name_en, level, scope_type) VALUES
('group_admin', 'ูุฏูุฑ ุนุงู ุงููุฌููุนุฉ', 'Group Administrator', 1, 'company'),
('branch_manager', 'ูุฏูุฑ ูุฑุน', 'Branch Manager', 2, 'branch'),
('branch_accountant', 'ูุญุงุณุจ ูุฑุน', 'Branch Accountant', 2, 'branch'),
('station_manager', 'ูุฏูุฑ ูุญุทุฉ', 'Station Manager', 3, 'station'),
('operations_engineer', 'ูููุฏุณ ุชุดุบูู', 'Operations Engineer', 3, 'station'),
('field_technician', 'ููู ููุฏุงูู', 'Field Technician', 4, 'station');
```

#### 16.3.2 ุฌุฏูู ูุทุงู ุงูุตูุงุญูุงุช (user_scopes)

```sql
CREATE TABLE user_scopes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id),
    scope_type VARCHAR(20) NOT NULL, -- 'company', 'branch', 'station'
    scope_id UUID NOT NULL, -- ID of company, branch, or station
    role_id UUID NOT NULL REFERENCES roles(id),
    
    -- ุตูุงุญูุงุช ุฅุถุงููุฉ
    can_view BOOLEAN DEFAULT true,
    can_create BOOLEAN DEFAULT false,
    can_edit BOOLEAN DEFAULT false,
    can_delete BOOLEAN DEFAULT false,
    can_approve BOOLEAN DEFAULT false,
    
    is_primary BOOLEAN DEFAULT false, -- ุงููุทุงู ุงูุงูุชุฑุงุถู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, scope_type, scope_id)
);
```

#### 16.3.3 ุตูุงุญูุงุช ูู ุฏูุฑ

| ุงูุฏูุฑ | ุงููุณุชูู | ุงููุทุงู | ุงูุตูุงุญูุงุช |
|-------|---------|--------|----------|
| **ูุฏูุฑ ุนุงู ุงููุฌููุนุฉ** | 1 | ุงูุดุฑูุฉ | ูู ุดูุก ูู ูู ุงููุฑูุน ูุงููุญุทุงุช |
| **ูุฏูุฑ ูุฑุน** | 2 | ุงููุฑุน | ูู ุดูุก ูู ูุญุทุงุช ูุฑุนู ููุท |
| **ูุญุงุณุจ ูุฑุน** | 2 | ุงููุฑุน | ุงูุจูุงูุงุช ุงููุงููุฉ ููุฑุนู ููุท |
| **ูุฏูุฑ ูุญุทุฉ** | 3 | ุงููุญุทุฉ | ูู ุดูุก ูู ูุญุทุชู ููุท |
| **ูููุฏุณ ุชุดุบูู** | 3 | ุงููุญุทุฉ | ุจูุงูุงุช ุงูุชุดุบูู ููุท |
| **ููู ููุฏุงูู** | 4 | ุงููุญุทุฉ | ุฃูุงูุฑ ุงูุนูู ุงููุณูุฏุฉ ุฅููู ููุท |

### 16.4 ููุชุฑุฉ ุงูุจูุงูุงุช ูุชุนุฏุฏุฉ ุงููุณุชููุงุช

#### 16.4.1 ุฏุงูุฉ ุงูุญุตูู ุนูู ุงููุทุงู ุงููุณููุญ

```sql
CREATE OR REPLACE FUNCTION get_user_allowed_stations(p_user_id UUID)
RETURNS TABLE(station_id UUID) AS $$
BEGIN
    RETURN QUERY
    SELECT DISTINCT s.id
    FROM stations s
    JOIN branches b ON s.branch_id = b.id
    JOIN user_scopes us ON us.user_id = p_user_id AND us.is_active = true
    WHERE 
        -- ูุทุงู ุงูุดุฑูุฉ: ูู ุงููุญุทุงุช
        (us.scope_type = 'company' AND b.company_id = us.scope_id)
        OR
        -- ูุทุงู ุงููุฑุน: ูุญุทุงุช ุงููุฑุน ููุท
        (us.scope_type = 'branch' AND s.branch_id = us.scope_id)
        OR
        -- ูุทุงู ุงููุญุทุฉ: ุงููุญุทุฉ ุงููุญุฏุฏุฉ ููุท
        (us.scope_type = 'station' AND s.id = us.scope_id);
END;
$$ LANGUAGE plpgsql;
```

#### 16.4.2 View: ุงูุจูุงูุงุช ุงููููุชุฑุฉ

```sql
-- ูุซุงู: ุงูุนููุงุก ุงููููุชุฑูู ุญุณุจ ุตูุงุญูุงุช ุงููุณุชุฎุฏู
CREATE OR REPLACE VIEW v_filtered_customers AS
SELECT c.*
FROM customers c
WHERE c.station_id IN (
    SELECT station_id FROM get_user_allowed_stations(current_setting('app.current_user_id')::UUID)
);
```

### 16.5 ุดุงุดุงุช ุฅุฏุงุฑุฉ ุงููููู ุงูุชูุธููู

#### 16.5.1 ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงููููู ุงูุชูุธููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ข ุฅุฏุงุฑุฉ ุงููููู ุงูุชูุธููู                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ ุงูุดุฑูุฉ: ุดุฑูุฉ ุงูุทุงูุฉ ุงููุชุญุฏุฉ                    [โ๏ธ ุฅุนุฏุงุฏุงุช]     โ
โ                                                                  โ
โ ุงููุฑูุน:                                                         โ
โ โโ ๐ ูุฑุน ุงูุญุฏูุฏุฉ                              [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ โก ูุญุทุฉ G1 (ูููุฏุงุช) - 500 ูุดุชุฑู        [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ โก ูุญุทุฉ G2 (ูููุฏุงุช) - 300 ูุดุชุฑู        [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ โ๏ธ ูุญุทุฉ S1 (ุดูุณูุฉ) - 200 ูุดุชุฑู         [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ [+ ุฅุถุงูุฉ ูุญุทุฉ]                                          โ
โ โ                                                                โ
โ โโ ๐ ูุฑุน ุตูุนุงุก                                [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ โก ูุญุทุฉ G6 (ูููุฏุงุช) - 400 ูุดุชุฑู        [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ โ๏ธ ูุญุทุฉ S6 (ุดูุณูุฉ) - 150 ูุดุชุฑู         [โ๏ธ] [๐๏ธ]       โ
โ โ   โโ [+ ุฅุถุงูุฉ ูุญุทุฉ]                                          โ
โ โ                                                                โ
โ โโ [+ ุฅุถุงูุฉ ูุฑุน ุฌุฏูุฏ]                                          โ
โ                                                                  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ ุงูุฅุญุตุงุฆูุงุช:                                                     โ
โ โข ุฅุฌูุงูู ุงููุฑูุน: 2                                              โ
โ โข ุฅุฌูุงูู ุงููุญุทุงุช: 5                                             โ
โ โข ุฅุฌูุงูู ุงููุดุชุฑููู: 1,550                                       โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 16.5.2 ุดุงุดุฉ ุฅูุดุงุก ูุณุชุฎุฏู ูุน ุชุญุฏูุฏ ุงููุทุงู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ค ุฅูุดุงุก ุญุณุงุจ ูุณุชุฎุฏู ุฌุฏูุฏ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ ุงูุงุณู ุงููุงูู:     [ุฃุญูุฏ ูุญูุฏ ุนูู                    ]           โ
โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: [ahmed@company.com                ]           โ
โ ุฑูู ุงููุงุชู:       [777123456                        ]           โ
โ                                                                  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                  โ
โ ุงูุฏูุฑ:            [ูุฏูุฑ ูุญุทุฉ                    โผ]              โ
โ                                                                  โ
โ ูุทุงู ุงูุตูุงุญูุงุช:   [ูุญุทุฉ                         โผ]              โ
โ                                                                  โ
โ ุชุญุฏูุฏ ุงููุญุทุฉ:     [ูุญุทุฉ G1 - ูุฑุน ุงูุญุฏูุฏุฉ        โผ]              โ
โ                                                                  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                  โ
โ ๐ ููุฎุต ุงูุตูุงุญูุงุช:                                              โ
โ โข ุณูุฑู ููุท ุจูุงูุงุช ูุญุทุฉ G1                                       โ
โ โข ููููู ุฅูุดุงุก ุฎุทุท ุนูู ูููุญุทุฉ                                    โ
โ โข ููููู ุฅุฏุงุฑุฉ ููุธูู ุงููุญุทุฉ                                      โ
โ โข ูุง ููููู ุฑุคูุฉ ูุญุทุงุช ุฃุฎุฑู                                      โ
โ                                                                  โ
โ                              [ุฅูุบุงุก]  [๐พ ุญูุธ]                   โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 16.6 APIs ุฅุฏุงุฑุฉ ุงููููู ุงูุชูุธููู

```
# ุงูุดุฑูุงุช
GET    /api/v1/companies                    - ูุงุฆูุฉ ุงูุดุฑูุงุช
POST   /api/v1/companies                    - ุฅูุดุงุก ุดุฑูุฉ
GET    /api/v1/companies/:id                - ุชูุงุตูู ุดุฑูุฉ
PUT    /api/v1/companies/:id                - ุชุญุฏูุซ ุดุฑูุฉ

# ุงููุฑูุน
GET    /api/v1/branches                     - ูุงุฆูุฉ ุงููุฑูุน (ูููุชุฑุฉ)
POST   /api/v1/branches                     - ุฅูุดุงุก ูุฑุน
GET    /api/v1/branches/:id                 - ุชูุงุตูู ูุฑุน
PUT    /api/v1/branches/:id                 - ุชุญุฏูุซ ูุฑุน
GET    /api/v1/branches/:id/stations        - ูุญุทุงุช ุงููุฑุน
GET    /api/v1/branches/:id/stats           - ุฅุญุตุงุฆูุงุช ุงููุฑุน

# ุงููููู ุงูุชูุธููู
GET    /api/v1/organization/tree            - ุดุฌุฑุฉ ุงููููู ุงููุงููุฉ
GET    /api/v1/organization/my-scope        - ูุทุงู ุงููุณุชุฎุฏู ุงูุญุงูู

# ูุทุงูุงุช ุงููุณุชุฎุฏููู
GET    /api/v1/users/:id/scopes             - ูุทุงูุงุช ูุณุชุฎุฏู
POST   /api/v1/users/:id/scopes             - ุฅุถุงูุฉ ูุทุงู
DELETE /api/v1/users/:id/scopes/:scope_id   - ุญุฐู ูุทุงู
```

### 16.7 Middleware ููุชุฑุฉ ุงูุจูุงูุงุช

```python
# middleware/scope_filter.py

class ScopeFilterMiddleware:
    """
    Middleware ูุชุทุจูู ููุชุฑุฉ ุงูุจูุงูุงุช ุชููุงุฆูุงู
    ุนูู ูู ุงุณุชุนูุงู ุญุณุจ ุตูุงุญูุงุช ุงููุณุชุฎุฏู
    """
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # ุงูุญุตูู ุนูู ุงููุณุชุฎุฏู ุงูุญุงูู
        user = request.user
        
        if user.is_authenticated:
            # ุงูุญุตูู ุนูู ุงููุญุทุงุช ุงููุณููุญุฉ
            allowed_stations = get_user_allowed_stations(user.id)
            
            # ุชุฎุฒูู ูู ุงูุณูุงู
            request.allowed_stations = allowed_stations
            request.scope_type = user.primary_scope_type
            request.scope_id = user.primary_scope_id
        
        response = self.get_response(request)
        return response

# ุงุณุชุฎุฏุงู ูู ุงูู Views
class CustomerViewSet(viewsets.ModelViewSet):
    def get_queryset(self):
        # ููุชุฑุฉ ุชููุงุฆูุฉ ุญุณุจ ุงููุทุงู
        return Customer.objects.filter(
            station_id__in=self.request.allowed_stations
        )
```


---

# 12. ุตูุงุญูุงุช ุงูุชุญูู ูุงููุฑุงูุจุฉ (Control & Surveillance Permissions)

## 12.1 ูุฌููุนุฉ ุตูุงุญูุงุช ุงูุชุญูู ูู ุงููุนุฏุงุช

```sql
-- ุฅุถุงูุฉ ุตูุงุญูุงุช ุงูุชุญูู ูุฌุฏูู ุงูุตูุงุญูุงุช
INSERT INTO permissions (permission_code, permission_name_ar, permission_name_en, module, description) VALUES
-- ุงูุชุญูู ูู ุงููููุฏุงุช
('control_generators', 'ุงูุชุญูู ูู ุงููููุฏุงุช', 'Control Generators', 'equipment_control', 'ุชุดุบูู ูุฅููุงู ุงููููุฏุงุช ุนู ุจุนุฏ'),
('control_generators_start', 'ุชุดุบูู ุงููููุฏุงุช', 'Start Generators', 'equipment_control', 'ุตูุงุญูุฉ ุชุดุบูู ุงููููุฏุงุช'),
('control_generators_stop', 'ุฅููุงู ุงููููุฏุงุช', 'Stop Generators', 'equipment_control', 'ุตูุงุญูุฉ ุฅููุงู ุงููููุฏุงุช'),
('control_generators_mode', 'ุชุบููุฑ ูุถุน ุงููููุฏุงุช', 'Change Generator Mode', 'equipment_control', 'ุชุบููุฑ ุงููุถุน ุจูู ุชููุงุฆู ููุฏูู'),

-- ุงูุชุญูู ูู ุงูููุงุทุน
('control_breakers', 'ุงูุชุญูู ูู ุงูููุงุทุน', 'Control Breakers', 'equipment_control', 'ูุชุญ ูุฅุบูุงู ุงูููุงุทุน ุนู ุจุนุฏ'),
('control_breakers_open', 'ูุชุญ ุงูููุงุทุน', 'Open Breakers', 'equipment_control', 'ุตูุงุญูุฉ ูุชุญ ุงูููุงุทุน'),
('control_breakers_close', 'ุฅุบูุงู ุงูููุงุทุน', 'Close Breakers', 'equipment_control', 'ุตูุงุญูุฉ ุฅุบูุงู ุงูููุงุทุน'),

-- ุงูุชุญูู ูู ุงูุนุฏุงุฏุงุช
('control_meters', 'ุงูุชุญูู ูู ุงูุนุฏุงุฏุงุช', 'Control Meters', 'equipment_control', 'ูุตู ูุชูุตูู ุงูุนุฏุงุฏุงุช ุนู ุจุนุฏ'),
('control_meters_disconnect', 'ูุตู ุงูุนุฏุงุฏุงุช', 'Disconnect Meters', 'equipment_control', 'ุตูุงุญูุฉ ูุตู ุงูุนุฏุงุฏุงุช'),
('control_meters_reconnect', 'ุฅุนุงุฏุฉ ุชูุตูู ุงูุนุฏุงุฏุงุช', 'Reconnect Meters', 'equipment_control', 'ุตูุงุญูุฉ ุฅุนุงุฏุฉ ุงูุชูุตูู'),

-- ุงููุฑุงูุจุฉ ุจุงูููุฏูู
('view_cameras', 'ุนุฑุถ ุงููุงููุฑุงุช', 'View Cameras', 'surveillance', 'ูุดุงูุฏุฉ ุงูุจุซ ุงููุจุงุดุฑ ูููุงููุฑุงุช'),
('view_cameras_live', 'ุงูุจุซ ุงููุจุงุดุฑ', 'Live View', 'surveillance', 'ูุดุงูุฏุฉ ุงูุจุซ ุงููุจุงุดุฑ'),
('view_cameras_playback', 'ุนุฑุถ ุงูุชุณุฌููุงุช', 'Playback', 'surveillance', 'ูุดุงูุฏุฉ ุงูุชุณุฌููุงุช ุงูุณุงุจูุฉ'),
('control_cameras_ptz', 'ุงูุชุญูู ูู PTZ', 'Control PTZ', 'surveillance', 'ุงูุชุญูู ูู ุญุฑูุฉ ุงููุงููุฑุงุช'),
('export_video', 'ุชุตุฏูุฑ ุงูููุฏูู', 'Export Video', 'surveillance', 'ุชุตุฏูุฑ ููุงุทุน ุงูููุฏูู'),

-- ุณุฌู ุงูุชุฏููู
('view_audit_log', 'ุนุฑุถ ุณุฌู ุงูุชุฏููู', 'View Audit Log', 'audit', 'ุนุฑุถ ุณุฌู ุฃูุงูุฑ ุงูุชุญูู'),
('export_audit_log', 'ุชุตุฏูุฑ ุณุฌู ุงูุชุฏููู', 'Export Audit Log', 'audit', 'ุชุตุฏูุฑ ุณุฌู ุงูุชุฏููู');
```

## 12.2 ุชูุฒูุน ุงูุตูุงุญูุงุช ุนูู ุงูุฃุฏูุงุฑ

```sql
-- ูุฏูุฑ ุงููุญุทุฉ - ุตูุงุญูุงุช ูุงููุฉ
INSERT INTO role_permissions (role_id, permission_code) 
SELECT r.id, p.permission_code
FROM roles r, permissions p
WHERE r.role_code = 'station_manager'
AND p.module IN ('equipment_control', 'surveillance', 'audit');

-- ูุดุบู ุบุฑูุฉ ุงูุชุญูู - ุตูุงุญูุงุช ุชุดุบูููุฉ
INSERT INTO role_permissions (role_id, permission_code) 
SELECT r.id, p.permission_code
FROM roles r, permissions p
WHERE r.role_code = 'control_room_operator'
AND p.permission_code IN (
    'control_generators',
    'control_generators_start',
    'control_generators_stop',
    'control_generators_mode',
    'view_cameras',
    'view_cameras_live',
    'control_cameras_ptz',
    'view_audit_log'
);

-- ููู ุงูุตูุงูุฉ - ุตูุงุญูุงุช ูุญุฏูุฏุฉ
INSERT INTO role_permissions (role_id, permission_code) 
SELECT r.id, p.permission_code
FROM roles r, permissions p
WHERE r.role_code = 'maintenance_technician'
AND p.permission_code IN (
    'view_cameras',
    'view_cameras_live'
);

-- ููุธู ุฎุฏูุฉ ุงูุนููุงุก - ุตูุงุญูุงุช ุงูุนุฏุงุฏุงุช ููุท
INSERT INTO role_permissions (role_id, permission_code) 
SELECT r.id, p.permission_code
FROM roles r, permissions p
WHERE r.role_code = 'customer_service'
AND p.permission_code IN (
    'control_meters',
    'control_meters_disconnect',
    'control_meters_reconnect'
);
```

## 12.3 ูุตูููุฉ ุงูุตูุงุญูุงุช

| ุงูุตูุงุญูุฉ | ูุฏูุฑ ุงููุญุทุฉ | ูุดุบู ุงูุชุญูู | ููู ุงูุตูุงูุฉ | ุฎุฏูุฉ ุงูุนููุงุก |
|----------|-------------|-------------|-------------|--------------|
| ุชุดุบูู ุงููููุฏุงุช | โ | โ | โ | โ |
| ุฅููุงู ุงููููุฏุงุช | โ | โ | โ | โ |
| ูุชุญ/ุฅุบูุงู ุงูููุงุทุน | โ | โ | โ | โ |
| ูุตู ุงูุนุฏุงุฏุงุช | โ | โ | โ | โ |
| ุงูุจุซ ุงููุจุงุดุฑ | โ | โ | โ | โ |
| ุงูุชุณุฌููุงุช | โ | โ | โ | โ |
| ุชุญูู PTZ | โ | โ | โ | โ |
| ุณุฌู ุงูุชุฏููู | โ | โ | โ | โ |
| ุชุตุฏูุฑ ุงูุชุฏููู | โ | โ | โ | โ |

## 12.4 ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุจู ุชูููุฐ ุงูุฃูุงูุฑ

```sql
CREATE OR REPLACE FUNCTION check_control_permission(
    p_user_id UUID,
    p_command_code VARCHAR(50)
) RETURNS BOOLEAN AS $$
DECLARE
    v_required_permission VARCHAR(100);
    v_has_permission BOOLEAN;
BEGIN
    -- ุงูุญุตูู ุนูู ุงูุตูุงุญูุฉ ุงููุทููุจุฉ ููุฃูุฑ
    SELECT required_permission INTO v_required_permission
    FROM allowed_commands
    WHERE command_code = p_command_code
    AND is_active = true;
    
    IF v_required_permission IS NULL THEN
        RETURN false; -- ุงูุฃูุฑ ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ูุดุท
    END IF;
    
    -- ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู
    SELECT EXISTS (
        SELECT 1
        FROM user_roles ur
        JOIN role_permissions rp ON rp.role_id = ur.role_id
        WHERE ur.user_id = p_user_id
        AND rp.permission_code = v_required_permission
        AND ur.is_active = true
    ) INTO v_has_permission;
    
    RETURN v_has_permission;
END;
$$ LANGUAGE plpgsql;
```



---

## ๐ ููู 39: ุงุณุชุฑุงุชูุฌูุฉ ุชุฑุญูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ (Data Migration Strategy)

---

### 13. ูุญุฏุฉ ุชุฑุญูู ุงูุจูุงูุงุช

#### 13.1 ุงููุจุฏุฃ ุงูุฐูุจู

```
ุจูุงูุงุช ุชุงุฑูุฎูุฉ ุถุฎูุฉ (ููุฐ 2024)
    โ
ุชุฑุญูู ุดุงูู ูุฏููู
    โ
ูุธุงู ุฌุฏูุฏ ูุน ุณุฌู ุชุงุฑูุฎู ูุงูู
    โ
ูููุฉ ููุฑูุฉ ูุญููููุฉ ููุนูููุงุช
```

#### 13.2 ููุงุฐุง ุงูุชุฑุญูู ุฃููุงูุ

| ุจุฏูู ุชุฑุญูู | ูุน ุชุฑุญูู |
|------------|----------|
| โ ุงููุธุงู ูุจุฏุฃ ูุงุฑุบุงู | โ ุณุฌู ุชุงุฑูุฎู ูุงูู |
| โ ููุฏุงู ุงูุณุฌู ุงูุชุงุฑูุฎู | โ ุงุณุชูุฑุงุฑูุฉ ุงูุนูููุงุช |
| โ ุนุฏู ุงููุฏุฑุฉ ุนูู ุงูุชุญููู | โ ุชุญููู ุดุงูู ููุฃุฏุงุก |
| โ ุนุฏู ุงูุซูุฉ ูู ุงูุฅุฏุงุฑุฉ | โ ุซูุฉ ุนุงููุฉ |
| โ ููุฏุงู ุงูุจูุงูุงุช ุงููุงููููุฉ | โ ุงูุชุซุงู ูุงูููู |

---

### 13.3 ุฌุฏูู ูุดุงุฑูุน ุงูุชุฑุญูู: `migration_projects`

```sql
CREATE TABLE migration_projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_code VARCHAR(20) UNIQUE NOT NULL,
    project_name VARCHAR(200) NOT NULL,
    
    -- ุงููุตู
    description TEXT,
    source_system VARCHAR(100), -- ุงููุธุงู ุงููุตุฏุฑ
    target_module VARCHAR(100), -- ุงููุญุฏุฉ ุงููุณุชูุฏูุฉ
    
    -- ุงูุฌุฏูู ุงูุฒููู
    planned_start_date DATE,
    planned_end_date DATE,
    actual_start_date DATE,
    actual_end_date DATE,
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'planning',       -- ุงูุชุฎุทูุท
        'preparation',    -- ุงูุฅุนุฏุงุฏ
        'in_progress',    -- ููุฏ ุงูุชูููุฐ
        'validation',     -- ุงูุชุญูู
        'completed',      -- ููุชูู
        'failed',         -- ูุดู
        'cancelled'       -- ููุบู
    ) DEFAULT 'planning',
    
    -- ุงูุฅุญุตุงุฆูุงุช
    total_records INT DEFAULT 0,
    migrated_records INT DEFAULT 0,
    failed_records INT DEFAULT 0,
    progress_percentage DECIMAL(5,2) GENERATED ALWAYS AS (
        CASE WHEN total_records > 0 
        THEN (migrated_records * 100.0 / total_records)
        ELSE 0 END
    ) STORED,
    
    -- ุงููุณุคูู
    project_manager_id UUID REFERENCES users(id),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 13.4 ุฌุฏูู ูุฑุงุญู ุงูุชุฑุญูู: `migration_phases`

```sql
CREATE TABLE migration_phases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES migration_projects(id),
    phase_number INT NOT NULL,
    phase_name VARCHAR(100) NOT NULL,
    
    -- ุงููุตู
    description TEXT,
    
    -- ุงูุฌุฏูู ุงูุฒููู
    planned_start_date DATE,
    planned_end_date DATE,
    actual_start_date DATE,
    actual_end_date DATE,
    
    -- ุงูุญุงูุฉ
    status ENUM('pending', 'in_progress', 'completed', 'failed') DEFAULT 'pending',
    
    -- ุงูููุงุญุธุงุช
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(project_id, phase_number)
);

-- ุงููุฑุงุญู ุงูุงูุชุฑุงุถูุฉ
-- ุงููุฑุญูุฉ 1: ุงูุชุญููู ูุงูุชุฎุทูุท (ุงูุฃุณุงุจูุน 1-4)
-- ุงููุฑุญูุฉ 2: ุงูุฅุนุฏุงุฏ ูุงูุชูุธูู (ุงูุฃุณุงุจูุน 5-8)
-- ุงููุฑุญูุฉ 3: ุงูุชุฑุญูู ุงููุนูู (ุงูุฃุณุงุจูุน 9-12)
-- ุงููุฑุญูุฉ 4: ุงูุชุญูู ูุงููุทุงุจูุฉ (ุงูุฃุณุงุจูุน 13-16)
```

#### 13.5 ุฌุฏูู ููุงูุจ ุงูุงุณุชูุฑุงุฏ: `import_templates`

```sql
CREATE TABLE import_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_code VARCHAR(20) UNIQUE NOT NULL,
    template_name VARCHAR(100) NOT NULL,
    
    -- ุงููุฏู
    target_table VARCHAR(100) NOT NULL,
    target_module VARCHAR(50) NOT NULL,
    
    -- ุงูุฃุนูุฏุฉ
    columns JSONB NOT NULL, -- ุชุนุฑูู ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
    /*
    ูุซุงู:
    [
        {"name": "customer_number", "type": "string", "required": true, "max_length": 20},
        {"name": "name", "type": "string", "required": true, "max_length": 200},
        {"name": "phone", "type": "string", "required": false, "format": "phone"},
        {"name": "balance", "type": "decimal", "required": false, "default": 0}
    ]
    */
    
    -- ููุงุนุฏ ุงูุชุญูู
    validation_rules JSONB,
    /*
    ูุซุงู:
    {
        "unique_fields": ["customer_number"],
        "required_fields": ["customer_number", "name"],
        "foreign_keys": {"tariff_code": "tariffs.code"}
    }
    */
    
    -- ููู ุงููุงูุจ
    template_file_path VARCHAR(500),
    sample_file_path VARCHAR(500),
    
    -- ุงูุชุนูููุงุช
    instructions TEXT,
    
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ููุงูุจ ุงูุงุณุชูุฑุงุฏ ุงูุงูุชุฑุงุถูุฉ
INSERT INTO import_templates (template_code, template_name, target_table, target_module, columns) VALUES
('IMP_CUSTOMERS', 'ุงุณุชูุฑุงุฏ ุงูุนููุงุก', 'customers', 'customers', '[
    {"name": "customer_number", "type": "string", "required": true},
    {"name": "name", "type": "string", "required": true},
    {"name": "customer_type", "type": "enum", "required": true, "values": ["residential", "commercial", "industrial"]},
    {"name": "phone", "type": "string", "required": false},
    {"name": "mobile", "type": "string", "required": true},
    {"name": "address", "type": "string", "required": false},
    {"name": "meter_number", "type": "string", "required": false},
    {"name": "current_balance", "type": "decimal", "required": false}
]'),
('IMP_SUPPLIERS', 'ุงุณุชูุฑุงุฏ ุงูููุฑุฏูู', 'suppliers', 'inventory', '[
    {"name": "supplier_code", "type": "string", "required": true},
    {"name": "name", "type": "string", "required": true},
    {"name": "supplier_type", "type": "enum", "required": true, "values": ["company", "individual"]},
    {"name": "phone", "type": "string", "required": false},
    {"name": "email", "type": "string", "required": false},
    {"name": "tax_number", "type": "string", "required": false}
]'),
('IMP_ITEMS', 'ุงุณุชูุฑุงุฏ ุงูุฃุตูุงู', 'inventory_items', 'inventory', '[
    {"name": "item_code", "type": "string", "required": true},
    {"name": "name", "type": "string", "required": true},
    {"name": "category", "type": "string", "required": true},
    {"name": "unit", "type": "string", "required": true},
    {"name": "current_quantity", "type": "decimal", "required": false},
    {"name": "unit_cost", "type": "decimal", "required": false}
]'),
('IMP_ASSETS', 'ุงุณุชูุฑุงุฏ ุงูุฃุตูู', 'assets', 'assets', '[
    {"name": "asset_code", "type": "string", "required": true},
    {"name": "name", "type": "string", "required": true},
    {"name": "asset_type", "type": "string", "required": true},
    {"name": "location", "type": "string", "required": false},
    {"name": "purchase_date", "type": "date", "required": false},
    {"name": "purchase_cost", "type": "decimal", "required": false}
]'),
('IMP_INVOICES', 'ุงุณุชูุฑุงุฏ ุงูููุงุชูุฑ ุงูุชุงุฑูุฎูุฉ', 'invoices', 'billing', '[
    {"name": "invoice_number", "type": "string", "required": true},
    {"name": "customer_number", "type": "string", "required": true},
    {"name": "invoice_date", "type": "date", "required": true},
    {"name": "due_date", "type": "date", "required": true},
    {"name": "total_amount", "type": "decimal", "required": true},
    {"name": "paid_amount", "type": "decimal", "required": false},
    {"name": "status", "type": "enum", "required": true, "values": ["paid", "partial", "pending", "overdue"]}
]'),
('IMP_JOURNAL', 'ุงุณุชูุฑุงุฏ ุงููููุฏ ุงููุญุงุณุจูุฉ', 'journal_entries', 'accounting', '[
    {"name": "entry_number", "type": "string", "required": true},
    {"name": "entry_date", "type": "date", "required": true},
    {"name": "description", "type": "string", "required": true},
    {"name": "account_code", "type": "string", "required": true},
    {"name": "debit", "type": "decimal", "required": false},
    {"name": "credit", "type": "decimal", "required": false}
]');
```

#### 13.6 ุฌุฏูู ุนูููุงุช ุงูุงุณุชูุฑุงุฏ: `import_jobs`

```sql
CREATE TABLE import_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_number VARCHAR(30) UNIQUE NOT NULL,
    
    -- ุงููุงูุจ ูุงููุดุฑูุน
    template_id UUID NOT NULL REFERENCES import_templates(id),
    project_id UUID REFERENCES migration_projects(id),
    
    -- ุงูููู
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INT,
    
    -- ุงูุฅุญุตุงุฆูุงุช
    total_rows INT DEFAULT 0,
    processed_rows INT DEFAULT 0,
    success_rows INT DEFAULT 0,
    error_rows INT DEFAULT 0,
    skipped_rows INT DEFAULT 0,
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'uploaded',       -- ุชู ุงูุฑูุน
        'validating',     -- ููุฏ ุงูุชุญูู
        'validated',      -- ุชู ุงูุชุญูู
        'importing',      -- ููุฏ ุงูุงุณุชูุฑุงุฏ
        'completed',      -- ููุชูู
        'failed',         -- ูุดู
        'cancelled'       -- ููุบู
    ) DEFAULT 'uploaded',
    
    -- ุงูุชูููุช
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- ุงูุฃุฎุทุงุก
    error_log_path VARCHAR(500),
    
    -- ุงููุณุชุฎุฏู
    created_by UUID REFERENCES users(id),
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 13.7 ุฌุฏูู ุฃุฎุทุงุก ุงูุงุณุชูุฑุงุฏ: `import_errors`

```sql
CREATE TABLE import_errors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_id UUID NOT NULL REFERENCES import_jobs(id),
    
    -- ูููุน ุงูุฎุทุฃ
    row_number INT NOT NULL,
    column_name VARCHAR(100),
    
    -- ุชูุงุตูู ุงูุฎุทุฃ
    error_type ENUM(
        'validation',     -- ุฎุทุฃ ุชุญูู
        'duplicate',      -- ููุฑุฑ
        'foreign_key',    -- ููุชุงุญ ุฃุฌูุจู ุบูุฑ ููุฌูุฏ
        'format',         -- ุตูุบุฉ ุฎุงุทุฆุฉ
        'required',       -- ุญูู ูุทููุจ ูุงุฑุบ
        'database',       -- ุฎุทุฃ ูุงุนุฏุฉ ุจูุงูุงุช
        'unknown'         -- ุบูุฑ ูุนุฑูู
    ) NOT NULL,
    error_message TEXT NOT NULL,
    
    -- ุงูุจูุงูุงุช
    row_data JSONB,
    
    -- ุงูุญู
    is_resolved BOOLEAN DEFAULT FALSE,
    resolution TEXT,
    resolved_by UUID REFERENCES users(id),
    resolved_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 13.8 Function: ูุนุงูุฌุฉ ููู ุงูุงุณุชูุฑุงุฏ

```sql
CREATE OR REPLACE FUNCTION process_import_job(p_job_id UUID)
RETURNS JSONB AS $$
DECLARE
    v_template RECORD;
    v_job RECORD;
    v_result JSONB;
BEGIN
    -- ุฌูุจ ุจูุงูุงุช ุงููููุฉ ูุงููุงูุจ
    SELECT j.*, t.target_table, t.columns, t.validation_rules
    INTO v_job
    FROM import_jobs j
    JOIN import_templates t ON j.template_id = t.id
    WHERE j.id = p_job_id;
    
    -- ุชุญุฏูุซ ุงูุญุงูุฉ
    UPDATE import_jobs SET status = 'importing', started_at = NOW() WHERE id = p_job_id;
    
    -- ุงููุนุงูุฌุฉ ุชุชู ุนุจุฑ Python/Application Layer
    -- ูุฐู ุงูุฏุงูุฉ ููุชุชุจุน ููุท
    
    v_result := jsonb_build_object(
        'job_id', p_job_id,
        'status', 'processing',
        'message', 'Import job started'
    );
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

#### 13.9 ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุชุฑุญูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุฅุฏุงุฑุฉ ุชุฑุญูู ุงูุจูุงูุงุช                                    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ุงููุดุงุฑูุน ุงููุดุทุฉ:                                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงููุดุฑูุน | ุงูุญุงูุฉ | ุงูุชูุฏู | ุงูุจุฏุงูุฉ | ุงูููุงูุฉ    โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ ุชุฑุญูู ุงูุนููุงุก | ููุฏ ุงูุชูููุฐ | 75% | 01/12 | 15/12โ  โ
โ โ ุชุฑุญูู ุงูููุฑุฏูู | ููุชูู | 100% | 15/11 | 30/11   โ  โ
โ โ ุชุฑุญูู ุงููุฎุฒูู | ุงูุชุฎุทูุท | 0% | 01/01 | 31/01    โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [+ ูุดุฑูุน ุฌุฏูุฏ] [๐ ุชูุฑูุฑ ุดุงูู]                         โ
โ                                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ููุงูุจ ุงูุงุณุชูุฑุงุฏ ุงููุชุงุญุฉ:                                โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงููุงูุจ | ุงููุญุฏุฉ | ุขุฎุฑ ุงุณุชุฎุฏุงู | [ุชุญููู] [ุงุณุชูุฑุงุฏ]โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ ุงุณุชูุฑุงุฏ ุงูุนููุงุก | ุงูุนููุงุก | 10/12/2025 | ๐ฅ ๐ค  โ  โ
โ โ ุงุณุชูุฑุงุฏ ุงูููุฑุฏูู | ุงููุดุชุฑูุงุช | 05/12/2025 | ๐ฅ ๐คโ  โ
โ โ ุงุณุชูุฑุงุฏ ุงูุฃุตูุงู | ุงููุฎุฒูู | - | ๐ฅ ๐ค           โ  โ
โ โ ุงุณุชูุฑุงุฏ ุงูุฃุตูู | ุงูุฃุตูู | - | ๐ฅ ๐ค             โ  โ
โ โ ุงุณุชูุฑุงุฏ ุงูููุงุชูุฑ | ุงูููุชุฑุฉ | - | ๐ฅ ๐ค          โ  โ
โ โ ุงุณุชูุฑุงุฏ ุงููููุฏ | ุงููุญุงุณุจุฉ | - | ๐ฅ ๐ค           โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 13.10 ุดุงุดุฉ ุงุณุชูุฑุงุฏ ููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงุณุชูุฑุงุฏ ุงูุนููุงุก                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ุงูุฎุทูุฉ 1: ุฑูุน ุงูููู                                     โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ                                                    โ  โ
โ โ     ๐ ุงุณุญุจ ููู Excel ููุง ุฃู ุงุถุบุท ููุงุฎุชูุงุฑ       โ  โ
โ โ                                                    โ  โ
โ โ     ุงูุตูุบ ุงููุฏุนููุฉ: .xlsx, .xls, .csv            โ  โ
โ โ                                                    โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ฅ ุชุญููู ูุงูุจ ูุงุฑุบ] [๐ ุชุญููู ููู ูููุฐุฌู]            โ
โ                                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ุงูุฎุทูุฉ 2: ูุนุงููุฉ ุงูุจูุงูุงุช                               โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ # | ุฑูู ุงูุนููู | ุงูุงุณู | ุงูููุน | ุงูุฌูุงู | ุงูุฑุตูุฏโ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ 1 | C001 | ูุญูุฏ ุนูู | ุณููู | 777123456 | 5000  โ  โ
โ โ 2 | C002 | ุฃุญูุฏ ูุญูุฏ | ุชุฌุงุฑู | 777654321 | 0   โ  โ
โ โ 3 | C003 | โ๏ธ ุฎุทุฃ | - | - | -                   โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุฅุฌูุงูู ุงูุตููู: 1,500 | ุตุงูุญุฉ: 1,498 | ุฃุฎุทุงุก: 2        โ
โ                                                          โ
โ [ุนุฑุถ ุงูุฃุฎุทุงุก] [ุชุตุญูุญ ุงูุฃุฎุทุงุก] [โถ๏ธ ุจุฏุก ุงูุงุณุชูุฑุงุฏ]      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 13.11 ุฃููููุงุช ุงูุชุฑุญูู

| ุงูุฃููููุฉ | ุงูุจูุงูุงุช | ุงูุณุจุจ |
|----------|----------|-------|
| **1 - ุญุฑุฌุฉ** | ุงูุจูุงูุงุช ุงููุงููุฉ (ุงูููุงุชูุฑุ ุงููุฏููุนุงุชุ ุงูุฃุฑุตุฏุฉ) | ุฃุณุงุณ ุงูุนูููุงุช ุงูููููุฉ |
| **2 - ุนุงููุฉ** | ุงูุฃุตูู ูุงููุฎุฒูู | ุถุฑูุฑู ููุตูุงูุฉ ูุงูุชุดุบูู |
| **3 - ูุชูุณุทุฉ** | ุงูุนููุงุก ูุงูููุฑุฏูู | ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ |
| **4 - ููุฎูุถุฉ** | ุงูุชูุงุฑูุฑ ูุงููุซุงุฆู ุงูุชุงุฑูุฎูุฉ | ููุฃุฑุดูุฉ ูุงููุฑุฌุนูุฉ |

#### 13.12 ุงูุฌุฏูู ุงูุฒููู ุงูุฅุฌูุงูู

```
ุงูุฃุณุงุจูุน 1-4:   ุงูุชุญููู ูุงูุชุฎุทูุท
                โโ ุชุญุฏูุฏ ุงูุจูุงูุงุช ุงููุทููุจ ุชุฑุญูููุง
                โโ ููู ุงูุจููุฉ ุงูุญุงููุฉ
                โโ ุชุตููู ุฎุฑูุทุฉ ุงูุชุฑุญูู
                โโ ุฅุนุฏุงุฏ ุฃุฏูุงุช ุงูุงุณุชูุฑุงุฏ

ุงูุฃุณุงุจูุน 5-8:   ุงูุฅุนุฏุงุฏ ูุงูุชูุธูู
                โโ ุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ
                โโ ุชูุญูุฏ ุงูุตูุบ ูุงููุนุงููุฑ
                โโ ุฅูุดุงุก ููุงูุจ ุงูุงุณุชูุฑุงุฏ
                โโ ุงุฎุชุจุงุฑ ุงูุนูููุงุช

ุงูุฃุณุงุจูุน 9-12:  ุงูุชุฑุญูู ุงููุนูู
                โโ ุชุฑุญูู ุงูุจูุงูุงุช ุงููุงููุฉ
                โโ ุชุฑุญูู ุจูุงูุงุช ุงููุฎุฒูู ูุงูุฃุตูู
                โโ ุชุฑุญูู ุณุฌูุงุช ุงูุนููุงุก ูุงูููุฑุฏูู
                โโ ุชุฑุญูู ุงูุณุฌูุงุช ุงูุชุงุฑูุฎูุฉ

ุงูุฃุณุงุจูุน 13-16: ุงูุชุญูู ูุงููุทุงุจูุฉ
                โโ ุงูุชุญูู ูู ุฏูุฉ ุงูุจูุงูุงุช
                โโ ุงููุทุงุจูุฉ ูุน ุงูุณุฌูุงุช ุงููุฏููุฉ
                โโ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุงูุชูุงูุถุงุช
                โโ ุงูููุงููุฉ ุงูููุงุฆูุฉ

ุงููุฌููุน: 16 ุฃุณุจูุน (4 ุฃุดูุฑ)
```

#### 13.13 APIs ุชุฑุญูู ุงูุจูุงูุงุช

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/migration/projects` | ูุงุฆูุฉ ูุดุงุฑูุน ุงูุชุฑุญูู |
| POST | `/api/v1/migration/projects` | ุฅูุดุงุก ูุดุฑูุน ุฌุฏูุฏ |
| GET | `/api/v1/migration/templates` | ููุงูุจ ุงูุงุณุชูุฑุงุฏ |
| GET | `/api/v1/migration/templates/{id}/download` | ุชุญููู ูุงูุจ |
| POST | `/api/v1/migration/import` | ุฑูุน ููู ููุงุณุชูุฑุงุฏ |
| GET | `/api/v1/migration/import/{id}/validate` | ุงูุชุญูู ูู ุงูููู |
| POST | `/api/v1/migration/import/{id}/execute` | ุชูููุฐ ุงูุงุณุชูุฑุงุฏ |
| GET | `/api/v1/migration/import/{id}/errors` | ุฃุฎุทุงุก ุงูุงุณุชูุฑุงุฏ |
| GET | `/api/v1/migration/import/{id}/report` | ุชูุฑูุฑ ุงูุงุณุชูุฑุงุฏ |



---

## ๐ ููู 39 (ุชูููุฉ): ุชูุงุฑูุฑ ุงูููุงุฑูุฉ ููุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุงูู

---

### 12. ุชูุฑูุฑ ุงูููุงุฑูุฉ ุงูุดูุฑูุฉ

#### 12.1 View: ุงูููุงุฑูุฉ ุงูุดูุฑูุฉ ููุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช

```sql
CREATE OR REPLACE VIEW monthly_comparison_report AS
WITH monthly_data AS (
    SELECT 
        DATE_TRUNC('month', je.entry_date) AS month_date,
        EXTRACT(YEAR FROM je.entry_date) AS year,
        EXTRACT(MONTH FROM je.entry_date) AS month,
        
        -- ุงูุฅูุฑุงุฏุงุช
        SUM(CASE WHEN a.account_type = 'revenue' THEN jel.credit - jel.debit ELSE 0 END) AS revenue,
        
        -- ุงููุตุฑููุงุช
        SUM(CASE WHEN a.account_type = 'expense' THEN jel.debit - jel.credit ELSE 0 END) AS expenses,
        
        -- ุชูููุฉ ุงูุจุถุงุฆุน ุงููุจุงุนุฉ
        SUM(CASE WHEN a.account_code LIKE '5%' THEN jel.debit - jel.credit ELSE 0 END) AS cogs
        
    FROM journal_entries je
    JOIN journal_entry_lines jel ON je.id = jel.journal_entry_id
    JOIN chart_of_accounts a ON jel.account_id = a.id
    WHERE je.status = 'posted'
    GROUP BY DATE_TRUNC('month', je.entry_date), 
             EXTRACT(YEAR FROM je.entry_date), 
             EXTRACT(MONTH FROM je.entry_date)
)
SELECT 
    month_date,
    year,
    month,
    TO_CHAR(month_date, 'YYYY-MM') AS period,
    TO_CHAR(month_date, 'Month YYYY') AS period_name,
    revenue,
    cogs,
    (revenue - cogs) AS gross_profit,
    expenses,
    (revenue - cogs - expenses) AS net_profit,
    
    -- ูุณุจ ุงูุฑุจุญูุฉ
    ROUND((revenue - cogs) * 100.0 / NULLIF(revenue, 0), 2) AS gross_margin_pct,
    ROUND((revenue - cogs - expenses) * 100.0 / NULLIF(revenue, 0), 2) AS net_margin_pct,
    
    -- ููุงุฑูุฉ ูุน ุงูุดูุฑ ุงูุณุงุจู
    LAG(revenue) OVER (ORDER BY month_date) AS prev_month_revenue,
    LAG(expenses) OVER (ORDER BY month_date) AS prev_month_expenses,
    
    -- ูุณุจุฉ ุงูุชุบูุฑ
    ROUND((revenue - LAG(revenue) OVER (ORDER BY month_date)) * 100.0 / 
          NULLIF(LAG(revenue) OVER (ORDER BY month_date), 0), 2) AS revenue_change_pct,
    ROUND((expenses - LAG(expenses) OVER (ORDER BY month_date)) * 100.0 / 
          NULLIF(LAG(expenses) OVER (ORDER BY month_date), 0), 2) AS expenses_change_pct
          
FROM monthly_data
ORDER BY month_date DESC;
```

#### 12.2 Function: ุชูุฑูุฑ ุงูููุงุฑูุฉ ุงูุณูููุฉ

```sql
CREATE OR REPLACE FUNCTION get_yearly_comparison(p_year INTEGER DEFAULT EXTRACT(YEAR FROM CURRENT_DATE))
RETURNS JSONB AS $$
BEGIN
    RETURN (
        SELECT jsonb_build_object(
            'year', p_year,
            'months', jsonb_agg(
                jsonb_build_object(
                    'month', month,
                    'period', period_name,
                    'revenue', revenue,
                    'expenses', expenses,
                    'gross_profit', gross_profit,
                    'net_profit', net_profit,
                    'gross_margin', gross_margin_pct,
                    'net_margin', net_margin_pct,
                    'revenue_change', revenue_change_pct
                ) ORDER BY month
            ),
            'totals', jsonb_build_object(
                'total_revenue', SUM(revenue),
                'total_expenses', SUM(expenses),
                'total_gross_profit', SUM(gross_profit),
                'total_net_profit', SUM(net_profit),
                'avg_gross_margin', ROUND(AVG(gross_margin_pct), 2),
                'avg_net_margin', ROUND(AVG(net_margin_pct), 2)
            ),
            'comparison_with_last_year', (
                SELECT jsonb_build_object(
                    'last_year_revenue', SUM(revenue),
                    'last_year_expenses', SUM(expenses),
                    'revenue_growth', ROUND(
                        (SUM(CASE WHEN year = p_year THEN revenue ELSE 0 END) - 
                         SUM(CASE WHEN year = p_year - 1 THEN revenue ELSE 0 END)) * 100.0 /
                        NULLIF(SUM(CASE WHEN year = p_year - 1 THEN revenue ELSE 0 END), 0), 2
                    )
                )
                FROM monthly_comparison_report
                WHERE year IN (p_year, p_year - 1)
            )
        )
        FROM monthly_comparison_report
        WHERE year = p_year
    );
END;
$$ LANGUAGE plpgsql;
```

#### 12.3 ุดุงุดุฉ ุงูููุงุฑูุฉ ุงูุดูุฑูุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุชูุฑูุฑ ุงูููุงุฑูุฉ ุงูุดูุฑูุฉ - 2025                           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                          โ
โ ุงูุฑุณู ุงูุจูุงูู:                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ     โโโโ                                           โ  โ
โ โ     โโโโ โโโโ                                      โ  โ
โ โ โโโโ โโโโ โโโโ โโโโ                               โ  โ
โ โ โโโโ โโโโ โโโโ โโโโ โโโโ โโโโ โโโโ โโโโ โโโโ โโโโ โ  โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ  โ
โ โ ููุงูุฑ ูุจุฑุงูุฑ ูุงุฑุณ ุฃุจุฑูู ูุงูู ููููู ููููู ุฃุบุณุทุณ ุณุจุชูุจุฑ โ  โ
โ โ โ ุงูุฅูุฑุงุฏุงุช  โ ุงููุตุฑููุงุช  โ ุตุงูู ุงูุฑุจุญ           โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุฌุฏูู ุงูููุงุฑูุฉ:                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ุงูุดูุฑ | ุงูุฅูุฑุงุฏุงุช | ุงููุตุฑููุงุช | ุงูุฑุจุญ | ุงูุชุบูุฑ%  โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ โ ุฏูุณูุจุฑ | 500,000 | 350,000 | 150,000 | +8%      โ  โ
โ โ ููููุจุฑ | 465,000 | 320,000 | 145,000 | +5%      โ  โ
โ โ ุฃูุชูุจุฑ | 440,000 | 310,000 | 130,000 | +3%      โ  โ
โ โ ... | ... | ... | ... | ...                      โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ููุงุฑูุฉ ูุน ุงูุนุงู ุงูุณุงุจู:                                 โ
โ โโ ุฅูุฑุงุฏุงุช 2025: 5,200,000 ุฑ.ู (+15% ุนู 2024)       โ
โ โโ ูุตุฑููุงุช 2025: 3,800,000 ุฑ.ู (+10% ุนู 2024)       โ
โ โโ ุตุงูู ุงูุฑุจุญ: 1,400,000 ุฑ.ู (+25% ุนู 2024)         โ
โ                                                          โ
โ [๐ ุชุตุฏูุฑ Excel] [๐ ุชุตุฏูุฑ PDF] [๐ ุชุญุฏูุซ]            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 13. ููุญุฉ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุงูู (Financial KPIs Dashboard)

#### 13.1 ุฌุฏูู ูุคุดุฑุงุช ุงูุฃุฏุงุก

```sql
CREATE TABLE financial_kpis (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kpi_code VARCHAR(50) UNIQUE NOT NULL,
    kpi_name VARCHAR(100) NOT NULL,
    kpi_name_en VARCHAR(100),
    category VARCHAR(50) NOT NULL, -- profitability, liquidity, efficiency, collection
    formula TEXT NOT NULL,
    target_value DECIMAL(15,4),
    warning_threshold DECIMAL(15,4),
    critical_threshold DECIMAL(15,4),
    unit VARCHAR(20) DEFAULT '%', -- %, days, ratio, currency
    is_higher_better BOOLEAN DEFAULT TRUE,
    display_order INTEGER,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ุฅุฏุฑุงุฌ ุงููุคุดุฑุงุช ุงูุฃุณุงุณูุฉ
INSERT INTO financial_kpis (kpi_code, kpi_name, kpi_name_en, category, formula, target_value, warning_threshold, critical_threshold, unit, is_higher_better, display_order) VALUES
-- ูุคุดุฑุงุช ุงูุฑุจุญูุฉ
('GROSS_MARGIN', 'ูุงูุด ุงูุฑุจุญ ุงูุฅุฌูุงูู', 'Gross Profit Margin', 'profitability', '(revenue - cogs) / revenue * 100', 40, 30, 20, '%', TRUE, 1),
('NET_MARGIN', 'ูุงูุด ุงูุฑุจุญ ุงูุตุงูู', 'Net Profit Margin', 'profitability', 'net_profit / revenue * 100', 15, 10, 5, '%', TRUE, 2),
('ROA', 'ุงูุนุงุฆุฏ ุนูู ุงูุฃุตูู', 'Return on Assets', 'profitability', 'net_profit / total_assets * 100', 10, 7, 5, '%', TRUE, 3),

-- ูุคุดุฑุงุช ุงูุณูููุฉ
('CURRENT_RATIO', 'ูุณุจุฉ ุงูุชุฏุงูู', 'Current Ratio', 'liquidity', 'current_assets / current_liabilities', 2, 1.5, 1, 'ratio', TRUE, 4),
('QUICK_RATIO', 'ูุณุจุฉ ุงูุณูููุฉ ุงูุณุฑูุนุฉ', 'Quick Ratio', 'liquidity', '(current_assets - inventory) / current_liabilities', 1, 0.8, 0.5, 'ratio', TRUE, 5),

-- ูุคุดุฑุงุช ุงูููุงุกุฉ
('INVENTORY_TURNOVER', 'ูุนุฏู ุฏูุฑุงู ุงููุฎุฒูู', 'Inventory Turnover', 'efficiency', 'cogs / average_inventory', 6, 4, 2, 'times', TRUE, 6),
('RECEIVABLES_TURNOVER', 'ูุนุฏู ุฏูุฑุงู ุงูุฐูู', 'Receivables Turnover', 'efficiency', 'revenue / average_receivables', 8, 6, 4, 'times', TRUE, 7),

-- ูุคุดุฑุงุช ุงูุชุญุตูู
('COLLECTION_RATE', 'ูุณุจุฉ ุงูุชุญุตูู', 'Collection Rate', 'collection', 'collected / billed * 100', 95, 85, 75, '%', TRUE, 8),
('DSO', 'ุฃูุงู ุงูุชุญุตูู', 'Days Sales Outstanding', 'collection', 'average_receivables / (revenue / 365)', 30, 45, 60, 'days', FALSE, 9),
('OVERDUE_RATE', 'ูุณุจุฉ ุงููุชุฃุฎุฑุงุช', 'Overdue Rate', 'collection', 'overdue_amount / total_receivables * 100', 5, 10, 20, '%', FALSE, 10);
```

#### 13.2 ุฌุฏูู ููู ุงููุคุดุฑุงุช

```sql
CREATE TABLE financial_kpi_values (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kpi_id UUID REFERENCES financial_kpis(id),
    period_type VARCHAR(20) NOT NULL, -- daily, weekly, monthly, quarterly, yearly
    period_date DATE NOT NULL,
    calculated_value DECIMAL(15,4) NOT NULL,
    status VARCHAR(20) DEFAULT 'normal', -- normal, warning, critical
    trend VARCHAR(20), -- up, down, stable
    previous_value DECIMAL(15,4),
    change_percentage DECIMAL(10,4),
    calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(kpi_id, period_type, period_date)
);

CREATE INDEX idx_kpi_values_period ON financial_kpi_values(period_date, period_type);
```

#### 13.3 Function: ุญุณุงุจ ุงููุคุดุฑุงุช ุงููุงููุฉ

```sql
CREATE OR REPLACE FUNCTION calculate_financial_kpis(p_date DATE DEFAULT CURRENT_DATE)
RETURNS JSONB AS $$
DECLARE
    v_revenue DECIMAL(15,2);
    v_cogs DECIMAL(15,2);
    v_expenses DECIMAL(15,2);
    v_net_profit DECIMAL(15,2);
    v_total_assets DECIMAL(15,2);
    v_current_assets DECIMAL(15,2);
    v_current_liabilities DECIMAL(15,2);
    v_inventory DECIMAL(15,2);
    v_receivables DECIMAL(15,2);
    v_collected DECIMAL(15,2);
    v_billed DECIMAL(15,2);
    v_overdue DECIMAL(15,2);
    v_result JSONB;
BEGIN
    -- ุญุณุงุจ ุงูููู ูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ
    -- (ูุฐู ุงูููู ูุชู ุฌูุจูุง ูู Views ุงูุชูุงุฑูุฑ ุงููุงููุฉ)
    
    SELECT 
        COALESCE(SUM(CASE WHEN account_type = 'revenue' THEN balance ELSE 0 END), 0),
        COALESCE(SUM(CASE WHEN account_code LIKE '5%' THEN balance ELSE 0 END), 0),
        COALESCE(SUM(CASE WHEN account_type = 'expense' THEN balance ELSE 0 END), 0)
    INTO v_revenue, v_cogs, v_expenses
    FROM account_balances_view
    WHERE period_end = p_date;
    
    v_net_profit := v_revenue - v_cogs - v_expenses;
    
    -- ุญุณุงุจ ุงูุฃุตูู ูุงูุฎุตูู
    SELECT 
        COALESCE(SUM(CASE WHEN account_type = 'asset' THEN balance ELSE 0 END), 0),
        COALESCE(SUM(CASE WHEN account_type = 'asset' AND is_current = TRUE THEN balance ELSE 0 END), 0),
        COALESCE(SUM(CASE WHEN account_type = 'liability' AND is_current = TRUE THEN balance ELSE 0 END), 0)
    INTO v_total_assets, v_current_assets, v_current_liabilities
    FROM account_balances_view;
    
    -- ุญุณุงุจ ุงููุฎุฒูู ูุงูุฐูู
    SELECT COALESCE(SUM(total_value), 0) INTO v_inventory FROM inventory_summary;
    SELECT COALESCE(SUM(current_balance), 0) INTO v_receivables FROM customers WHERE current_balance > 0;
    SELECT COALESCE(SUM(over_90_days + days_61_90 + days_31_60 + days_1_30), 0) INTO v_overdue FROM accounts_receivable_aging;
    
    -- ุญุณุงุจ ุงูุชุญุตูู
    SELECT 
        COALESCE(SUM(total_amount), 0),
        COALESCE(SUM(paid_amount), 0)
    INTO v_billed, v_collected
    FROM invoices
    WHERE DATE_TRUNC('month', invoice_date) = DATE_TRUNC('month', p_date);
    
    -- ุจูุงุก ุงููุชูุฌุฉ
    v_result := jsonb_build_object(
        'date', p_date,
        'profitability', jsonb_build_object(
            'gross_margin', jsonb_build_object(
                'value', ROUND((v_revenue - v_cogs) * 100.0 / NULLIF(v_revenue, 0), 2),
                'target', 40,
                'status', CASE 
                    WHEN (v_revenue - v_cogs) * 100.0 / NULLIF(v_revenue, 0) >= 40 THEN 'good'
                    WHEN (v_revenue - v_cogs) * 100.0 / NULLIF(v_revenue, 0) >= 30 THEN 'warning'
                    ELSE 'critical'
                END
            ),
            'net_margin', jsonb_build_object(
                'value', ROUND(v_net_profit * 100.0 / NULLIF(v_revenue, 0), 2),
                'target', 15,
                'status', CASE 
                    WHEN v_net_profit * 100.0 / NULLIF(v_revenue, 0) >= 15 THEN 'good'
                    WHEN v_net_profit * 100.0 / NULLIF(v_revenue, 0) >= 10 THEN 'warning'
                    ELSE 'critical'
                END
            ),
            'roa', jsonb_build_object(
                'value', ROUND(v_net_profit * 100.0 / NULLIF(v_total_assets, 0), 2),
                'target', 10
            )
        ),
        'liquidity', jsonb_build_object(
            'current_ratio', jsonb_build_object(
                'value', ROUND(v_current_assets / NULLIF(v_current_liabilities, 0), 2),
                'target', 2,
                'status', CASE 
                    WHEN v_current_assets / NULLIF(v_current_liabilities, 0) >= 2 THEN 'good'
                    WHEN v_current_assets / NULLIF(v_current_liabilities, 0) >= 1.5 THEN 'warning'
                    ELSE 'critical'
                END
            ),
            'quick_ratio', jsonb_build_object(
                'value', ROUND((v_current_assets - v_inventory) / NULLIF(v_current_liabilities, 0), 2),
                'target', 1
            )
        ),
        'collection', jsonb_build_object(
            'collection_rate', jsonb_build_object(
                'value', ROUND(v_collected * 100.0 / NULLIF(v_billed, 0), 2),
                'target', 95,
                'status', CASE 
                    WHEN v_collected * 100.0 / NULLIF(v_billed, 0) >= 95 THEN 'good'
                    WHEN v_collected * 100.0 / NULLIF(v_billed, 0) >= 85 THEN 'warning'
                    ELSE 'critical'
                END
            ),
            'dso', jsonb_build_object(
                'value', ROUND(v_receivables / NULLIF(v_revenue / 365, 0), 0),
                'target', 30,
                'status', CASE 
                    WHEN v_receivables / NULLIF(v_revenue / 365, 0) <= 30 THEN 'good'
                    WHEN v_receivables / NULLIF(v_revenue / 365, 0) <= 45 THEN 'warning'
                    ELSE 'critical'
                END
            ),
            'overdue_rate', jsonb_build_object(
                'value', ROUND(v_overdue * 100.0 / NULLIF(v_receivables, 0), 2),
                'target', 5
            )
        ),
        'summary', jsonb_build_object(
            'revenue', v_revenue,
            'expenses', v_expenses,
            'net_profit', v_net_profit,
            'total_assets', v_total_assets,
            'receivables', v_receivables,
            'collected', v_collected
        )
    );
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

#### 13.4 ุดุงุดุฉ ููุญุฉ ุงููุคุดุฑุงุช ุงููุงููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ููุญุฉ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุงูู (KPIs)                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ ุขุฎุฑ ุชุญุฏูุซ: 18 ุฏูุณูุจุฑ 2025 - 14:30                      โ
โ                                                          โ
โ ูุคุดุฑุงุช ุงูุฑุจุญูุฉ:                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ูุงูุด ุงูุฑุจุญ ุงูุฅุฌูุงูู    ูุงูุด ุงูุฑุจุญ ุงูุตุงูู    ROA   โ  โ
โ โ โโโโโโโโโโโโ          โโโโโโโโโโโโ      โโโโโโโโ  โ  โ
โ โ โ   42%    โ          โ   16%    โ      โ  11% โ  โ  โ
โ โ โ โ ุฌูุฏ   โ          โ โ ุฌูุฏ   โ      โ โ    โ  โ  โ
โ โ โ ุงููุฏู:40%โ          โ ุงููุฏู:15%โ      โ 10%  โ  โ  โ
โ โ โโโโโโโโโโโโ          โโโโโโโโโโโโ      โโโโโโโโ  โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ูุคุดุฑุงุช ุงูุณูููุฉ:                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ูุณุจุฉ ุงูุชุฏุงูู          ูุณุจุฉ ุงูุณูููุฉ ุงูุณุฑูุนุฉ        โ  โ
โ โ โโโโโโโโโโโโ          โโโโโโโโโโโโ                โ  โ
โ โ โ   2.3    โ          โ   1.2    โ                โ  โ
โ โ โ โ ุฌูุฏ   โ          โ โ ุฌูุฏ   โ                โ  โ
โ โ โ ุงููุฏู: 2 โ          โ ุงููุฏู: 1 โ                โ  โ
โ โ โโโโโโโโโโโโ          โโโโโโโโโโโโ                โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ูุคุดุฑุงุช ุงูุชุญุตูู:                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ ูุณุจุฉ ุงูุชุญุตูู     ุฃูุงู ุงูุชุญุตูู     ูุณุจุฉ ุงููุชุฃุฎุฑุงุช  โ  โ
โ โ โโโโโโโโโโโโ    โโโโโโโโโโโโ     โโโโโโโโโโโโ     โ  โ
โ โ โ   92%    โ    โ  35 ููู  โ     โ   8%     โ     โ  โ
โ โ โ โ ุชุญุฐูุฑ โ    โ โ ุชุญุฐูุฑ โ     โ โ ุชุญุฐูุฑ โ     โ  โ
โ โ โ ุงููุฏู:95%โ    โ ุงููุฏู:30 โ     โ ุงููุฏู:5% โ     โ  โ
โ โ โโโโโโโโโโโโ    โโโโโโโโโโโโ     โโโโโโโโโโโโ     โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ ุงูุงุชุฌุงู ุงูุดูุฑู:                                         โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ โ โ ุงูุฅูุฑุงุฏุงุช +8%  โ ุงููุตุฑููุงุช -2%  โ ุงูุฑุจุญ +15%  โ  โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                          โ
โ [๐ ุชุญุฏูุซ] [๐ ุชูุฑูุฑ ููุตู] [โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุคุดุฑุงุช]     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 14. APIs ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุงูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/kpis/financial` | ุฌููุน ุงููุคุดุฑุงุช ุงููุงููุฉ |
| GET | `/api/v1/kpis/financial/summary` | ููุฎุต ุงููุคุดุฑุงุช |
| GET | `/api/v1/kpis/financial/{kpi_code}` | ูุคุดุฑ ูุญุฏุฏ |
| GET | `/api/v1/kpis/financial/{kpi_code}/history` | ุชุงุฑูุฎ ุงููุคุดุฑ |
| GET | `/api/v1/reports/monthly-comparison` | ุงูููุงุฑูุฉ ุงูุดูุฑูุฉ |
| GET | `/api/v1/reports/yearly-comparison/{year}` | ุงูููุงุฑูุฉ ุงูุณูููุฉ |
| POST | `/api/v1/kpis/calculate` | ุฅุนุงุฏุฉ ุญุณุงุจ ุงููุคุดุฑุงุช |
| PUT | `/api/v1/kpis/{id}/targets` | ุชุญุฏูุซ ุฃูุฏุงู ุงููุคุดุฑ |



---

# ๐ ูุญุฏุฉ ุชุฑุญูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ ุงููุชูุฏูุฉ (Historical Data Migration)

> **ุงูุบุฑุถ:** ุชุฑุญูู ุฌููุน ุงูุจูุงูุงุช ุงููุชุฑุงููุฉ ููุฐ ุจุฏุงูุฉ 2024 ูู ุงูุฃูุธูุฉ ุงููุฏููุฉ ูุงูุนูููุงุช ุงููุฏููุฉ ุฅูู ุงููุธุงู ุงูุฌุฏูุฏ.
> **ุงูุฃูููุฉ:** ูุฐู ูู **ุฃูู ูููุฉ ุนูููุฉ** ูู ุงููุดุฑูุน - ุจุฏูููุง ุณูููู ุงููุธุงู ุงูุฌุฏูุฏ ูุงุฑุบุงู ูุนุฏูู ุงููุงุฆุฏุฉ.

---

## 1. ุชุฑุญูู ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ ุงููุงููุฉ

### 1.1 ุฌุฏูู ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ (opening_balances)

```sql
CREATE TABLE opening_balances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    migration_project_id UUID REFERENCES migration_projects(id),
    fiscal_year INTEGER NOT NULL,
    opening_date DATE NOT NULL,
    
    account_id UUID NOT NULL REFERENCES accounts(id),
    account_code VARCHAR(20),
    account_name VARCHAR(200),
    
    debit_balance DECIMAL(18,2) DEFAULT 0,
    credit_balance DECIMAL(18,2) DEFAULT 0,
    net_balance DECIMAL(18,2) GENERATED ALWAYS AS (debit_balance - credit_balance) STORED,
    
    currency VARCHAR(3) DEFAULT 'YER',
    exchange_rate DECIMAL(10,4) DEFAULT 1,
    
    source_system VARCHAR(100),
    source_reference VARCHAR(100),
    
    is_verified BOOLEAN DEFAULT FALSE,
    verified_by UUID REFERENCES users(id),
    verified_at TIMESTAMP,
    verification_notes TEXT,
    
    status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'verified', 'posted', 'rejected'
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_ob_project ON opening_balances(migration_project_id);
CREATE INDEX idx_ob_account ON opening_balances(account_id);
CREATE INDEX idx_ob_year ON opening_balances(fiscal_year);
```

### 1.2 ุฌุฏูู ููุฎุต ุงูุชุฑุญูู ุงููุงูู (financial_migration_summary)

```sql
CREATE TABLE financial_migration_summary (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    migration_project_id UUID NOT NULL REFERENCES migration_projects(id),
    
    fiscal_year INTEGER NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    
    total_assets DECIMAL(18,2) DEFAULT 0,
    total_liabilities DECIMAL(18,2) DEFAULT 0,
    total_equity DECIMAL(18,2) DEFAULT 0,
    total_revenue DECIMAL(18,2) DEFAULT 0,
    total_expenses DECIMAL(18,2) DEFAULT 0,
    
    is_balanced BOOLEAN GENERATED ALWAYS AS (
        ABS(total_assets - (total_liabilities + total_equity)) < 0.01
    ) STORED,
    
    total_receivables DECIMAL(18,2) DEFAULT 0,
    total_payables DECIMAL(18,2) DEFAULT 0,
    
    status VARCHAR(50) DEFAULT 'pending',
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 1.3 Function ุชุฑุญูู ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ

```sql
CREATE OR REPLACE FUNCTION migrate_opening_balances(
    p_project_id UUID,
    p_fiscal_year INTEGER,
    p_opening_date DATE
)
RETURNS TABLE (
    success BOOLEAN,
    accounts_migrated INTEGER,
    total_debit DECIMAL,
    total_credit DECIMAL,
    is_balanced BOOLEAN,
    message TEXT
) AS $$
DECLARE
    v_total_debit DECIMAL := 0;
    v_total_credit DECIMAL := 0;
    v_count INTEGER := 0;
    v_journal_id UUID;
BEGIN
    -- ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุชุฑุญูู ุณุงุจู
    IF EXISTS (SELECT 1 FROM opening_balances WHERE fiscal_year = p_fiscal_year AND status = 'posted') THEN
        RETURN QUERY SELECT FALSE, 0, 0::DECIMAL, 0::DECIMAL, FALSE, 'ููุฌุฏ ุชุฑุญูู ุณุงุจู ููุฐู ุงูุณูุฉ ุงููุงููุฉ';
        RETURN;
    END IF;
    
    -- ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    SELECT COUNT(*), COALESCE(SUM(debit_balance), 0), COALESCE(SUM(credit_balance), 0)
    INTO v_count, v_total_debit, v_total_credit
    FROM opening_balances
    WHERE migration_project_id = p_project_id AND fiscal_year = p_fiscal_year AND status = 'verified';
    
    -- ุงูุชุญูู ูู ุงูุชูุงุฒู
    IF ABS(v_total_debit - v_total_credit) > 0.01 THEN
        RETURN QUERY SELECT FALSE, v_count, v_total_debit, v_total_credit, FALSE, 
            'ุงูุฃุฑุตุฏุฉ ุบูุฑ ูุชูุงุฒูุฉ - ุงููุฑู: ' || (v_total_debit - v_total_credit)::TEXT;
        RETURN;
    END IF;
    
    -- ุฅูุดุงุก ููุฏ ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ
    INSERT INTO journal_entries (entry_number, entry_date, entry_type, description, total_debit, total_credit, status, is_opening_balance)
    VALUES ('OB-' || p_fiscal_year || '-001', p_opening_date, 'opening_balance',
            'ููุฏ ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ ููุณูุฉ ุงููุงููุฉ ' || p_fiscal_year, v_total_debit, v_total_credit, 'posted', TRUE)
    RETURNING id INTO v_journal_id;
    
    -- ุฅูุดุงุก ุชูุงุตูู ุงูููุฏ
    INSERT INTO journal_entry_lines (journal_entry_id, account_id, debit_amount, credit_amount, description)
    SELECT v_journal_id, account_id, debit_balance, credit_balance, 'ุฑุตูุฏ ุงูุชุชุงุญู - ' || account_name
    FROM opening_balances
    WHERE migration_project_id = p_project_id AND fiscal_year = p_fiscal_year AND status = 'verified';
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงูุฃุฑุตุฏุฉ
    UPDATE opening_balances SET status = 'posted', updated_at = NOW()
    WHERE migration_project_id = p_project_id AND fiscal_year = p_fiscal_year AND status = 'verified';
    
    RETURN QUERY SELECT TRUE, v_count, v_total_debit, v_total_credit, TRUE, 'ุชู ุชุฑุญูู ' || v_count || ' ุญุณุงุจ ุจูุฌุงุญ';
END;
$$ LANGUAGE plpgsql;
```

---

## 2. ุฃุฏูุงุช ุงูุชุญูู ูุงููุทุงุจูุฉ

### 2.1 ุฌุฏูู ุณุฌู ุงูุชุญูู (verification_log)

```sql
CREATE TABLE verification_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    migration_project_id UUID REFERENCES migration_projects(id),
    
    verification_type VARCHAR(50) NOT NULL, -- 'balance_check', 'count_check', 'integrity_check', 'reconciliation'
    entity_type VARCHAR(50) NOT NULL, -- 'accounts', 'customers', 'suppliers', 'inventory', 'assets'
    
    expected_value DECIMAL(18,2),
    actual_value DECIMAL(18,2),
    variance DECIMAL(18,2) GENERATED ALWAYS AS (actual_value - expected_value) STORED,
    variance_percentage DECIMAL(10,4) GENERATED ALWAYS AS (
        CASE WHEN expected_value != 0 THEN ((actual_value - expected_value) / expected_value) * 100 ELSE 0 END
    ) STORED,
    
    is_passed BOOLEAN,
    tolerance_percentage DECIMAL(5,2) DEFAULT 0.01,
    
    details JSONB,
    error_records JSONB,
    
    action_taken TEXT,
    resolved_by UUID REFERENCES users(id),
    resolved_at TIMESTAMP,
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_vl_project ON verification_log(migration_project_id);
CREATE INDEX idx_vl_type ON verification_log(verification_type);
```

### 2.2 Function ุงูุชุญูู ูู ุชูุงุฒู ุงูุฃุฑุตุฏุฉ

```sql
CREATE OR REPLACE FUNCTION verify_balance_migration(p_project_id UUID)
RETURNS TABLE (
    check_name VARCHAR,
    expected_value DECIMAL,
    actual_value DECIMAL,
    variance DECIMAL,
    is_passed BOOLEAN,
    details TEXT
) AS $$
BEGIN
    -- ุงูุชุญูู 1: ุชูุงุฒู ุงูููุฒุงููุฉ
    RETURN QUERY
    SELECT 'ุชูุงุฒู ุงูููุฒุงููุฉ ุงูุนููููุฉ'::VARCHAR, 0::DECIMAL AS expected,
        (SUM(CASE WHEN a.account_type IN ('asset') THEN ob.net_balance ELSE 0 END) -
         SUM(CASE WHEN a.account_type IN ('liability', 'equity') THEN ob.net_balance ELSE 0 END))::DECIMAL AS actual,
        (SUM(CASE WHEN a.account_type IN ('asset') THEN ob.net_balance ELSE 0 END) -
         SUM(CASE WHEN a.account_type IN ('liability', 'equity') THEN ob.net_balance ELSE 0 END))::DECIMAL AS var,
        ABS(SUM(CASE WHEN a.account_type IN ('asset') THEN ob.net_balance ELSE 0 END) -
            SUM(CASE WHEN a.account_type IN ('liability', 'equity') THEN ob.net_balance ELSE 0 END)) < 0.01 AS passed,
        'ุงูุฃุตูู ูุฌุจ ุฃู ุชุณุงูู ุงูุฎุตูู + ุญููู ุงูููููุฉ'::TEXT
    FROM opening_balances ob JOIN accounts a ON ob.account_id = a.id
    WHERE ob.migration_project_id = p_project_id;
    
    -- ุงูุชุญูู 2: ูุฌููุน ุงููุฏูู = ูุฌููุน ุงูุฏุงุฆู
    RETURN QUERY
    SELECT 'ุชูุงุฒู ุงููุฏูู ูุงูุฏุงุฆู'::VARCHAR, SUM(debit_balance)::DECIMAL, SUM(credit_balance)::DECIMAL,
        (SUM(debit_balance) - SUM(credit_balance))::DECIMAL,
        ABS(SUM(debit_balance) - SUM(credit_balance)) < 0.01,
        'ูุฌููุน ุงูุฃุฑุตุฏุฉ ุงููุฏููุฉ ูุฌุจ ุฃู ูุณุงูู ูุฌููุน ุงูุฃุฑุตุฏุฉ ุงูุฏุงุฆูุฉ'::TEXT
    FROM opening_balances WHERE migration_project_id = p_project_id;
END;
$$ LANGUAGE plpgsql;
```

### 2.3 Function ุชูุฑูุฑ ุงููุทุงุจูุฉ ุงูุดุงูู

```sql
CREATE OR REPLACE FUNCTION generate_migration_reconciliation_report(p_project_id UUID)
RETURNS TABLE (
    category VARCHAR,
    item VARCHAR,
    source_system_value DECIMAL,
    new_system_value DECIMAL,
    variance DECIMAL,
    status VARCHAR
) AS $$
BEGIN
    -- ูุทุงุจูุฉ ุฃุฑุตุฏุฉ ุงูุนููุงุก
    RETURN QUERY
    SELECT 'ุฐูู ุงูุนููุงุก'::VARCHAR, 'ุฅุฌูุงูู ุฃุฑุตุฏุฉ ุงูุนููุงุก'::VARCHAR,
        (SELECT COALESCE(SUM(source_balance), 0) FROM customer_opening_balances WHERE migration_project_id = p_project_id),
        (SELECT COALESCE(SUM(current_balance), 0) FROM customers WHERE id IN (SELECT customer_id FROM customer_opening_balances WHERE migration_project_id = p_project_id)),
        (SELECT COALESCE(SUM(source_balance), 0) FROM customer_opening_balances WHERE migration_project_id = p_project_id) -
        (SELECT COALESCE(SUM(current_balance), 0) FROM customers WHERE id IN (SELECT customer_id FROM customer_opening_balances WHERE migration_project_id = p_project_id)),
        CASE WHEN ABS((SELECT COALESCE(SUM(source_balance), 0) FROM customer_opening_balances WHERE migration_project_id = p_project_id) -
                      (SELECT COALESCE(SUM(current_balance), 0) FROM customers)) < 0.01
             THEN 'ูุชุทุงุจู' ELSE 'ููุฌุฏ ูุฑู' END::VARCHAR;
    
    -- ูุทุงุจูุฉ ุฃุฑุตุฏุฉ ุงูููุฑุฏูู
    RETURN QUERY
    SELECT 'ุฐูู ุงูููุฑุฏูู'::VARCHAR, 'ุฅุฌูุงูู ุฃุฑุตุฏุฉ ุงูููุฑุฏูู'::VARCHAR,
        (SELECT COALESCE(SUM(source_balance), 0) FROM supplier_opening_balances WHERE migration_project_id = p_project_id),
        (SELECT COALESCE(SUM(current_balance), 0) FROM suppliers WHERE id IN (SELECT supplier_id FROM supplier_opening_balances WHERE migration_project_id = p_project_id)),
        (SELECT COALESCE(SUM(source_balance), 0) FROM supplier_opening_balances WHERE migration_project_id = p_project_id) -
        (SELECT COALESCE(SUM(current_balance), 0) FROM suppliers),
        CASE WHEN ABS((SELECT COALESCE(SUM(source_balance), 0) FROM supplier_opening_balances WHERE migration_project_id = p_project_id) -
                      (SELECT COALESCE(SUM(current_balance), 0) FROM suppliers)) < 0.01
             THEN 'ูุชุทุงุจู' ELSE 'ููุฌุฏ ูุฑู' END::VARCHAR;
    
    -- ูุทุงุจูุฉ ูููุฉ ุงููุฎุฒูู
    RETURN QUERY
    SELECT 'ุงููุฎุฒูู'::VARCHAR, 'ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู'::VARCHAR,
        (SELECT COALESCE(SUM(total_value), 0) FROM inventory_opening_balances WHERE migration_project_id = p_project_id),
        (SELECT COALESCE(SUM(quantity * unit_cost), 0) FROM inventory_items),
        (SELECT COALESCE(SUM(total_value), 0) FROM inventory_opening_balances WHERE migration_project_id = p_project_id) -
        (SELECT COALESCE(SUM(quantity * unit_cost), 0) FROM inventory_items),
        CASE WHEN ABS((SELECT COALESCE(SUM(total_value), 0) FROM inventory_opening_balances WHERE migration_project_id = p_project_id) -
                      (SELECT COALESCE(SUM(quantity * unit_cost), 0) FROM inventory_items)) < 0.01
             THEN 'ูุชุทุงุจู' ELSE 'ููุฌุฏ ูุฑู' END::VARCHAR;
END;
$$ LANGUAGE plpgsql;
```

---

## 3. ุดุงุดุฉ ุฅุฏุงุฑุฉ ุงูุชุฑุญูู ุงูุดุงููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ ููุญุฉ ุชุญูู ุชุฑุญูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ๐ ููุฎุต ุญุงูุฉ ุงูุชุฑุญูู                                                โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ  ุงูุฃุฑุตุฏุฉ ุงููุงููุฉ    โ  ุฃุฑุตุฏุฉ ุงูุนููุงุก     โ  ุฃุฑุตุฏุฉ ุงูููุฑุฏูู        โ   โ
โ  โ  โ 100% ููุชูู      โ  โณ 85% ุฌุงุฑู       โ  โณ 70% ุฌุงุฑู           โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ  ุงููุฎุฒูู           โ  ุงูุฃุตูู            โ  ุงูุจูุงูุงุช ุงูุฃุฎุฑู       โ   โ
โ  โ  โณ 60% ุฌุงุฑู       โ  โณ 45% ุฌุงุฑู       โ  โธ๏ธ 0% ูู ูุจุฏุฃ         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ๐ ูุฑุงุญู ุงูุชุฑุญูู                                                    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโค   โ
โ  โ ุงููุฑุญูุฉ                                                      โ ุงูุญุงูุฉโ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโค   โ
โ  โ 1. ุชุญููู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช                                       โ โ   โ   โ
โ  โ 2. ุชุฑุญูู ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ                                  โ โ   โ   โ
โ  โ 3. ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูุนููุงุก                                    โ โณ   โ   โ
โ  โ 4. ุชุฑุญูู ุฃุฑุตุฏุฉ ุงูุนููุงุก                                       โ โณ   โ   โ
โ  โ 5. ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูููุฑุฏูู                                   โ โณ   โ   โ
โ  โ 6. ุชุฑุญูู ุฃุฑุตุฏุฉ ุงูููุฑุฏูู                                      โ โธ๏ธ   โ   โ
โ  โ 7. ุฌุฑุฏ ูุชุฑุญูู ุงููุฎุฒูู                                        โ โธ๏ธ   โ   โ
โ  โ 8. ุญุตุฑ ูุชุฑุญูู ุงูุฃุตูู                                         โ โธ๏ธ   โ   โ
โ  โ 9. ุงูุชุญูู ูุงููุทุงุจูุฉ ุงูููุงุฆูุฉ                                 โ โธ๏ธ   โ   โ
โ  โ 10. ุฅุบูุงู ุงูุชุฑุญูู ูุจุฏุก ุงูุชุดุบูู                               โ โธ๏ธ   โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ โ๏ธ ุชูุจููุงุช ููุดุงูู                                                  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ โข 15 ุนููู ุจุฏูู ุฑูู ูุงุชู ุตุญูุญ                                       โ   โ
โ  โ โข 3 ุญุณุงุจุงุช ุจุฃุฑุตุฏุฉ ุบูุฑ ููุทููุฉ ุชุญุชุงุฌ ูุฑุงุฌุนุฉ                          โ   โ
โ  โ โข ูุฑู 1,250 ุฑูุงู ูู ูุทุงุจูุฉ ุฐูู ุงูุนููุงุก                             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [๐ฅ ุงุณุชูุฑุงุฏ ููู]  [โ ุชุดุบูู ุงูุชุญูู]  [๐ ุชูุฑูุฑ ุงููุทุงุจูุฉ]  [๐ ุฅุบูุงู ุงูุชุฑุญูู]โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 4. APIs ุชุฑุญูู ุงูุจูุงูุงุช ุงููุชูุฏูุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/migration/opening-balances/import` | ุงุณุชูุฑุงุฏ ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ |
| POST | `/api/v1/migration/opening-balances/verify` | ุงูุชุญูู ูู ุงูุฃุฑุตุฏุฉ |
| POST | `/api/v1/migration/opening-balances/post` | ุชุฑุญูู ุงูุฃุฑุตุฏุฉ |
| GET | `/api/v1/migration/verification/run` | ุชุดุบูู ุงูุชุญูู ุงูุดุงูู |
| GET | `/api/v1/migration/reconciliation` | ุชูุฑูุฑ ุงููุทุงุจูุฉ |
| GET | `/api/v1/migration/status` | ุญุงูุฉ ุงูุชุฑุญูู ุงูุญุงููุฉ |
| GET | `/api/v1/migration/errors` | ูุงุฆูุฉ ุงูุฃุฎุทุงุก |
| POST | `/api/v1/migration/errors/:id/resolve` | ุญู ุฎุทุฃ |
| POST | `/api/v1/migration/finalize` | ุฅุบูุงู ุงูุชุฑุญูู |



---

## ๐ ููู 41: ูุญุฑู ุงูุชุณููุฉ ุนุจุฑ ุงูุญุณุงุจุงุช ุงููุณูุทุฉ (Reconciliation Engine)

### ุงููุฏู
ุจูุงุก ูุธุงู ูุญุงุณุจู ูุนุชูุฏ ุนูู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ (Clearing Accounts) ูุฌููุน ุงูุนูููุงุชุ ููุง ูุณูุญ ุจุชุณุฌูู ุงูุนูููุงุช ุงูููููุฉ ุจุณุฑุนุฉุ ุซู ุฅุฌุฑุงุก ุนูููุฉ ูุทุงุจูุฉ ูุชุณููุฉ ุฏูููุฉ ูุจู ุชุฑุญูููุง ุฅูู ุงูุญุณุงุจุงุช ุงูุฏุงุฆูุฉ.

### ุงููุจุฏุฃ ุงูุฃุณุงุณู
> **ูุง ูุชู ุงูุชุฑุญูู ูุจุงุดุฑุฉ ุฅูู ุญุณุงุจ ุฏุงุฆู** (ูุซู ุญ/ุงูุจูู ุฃู ุญ/ุงูุฅูุฑุงุฏุงุช). ูู ุงูุนูููุงุช ุชูุฑ ุฃููุงู ุนุจุฑ ุญุณุงุจ ูุณูุท ููุงุจู.

---

### 1๏ธโฃ ุงููููุฉ 1.1.1: ูุญุฑู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ

#### ุฌุฏูู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ
```sql
-- ุชุญุฏูุซ ุฌุฏูู ุงูุญุณุงุจุงุช ูุฏุนู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS is_clearing_account BOOLEAN DEFAULT FALSE;
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS linked_permanent_account_id UUID REFERENCES accounts(id);
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS clearing_account_id UUID REFERENCES accounts(id);

-- ุฌุฏูู ุฃููุงุน ุงูุญุณุงุจุงุช ุงููุณูุทุฉ
CREATE TABLE clearing_account_types (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_name VARCHAR(100) NOT NULL,
    permanent_account_name VARCHAR(200) NOT NULL,
    clearing_account_name VARCHAR(200) NOT NULL,
    permanent_account_id UUID REFERENCES accounts(id),
    clearing_account_id UUID REFERENCES accounts(id),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ููุญุณุงุจุงุช ุงููุณูุทุฉ
INSERT INTO clearing_account_types (entity_name, permanent_account_name, clearing_account_name) VALUES
('ุตูุฏูู ุงูุชุญุตูู', 'ุญ/ ุงูุตูุฏูู ุงูุฑุฆูุณู', 'ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู'),
('ุจูู ุงูุญูุดุจู', 'ุญ/ ุจูู ุงูุญูุดุจู', 'ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู'),
('ูุธุงู ุงูููุชุฑุฉ ุงูุนุงุฏู', 'ุญ/ ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ', 'ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ'),
('ูุธุงู ุงูุฏูุน ุงููุณุจู', 'ุญ/ ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู', 'ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู'),
('ูุธุงู ุตูุฏูู ุงูุฏุนู', 'ุญ/ ุฅูุฑุงุฏุงุช ุตูุฏูู ุงูุฏุนู', 'ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุตูุฏูู ุงูุฏุนู'),
('ุงูููุฑุฏูู', 'ุญ/ ุงูููุฑุฏูู', 'ุญ/ ูุณูุท ุงูููุฑุฏูู'),
('ุงููุตุฑููุงุช', 'ุญ/ ุงููุตุฑููุงุช ุงูุนุงูุฉ', 'ุญ/ ูุณูุท ุงููุตุฑููุงุช');
```

#### Trigger ุฅูุดุงุก ุญุณุงุจ ูุณูุท ุชููุงุฆู
```sql
CREATE OR REPLACE FUNCTION create_clearing_account()
RETURNS TRIGGER AS $$
DECLARE
    clearing_id UUID;
BEGIN
    IF NEW.is_clearing_account = TRUE THEN
        RETURN NEW;
    END IF;
    
    INSERT INTO accounts (
        account_code, account_name, account_type, parent_id,
        is_clearing_account, linked_permanent_account_id, is_active
    ) VALUES (
        NEW.account_code || '-CLR',
        'ุญ/ ูุณูุท ' || NEW.account_name,
        NEW.account_type, NEW.parent_id,
        TRUE, NEW.id, TRUE
    ) RETURNING id INTO clearing_id;
    
    UPDATE accounts SET clearing_account_id = clearing_id WHERE id = NEW.id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_create_clearing_account
AFTER INSERT ON accounts
FOR EACH ROW WHEN (NEW.is_clearing_account = FALSE)
EXECUTE FUNCTION create_clearing_account();
```

---

### 2๏ธโฃ ุงููููุฉ 1.1.2: ูุงุฌูุงุช ุงูุฅุฏุฎุงู ุงููููู

#### ุฌุฏูู ุงูุนูููุงุช ุงูููููุฉ (ูุจู ุงูุชุณููุฉ)
```sql
CREATE TABLE daily_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    transaction_date DATE NOT NULL DEFAULT CURRENT_DATE,
    transaction_type VARCHAR(50) NOT NULL,
    debit_clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    credit_clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    amount DECIMAL(15,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'YER',
    reference_number VARCHAR(50),
    description TEXT,
    entity_type VARCHAR(50),
    entity_id UUID,
    reconciliation_status VARCHAR(20) DEFAULT 'pending',
    reconciliation_id UUID,
    reconciled_at TIMESTAMP,
    reconciled_by UUID REFERENCES users(id),
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    attachments JSONB DEFAULT '[]'
);

CREATE INDEX idx_daily_transactions_status ON daily_transactions(reconciliation_status);
CREATE INDEX idx_daily_transactions_date ON daily_transactions(transaction_date);
```

#### ุฌุฏูู ุฃููุงุน ุงูุนูููุงุช ุงูููููุฉ
```sql
CREATE TABLE daily_transaction_types (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type_code VARCHAR(50) NOT NULL UNIQUE,
    type_name VARCHAR(100) NOT NULL,
    default_debit_account_id UUID REFERENCES accounts(id),
    default_credit_account_id UUID REFERENCES accounts(id),
    requires_entity BOOLEAN DEFAULT FALSE,
    entity_type VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE
);

INSERT INTO daily_transaction_types (type_code, type_name, requires_entity, entity_type) VALUES
('COLLECTION_BILLING', 'ุชุญุตูู ููุงุชูุฑ ุนุงุฏูุฉ', TRUE, 'customer'),
('COLLECTION_PREPAID', 'ุชุญุตูู ุฏูุน ูุณุจู', TRUE, 'customer'),
('COLLECTION_SUPPORT', 'ุชุญุตูู ุตูุฏูู ุฏุนู', TRUE, 'customer'),
('DEPOSIT_BANK', 'ุชูุฑูุฏ ููุจูู', FALSE, NULL),
('PAYMENT_SUPPLIER', 'ุฏูุน ูููุฑุฏ', TRUE, 'supplier'),
('EXPENSE_GENERAL', 'ูุตุฑูู ุนุงู', FALSE, NULL),
('TRANSFER_INTERNAL', 'ุชุญููู ุฏุงุฎูู', FALSE, NULL);
```

---

### 3๏ธโฃ ุงููููุฉ 1.1.3: ูุฑูุฒ ุงูุชุณููุฉ (Reconciliation Center)

#### ุฌุฏูู ุฌูุณุงุช ุงูุชุณููุฉ
```sql
CREATE TABLE reconciliation_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_name VARCHAR(200) NOT NULL,
    session_date DATE NOT NULL DEFAULT CURRENT_DATE,
    left_clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    right_clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    total_left_transactions INT DEFAULT 0,
    total_right_transactions INT DEFAULT 0,
    total_left_amount DECIMAL(15,2) DEFAULT 0,
    total_right_amount DECIMAL(15,2) DEFAULT 0,
    matched_count INT DEFAULT 0,
    matched_amount DECIMAL(15,2) DEFAULT 0,
    unmatched_left_count INT DEFAULT 0,
    unmatched_right_count INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'in_progress',
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP
);
```

#### ุฌุฏูู ุนูููุงุช ุงููุทุงุจูุฉ
```sql
CREATE TABLE reconciliation_matches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES reconciliation_sessions(id),
    left_transaction_id UUID NOT NULL REFERENCES daily_transactions(id),
    right_transaction_id UUID NOT NULL REFERENCES daily_transactions(id),
    left_amount DECIMAL(15,2) NOT NULL,
    right_amount DECIMAL(15,2) NOT NULL,
    difference DECIMAL(15,2) GENERATED ALWAYS AS (left_amount - right_amount) STORED,
    match_type VARCHAR(20) DEFAULT 'exact',
    adjustment_reason TEXT,
    status VARCHAR(20) DEFAULT 'matched',
    matched_by UUID NOT NULL REFERENCES users(id),
    matched_at TIMESTAMP DEFAULT NOW(),
    reconciled_at TIMESTAMP,
    CONSTRAINT unique_left_transaction UNIQUE (left_transaction_id),
    CONSTRAINT unique_right_transaction UNIQUE (right_transaction_id)
);
```

#### View ุงูุนูููุงุช ุงููุนููุฉ
```sql
CREATE VIEW pending_reconciliation_items AS
SELECT 
    dt.id, dt.transaction_date, dt.transaction_type, dt.amount,
    dt.reference_number, dt.description, dt.entity_type, dt.entity_id,
    da.account_name AS debit_account_name,
    ca.account_name AS credit_account_name,
    dt.created_at, u.full_name AS created_by_name,
    EXTRACT(DAY FROM NOW() - dt.created_at) AS days_pending
FROM daily_transactions dt
JOIN accounts da ON dt.debit_clearing_account_id = da.id
JOIN accounts ca ON dt.credit_clearing_account_id = ca.id
JOIN users u ON dt.created_by = u.id
WHERE dt.reconciliation_status = 'pending'
ORDER BY dt.transaction_date DESC;
```

#### Function ุชูููุฐ ุงููุทุงุจูุฉ
```sql
CREATE OR REPLACE FUNCTION perform_reconciliation_match(
    p_session_id UUID,
    p_left_transaction_id UUID,
    p_right_transaction_id UUID,
    p_user_id UUID,
    p_adjustment_reason TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    v_match_id UUID;
    v_left_amount DECIMAL(15,2);
    v_right_amount DECIMAL(15,2);
    v_match_type VARCHAR(20);
BEGIN
    SELECT amount INTO v_left_amount FROM daily_transactions WHERE id = p_left_transaction_id;
    SELECT amount INTO v_right_amount FROM daily_transactions WHERE id = p_right_transaction_id;
    
    v_match_type := CASE WHEN v_left_amount = v_right_amount THEN 'exact' ELSE 'adjusted' END;
    
    INSERT INTO reconciliation_matches (
        session_id, left_transaction_id, right_transaction_id,
        left_amount, right_amount, match_type, adjustment_reason, matched_by
    ) VALUES (
        p_session_id, p_left_transaction_id, p_right_transaction_id,
        v_left_amount, v_right_amount, v_match_type, p_adjustment_reason, p_user_id
    ) RETURNING id INTO v_match_id;
    
    UPDATE daily_transactions 
    SET reconciliation_status = 'matched', reconciliation_id = v_match_id, updated_at = NOW()
    WHERE id IN (p_left_transaction_id, p_right_transaction_id);
    
    UPDATE reconciliation_sessions
    SET matched_count = matched_count + 1,
        matched_amount = matched_amount + v_left_amount,
        unmatched_left_count = unmatched_left_count - 1,
        unmatched_right_count = unmatched_right_count - 1
    WHERE id = p_session_id;
    
    RETURN v_match_id;
END;
$$ LANGUAGE plpgsql;
```

#### Function ุชุฑุญูู ุงูุนูููุงุช ุงููุณูุงุฉ
```sql
CREATE OR REPLACE FUNCTION post_reconciled_transactions(
    p_session_id UUID,
    p_user_id UUID
)
RETURNS INT AS $$
DECLARE
    v_match RECORD;
    v_posted_count INT := 0;
    v_journal_entry_id UUID;
BEGIN
    FOR v_match IN 
        SELECT rm.*, dt_left.amount, dt_left.description, dt_left.transaction_date
        FROM reconciliation_matches rm
        JOIN daily_transactions dt_left ON rm.left_transaction_id = dt_left.id
        WHERE rm.session_id = p_session_id AND rm.status = 'matched'
    LOOP
        INSERT INTO journal_entries (
            entry_date, description, reference_type, reference_id, created_by, status
        ) VALUES (
            v_match.transaction_date, 'ุชุฑุญูู ุชุณููุฉ: ' || v_match.description,
            'reconciliation', v_match.id, p_user_id, 'posted'
        ) RETURNING id INTO v_journal_entry_id;
        
        UPDATE reconciliation_matches SET status = 'reconciled', reconciled_at = NOW() WHERE id = v_match.id;
        UPDATE daily_transactions SET reconciliation_status = 'reconciled', reconciled_at = NOW(), reconciled_by = p_user_id
        WHERE reconciliation_id = v_match.id;
        
        v_posted_count := v_posted_count + 1;
    END LOOP;
    
    UPDATE reconciliation_sessions SET status = 'completed', completed_at = NOW() WHERE id = p_session_id;
    RETURN v_posted_count;
END;
$$ LANGUAGE plpgsql;
```

---

### 4๏ธโฃ ุงููููุฉ 1.1.4: ุฃุฏุงุฉ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ ููุชุณููุฉ

#### ุฌุฏูู ุฏูุนุงุช ุงูุงุณุชูุฑุงุฏ ุงูุชุงุฑูุฎู
```sql
CREATE TABLE historical_import_batches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    batch_name VARCHAR(200) NOT NULL,
    import_type VARCHAR(50) NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    target_clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    source_file_name VARCHAR(255),
    source_file_path VARCHAR(500),
    total_rows INT DEFAULT 0,
    imported_rows INT DEFAULT 0,
    failed_rows INT DEFAULT 0,
    total_amount DECIMAL(15,2) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending',
    error_message TEXT,
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP
);

CREATE TABLE historical_import_details (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    batch_id UUID NOT NULL REFERENCES historical_import_batches(id),
    row_number INT NOT NULL,
    transaction_date DATE,
    amount DECIMAL(15,2),
    reference_number VARCHAR(50),
    description TEXT,
    entity_name VARCHAR(200),
    status VARCHAR(20) DEFAULT 'pending',
    error_message TEXT,
    created_transaction_id UUID REFERENCES daily_transactions(id),
    raw_data JSONB
);
```

#### ููุงูุจ ุงูุงุณุชูุฑุงุฏ ููุชุณููุฉ
```sql
CREATE TABLE import_templates_reconciliation (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(50) NOT NULL,
    column_mappings JSONB NOT NULL,
    default_debit_account_id UUID REFERENCES accounts(id),
    default_credit_account_id UUID REFERENCES accounts(id),
    date_format VARCHAR(20) DEFAULT 'YYYY-MM-DD',
    decimal_separator VARCHAR(1) DEFAULT '.',
    skip_header_rows INT DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

INSERT INTO import_templates_reconciliation (template_name, template_type, column_mappings) VALUES
('ูุงูุจ ุชุญุตููุงุช ุงูุตูุฏูู', 'cash_collections', '{"date": "A", "amount": "B", "customer_name": "C", "invoice_number": "D", "notes": "E"}'),
('ูุงูุจ ูุดู ุญุณุงุจ ุงูุจูู', 'bank_statement', '{"date": "A", "description": "B", "debit": "C", "credit": "D", "balance": "E"}'),
('ูุงูุจ ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ', 'revenues', '{"date": "A", "invoice_number": "B", "customer_name": "C", "amount": "D", "payment_method": "E"}'),
('ูุงูุจ ูุฏููุนุงุช ุงูููุฑุฏูู', 'supplier_payments', '{"date": "A", "supplier_name": "B", "invoice_number": "C", "amount": "D", "payment_method": "E"}');
```

---

### 5๏ธโฃ ูุงุฌูุงุช ุงููุณุชุฎุฏู

#### ุดุงุดุฉ ุงูุฅุฏุฎุงู ุงููููู
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ุชุณุฌูู ุนูููุฉ ููููุฉ                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ููุน ุงูุนูููุฉ: [ุชุญุตูู ููุงุชูุฑ โผ]                                   โ
โ ุงูุชุงุฑูุฎ: [2024-12-18]     ุงููุจูุบ: [100,000] ุฑ.ู                โ
โ ุงูุญุณุงุจ ุงููุฏูู: [ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู โผ]                       โ
โ ุงูุญุณุงุจ ุงูุฏุงุฆู: [ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ โผ]                     โ
โ ุฑูู ุงููุฑุฌุน: [RCP-2024-001]                                      โ
โ ุงููุตู: [ุชุญุตูู ูุงุชูุฑุฉ ุงูุนููู ุฃุญูุฏ ูุญูุฏ]                         โ
โ ุงูุนููู: [๐ ุจุญุซ...] ุฃุญูุฏ ูุญูุฏ - ACC-001                        โ
โ ุงููุฑููุงุช: [๐ ุฅุถุงูุฉ ููู]                                        โ
โ              [ุญูุธ ูุฌุฏูุฏ]  [ุญูุธ]  [ุฅูุบุงุก]                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุดุงุดุฉ ูุฑูุฒ ุงูุชุณููุฉ
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ูุฑูุฒ ุงูุชุณููุฉ - ุชุณููุฉ ุตูุฏูู ุงูุชุญุตูู ูุน ุงูุจูู                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงููุชุฑุฉ: [01/12/2024] ุฅูู [18/12/2024]    [๐ ุชุญุฏูุซ]                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ค ุชูุฑูุฏุงุช ุงูุตูุฏูู (ุงููููู)    โ ๐ฅ ุฅูุฏุงุนุงุช ุงูุจูู (ุงููุณุงุฑ)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ 15/12 - 500,000 - ุชูุฑูุฏ#123 โ โ 15/12 - 500,000 - ุฅูุฏุงุน ููุฏู            โ
โ โ 16/12 - 300,000 - ุชูุฑูุฏ#124 โ โ 16/12 - 300,000 - ุฅูุฏุงุน ููุฏู            โ
โ โ 17/12 - 450,000 - ุชูุฑูุฏ#125 โ โ 17/12 - 450,000 - ุฅูุฏุงุน ููุฏู            โ
โ โ 18/12 - 200,000 - ุชูุฑูุฏ#126 โ โ๏ธ ูุง ููุฌุฏ ูุทุงุจู                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงูุฅุฌูุงูู: 1,450,000            โ ุงูุฅุฌูุงูู: 1,250,000                        โ
โ ุงููุชุทุงุจู: 450,000              โ ุงููุชุทุงุจู: 450,000                          โ
โ ุงููุนูู: 1,000,000              โ ุงููุนูู: 800,000                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [๐ ูุทุงุจูุฉ ุงููุญุฏุฏ]  [โฉ๏ธ ุฅูุบุงุก ุงููุทุงุจูุฉ]  [โ ุชุฑุญูู ุงููุณูู]  [๐ ุชูุฑูุฑ]    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 6๏ธโฃ APIs

```yaml
# ุงูุนูููุงุช ุงูููููุฉ
POST   /api/v1/daily-transactions                    # ุชุณุฌูู ุนูููุฉ ููููุฉ
GET    /api/v1/daily-transactions                    # ูุงุฆูุฉ ุงูุนูููุงุช
GET    /api/v1/daily-transactions/pending            # ุงูุนูููุงุช ุงููุนููุฉ
GET    /api/v1/daily-transactions/{id}               # ุชูุงุตูู ุนูููุฉ

# ุฌูุณุงุช ุงูุชุณููุฉ
POST   /api/v1/reconciliation/sessions               # ุฅูุดุงุก ุฌูุณุฉ ุชุณููุฉ
GET    /api/v1/reconciliation/sessions               # ูุงุฆูุฉ ุงูุฌูุณุงุช
GET    /api/v1/reconciliation/sessions/{id}          # ุชูุงุตูู ุฌูุณุฉ
GET    /api/v1/reconciliation/sessions/{id}/pending  # ุงูุนูููุงุช ุงููุนููุฉ

# ุงููุทุงุจูุฉ
POST   /api/v1/reconciliation/match                  # ุชูููุฐ ูุทุงุจูุฉ
DELETE /api/v1/reconciliation/match/{id}             # ุฅูุบุงุก ูุทุงุจูุฉ
POST   /api/v1/reconciliation/sessions/{id}/post     # ุชุฑุญูู ุงููุณูู

# ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ
POST   /api/v1/historical-import/batches             # ุฅูุดุงุก ุฏูุนุฉ ุงุณุชูุฑุงุฏ
POST   /api/v1/historical-import/batches/{id}/upload # ุฑูุน ููู
GET    /api/v1/historical-import/batches/{id}/preview # ูุนุงููุฉ
POST   /api/v1/historical-import/batches/{id}/process # ุชูููุฐ ุงูุงุณุชูุฑุงุฏ
GET    /api/v1/historical-import/templates           # ูุงุฆูุฉ ุงูููุงูุจ

# ุงูุชูุงุฑูุฑ
GET    /api/v1/reconciliation/reports/pending-summary # ููุฎุต ุงููุนููุงุช
GET    /api/v1/reconciliation/reports/aging          # ุชูุงุฏู ุงููุนููุงุช
```

---

### ููุงุท ุงูุฃูู ุงููุนุงูุฌุฉ

| ููุทุฉ ุงูุฃูู | ุงูุญู |
|------------|------|
| ุชุฑุญูู ูุจุงุดุฑ ููุฏูุงุชุฑ ุจุฏูู ูุฑุงุฌุนุฉ | ุงูุญุณุงุจุงุช ุงููุณูุทุฉ ุชุนุฒู ุงูุนูููุงุช |
| ุตุนูุจุฉ ุงูุชุดุงู ุงูุฃุฎุทุงุก | ูุฑูุฒ ุงูุชุณููุฉ ูุธูุฑ ุงููุฑููุงุช |
| ุจูุงูุงุช ุชุงุฑูุฎูุฉ ูุชุฑุงููุฉ | ุฃุฏูุงุช ุงุณุชูุฑุงุฏ ุฌุงูุฒุฉ |
| ูุง ุฑูุงุจุฉ ุนูู ุงูุนูููุงุช | ูู ุนูููุฉ ุชุญุชุงุฌ ูุทุงุจูุฉ ูุจู ุงูุชุฑุญูู |
| ุชุฃุฎุฑ ูู ุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ | ุชูุงุฑูุฑ ููุฑูุฉ ูููุนููุงุช |


---

### 7๏ธโฃ ุชุณููุงุช ูุชุฎุตุตุฉ ุฅุถุงููุฉ (ููู 41 - ุชูููุฉ)

#### 7.1 ุชุณููุฉ ุงูุฅูุฑุงุฏุงุช

##### ุงููุตู
ูุทุงุจูุฉ ุงูุญุฑูุงุช ุงูุฏุงุฆูุฉ ูู **ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ** ูุน ุงูุญุฑูุงุช ุงููุฏููุฉ ูู **ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู**.

```sql
-- View ุชุณููุฉ ุงูุฅูุฑุงุฏุงุช
CREATE VIEW revenue_reconciliation_view AS
SELECT 
    'revenue' AS side,
    dt.id, dt.transaction_date, dt.amount, dt.reference_number,
    dt.description, dt.entity_id, c.customer_name,
    dt.reconciliation_status, dt.created_at
FROM daily_transactions dt
LEFT JOIN customers c ON dt.entity_id = c.id AND dt.entity_type = 'customer'
WHERE dt.credit_clearing_account_id IN (
    SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุฅูุฑุงุฏุงุช%'
)
UNION ALL
SELECT 
    'collection' AS side,
    dt.id, dt.transaction_date, dt.amount, dt.reference_number,
    dt.description, dt.entity_id, c.customer_name,
    dt.reconciliation_status, dt.created_at
FROM daily_transactions dt
LEFT JOIN customers c ON dt.entity_id = c.id AND dt.entity_type = 'customer'
WHERE dt.debit_clearing_account_id IN (
    SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุตูุฏูู ุงูุชุญุตูู%'
);

-- Function ุชุณููุฉ ุงูุฅูุฑุงุฏุงุช ุงูุชููุงุฆูุฉ
CREATE OR REPLACE FUNCTION auto_reconcile_revenues(
    p_date_from DATE,
    p_date_to DATE,
    p_user_id UUID
)
RETURNS INT AS $$
DECLARE
    v_matched_count INT := 0;
    v_revenue RECORD;
    v_collection RECORD;
BEGIN
    -- ุงูุจุญุซ ุนู ุชุทุงุจูุงุช ุจุงููุจูุบ ูุงูุนููู
    FOR v_revenue IN 
        SELECT * FROM daily_transactions 
        WHERE credit_clearing_account_id IN (SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุฅูุฑุงุฏุงุช%')
        AND reconciliation_status = 'pending'
        AND transaction_date BETWEEN p_date_from AND p_date_to
    LOOP
        SELECT * INTO v_collection FROM daily_transactions
        WHERE debit_clearing_account_id IN (SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุตูุฏูู ุงูุชุญุตูู%')
        AND reconciliation_status = 'pending'
        AND amount = v_revenue.amount
        AND entity_id = v_revenue.entity_id
        AND transaction_date BETWEEN p_date_from AND p_date_to
        LIMIT 1;
        
        IF v_collection.id IS NOT NULL THEN
            -- ุชูููุฐ ุงููุทุงุจูุฉ
            UPDATE daily_transactions SET reconciliation_status = 'matched', reconciled_at = NOW(), reconciled_by = p_user_id
            WHERE id IN (v_revenue.id, v_collection.id);
            v_matched_count := v_matched_count + 1;
        END IF;
    END LOOP;
    
    RETURN v_matched_count;
END;
$$ LANGUAGE plpgsql;
```

#### 7.2 ุชุณููุฉ ุงููุตุฑููุงุช

##### ุงููุตู
ูุทุงุจูุฉ ุงูุญุฑูุงุช ุงูุฏุงุฆูุฉ ูู **ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู** (ุฏูุนุฉ ูููุฑุฏ) ูุน ุงูุญุฑูุงุช ุงููุฏููุฉ ูู **ุญ/ ูุณูุท ุงูููุฑุฏูู**.

```sql
-- View ุชุณููุฉ ุงููุตุฑููุงุช
CREATE VIEW expense_reconciliation_view AS
SELECT 
    'bank_payment' AS side,
    dt.id, dt.transaction_date, dt.amount, dt.reference_number,
    dt.description, dt.entity_id, s.supplier_name,
    dt.reconciliation_status, dt.created_at
FROM daily_transactions dt
LEFT JOIN suppliers s ON dt.entity_id = s.id AND dt.entity_type = 'supplier'
WHERE dt.credit_clearing_account_id IN (
    SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุจูู%'
)
AND dt.transaction_type IN ('PAYMENT_SUPPLIER', 'EXPENSE_GENERAL')
UNION ALL
SELECT 
    'supplier_invoice' AS side,
    dt.id, dt.transaction_date, dt.amount, dt.reference_number,
    dt.description, dt.entity_id, s.supplier_name,
    dt.reconciliation_status, dt.created_at
FROM daily_transactions dt
LEFT JOIN suppliers s ON dt.entity_id = s.id AND dt.entity_type = 'supplier'
WHERE dt.debit_clearing_account_id IN (
    SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุงูููุฑุฏูู%'
);

-- Function ุชุณููุฉ ุงููุตุฑููุงุช ุงูุชููุงุฆูุฉ
CREATE OR REPLACE FUNCTION auto_reconcile_expenses(
    p_date_from DATE,
    p_date_to DATE,
    p_user_id UUID
)
RETURNS INT AS $$
DECLARE
    v_matched_count INT := 0;
    v_payment RECORD;
    v_invoice RECORD;
BEGIN
    FOR v_payment IN 
        SELECT * FROM daily_transactions 
        WHERE credit_clearing_account_id IN (SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุจูู%')
        AND reconciliation_status = 'pending'
        AND transaction_type IN ('PAYMENT_SUPPLIER', 'EXPENSE_GENERAL')
        AND transaction_date BETWEEN p_date_from AND p_date_to
    LOOP
        SELECT * INTO v_invoice FROM daily_transactions
        WHERE debit_clearing_account_id IN (SELECT id FROM accounts WHERE account_name LIKE '%ูุณูุท ุงูููุฑุฏูู%')
        AND reconciliation_status = 'pending'
        AND amount = v_payment.amount
        AND entity_id = v_payment.entity_id
        AND transaction_date BETWEEN p_date_from AND p_date_to
        LIMIT 1;
        
        IF v_invoice.id IS NOT NULL THEN
            UPDATE daily_transactions SET reconciliation_status = 'matched', reconciled_at = NOW(), reconciled_by = p_user_id
            WHERE id IN (v_payment.id, v_invoice.id);
            v_matched_count := v_matched_count + 1;
        END IF;
    END LOOP;
    
    RETURN v_matched_count;
END;
$$ LANGUAGE plpgsql;
```

---

### 8๏ธโฃ ุชูุงุฑูุฑ ูุฅุดุนุงุฑุงุช ุงูุชุณููุฉ

#### 8.1 ุชูุฑูุฑ ุงูุนูููุงุช ุงููุนููุฉ ุจุงูุชูุงุฏู

```sql
-- View ุชูุงุฏู ุงูุนูููุงุช ุงููุนููุฉ
CREATE VIEW pending_transactions_aging AS
SELECT 
    dt.id, dt.transaction_date, dt.transaction_type, dt.amount,
    dt.reference_number, dt.description,
    da.account_name AS debit_account,
    ca.account_name AS credit_account,
    dt.created_at,
    EXTRACT(DAY FROM NOW() - dt.created_at)::INT AS days_pending,
    CASE 
        WHEN EXTRACT(DAY FROM NOW() - dt.created_at) <= 7 THEN '0-7 ุฃูุงู'
        WHEN EXTRACT(DAY FROM NOW() - dt.created_at) <= 14 THEN '8-14 ููู'
        WHEN EXTRACT(DAY FROM NOW() - dt.created_at) <= 30 THEN '15-30 ููู'
        WHEN EXTRACT(DAY FROM NOW() - dt.created_at) <= 60 THEN '31-60 ููู'
        ELSE 'ุฃูุซุฑ ูู 60 ููู'
    END AS aging_bucket,
    u.full_name AS created_by_name
FROM daily_transactions dt
JOIN accounts da ON dt.debit_clearing_account_id = da.id
JOIN accounts ca ON dt.credit_clearing_account_id = ca.id
JOIN users u ON dt.created_by = u.id
WHERE dt.reconciliation_status = 'pending'
ORDER BY dt.created_at ASC;

-- ููุฎุต ุงูุชูุงุฏู
CREATE VIEW pending_transactions_aging_summary AS
SELECT 
    aging_bucket,
    COUNT(*) AS transaction_count,
    SUM(amount) AS total_amount
FROM pending_transactions_aging
GROUP BY aging_bucket
ORDER BY 
    CASE aging_bucket
        WHEN '0-7 ุฃูุงู' THEN 1
        WHEN '8-14 ููู' THEN 2
        WHEN '15-30 ููู' THEN 3
        WHEN '31-60 ููู' THEN 4
        ELSE 5
    END;
```

#### 8.2 ุฅุดุนุงุฑุงุช ุงูุนูููุงุช ุงููุนููุฉ

```sql
-- ุฌุฏูู ุฅุนุฏุงุฏุงุช ุฅุดุนุงุฑุงุช ุงูุชุณููุฉ
CREATE TABLE reconciliation_alert_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    alert_name VARCHAR(100) NOT NULL,
    days_threshold INT NOT NULL,
    alert_type VARCHAR(50) NOT NULL, -- 'email', 'system', 'both'
    recipient_role VARCHAR(50), -- 'accountant', 'manager', 'admin'
    recipient_user_id UUID REFERENCES users(id),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

INSERT INTO reconciliation_alert_settings (alert_name, days_threshold, alert_type, recipient_role) VALUES
('ุชูุจูู ุฃุณุจูุนู', 7, 'system', 'accountant'),
('ุชูุจูู ุฃุณุจูุนูู', 14, 'both', 'accountant'),
('ุชูุจูู ุดูุฑู', 30, 'both', 'manager'),
('ุชูุจูู ุญุฑุฌ', 60, 'both', 'admin');

-- ุฌุฏูู ุณุฌู ุงูุฅุดุนุงุฑุงุช
CREATE TABLE reconciliation_alerts_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    alert_setting_id UUID REFERENCES reconciliation_alert_settings(id),
    transaction_id UUID REFERENCES daily_transactions(id),
    alert_message TEXT NOT NULL,
    sent_at TIMESTAMP DEFAULT NOW(),
    sent_to UUID REFERENCES users(id),
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP
);

-- Function ุฅูุดุงุก ุฅุดุนุงุฑุงุช ุงูุนูููุงุช ุงููุนููุฉ
CREATE OR REPLACE FUNCTION generate_pending_alerts()
RETURNS INT AS $$
DECLARE
    v_setting RECORD;
    v_transaction RECORD;
    v_alert_count INT := 0;
BEGIN
    FOR v_setting IN SELECT * FROM reconciliation_alert_settings WHERE is_active = TRUE
    LOOP
        FOR v_transaction IN 
            SELECT * FROM daily_transactions 
            WHERE reconciliation_status = 'pending'
            AND EXTRACT(DAY FROM NOW() - created_at) >= v_setting.days_threshold
            AND id NOT IN (
                SELECT transaction_id FROM reconciliation_alerts_log 
                WHERE alert_setting_id = v_setting.id
            )
        LOOP
            INSERT INTO reconciliation_alerts_log (
                alert_setting_id, transaction_id, alert_message
            ) VALUES (
                v_setting.id, v_transaction.id,
                'ุนูููุฉ ูุนููุฉ ููุฐ ' || EXTRACT(DAY FROM NOW() - v_transaction.created_at)::INT || ' ููู - ุงููุจูุบ: ' || v_transaction.amount
            );
            v_alert_count := v_alert_count + 1;
        END LOOP;
    END LOOP;
    
    RETURN v_alert_count;
END;
$$ LANGUAGE plpgsql;

-- Trigger ูููู ูุฅูุดุงุก ุงูุฅุดุนุงุฑุงุช (ููููุฐ ุนุจุฑ cron job)
```

#### 8.3 ุชูุฑูุฑ ููุฎุต ุงูุชุณููุงุช ุงูุดูุฑู

```sql
-- View ููุฎุต ุงูุชุณููุงุช ุงูุดูุฑู
CREATE VIEW monthly_reconciliation_summary AS
SELECT 
    DATE_TRUNC('month', dt.transaction_date) AS month,
    dt.transaction_type,
    COUNT(*) FILTER (WHERE reconciliation_status = 'reconciled') AS reconciled_count,
    COUNT(*) FILTER (WHERE reconciliation_status = 'matched') AS matched_count,
    COUNT(*) FILTER (WHERE reconciliation_status = 'pending') AS pending_count,
    SUM(amount) FILTER (WHERE reconciliation_status = 'reconciled') AS reconciled_amount,
    SUM(amount) FILTER (WHERE reconciliation_status = 'matched') AS matched_amount,
    SUM(amount) FILTER (WHERE reconciliation_status = 'pending') AS pending_amount,
    ROUND(
        COUNT(*) FILTER (WHERE reconciliation_status = 'reconciled')::DECIMAL / 
        NULLIF(COUNT(*), 0) * 100, 2
    ) AS reconciliation_rate
FROM daily_transactions dt
GROUP BY DATE_TRUNC('month', dt.transaction_date), dt.transaction_type
ORDER BY month DESC, transaction_type;

-- Function ุชูุฑูุฑ ุดูุฑู ููุตู
CREATE OR REPLACE FUNCTION get_monthly_reconciliation_report(
    p_year INT,
    p_month INT
)
RETURNS TABLE (
    category VARCHAR,
    total_transactions INT,
    reconciled_transactions INT,
    pending_transactions INT,
    total_amount DECIMAL,
    reconciled_amount DECIMAL,
    pending_amount DECIMAL,
    reconciliation_rate DECIMAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        CASE dt.transaction_type
            WHEN 'COLLECTION_BILLING' THEN 'ุชุญุตูู ููุงุชูุฑ'
            WHEN 'COLLECTION_PREPAID' THEN 'ุชุญุตูู ุฏูุน ูุณุจู'
            WHEN 'COLLECTION_SUPPORT' THEN 'ุชุญุตูู ุตูุฏูู ุฏุนู'
            WHEN 'DEPOSIT_BANK' THEN 'ุชูุฑูุฏ ููุจูู'
            WHEN 'PAYMENT_SUPPLIER' THEN 'ุฏูุน ูููุฑุฏ'
            WHEN 'EXPENSE_GENERAL' THEN 'ูุตุฑูู ุนุงู'
            ELSE dt.transaction_type
        END AS category,
        COUNT(*)::INT AS total_transactions,
        COUNT(*) FILTER (WHERE reconciliation_status = 'reconciled')::INT AS reconciled_transactions,
        COUNT(*) FILTER (WHERE reconciliation_status = 'pending')::INT AS pending_transactions,
        COALESCE(SUM(amount), 0) AS total_amount,
        COALESCE(SUM(amount) FILTER (WHERE reconciliation_status = 'reconciled'), 0) AS reconciled_amount,
        COALESCE(SUM(amount) FILTER (WHERE reconciliation_status = 'pending'), 0) AS pending_amount,
        ROUND(
            COUNT(*) FILTER (WHERE reconciliation_status = 'reconciled')::DECIMAL / 
            NULLIF(COUNT(*), 0) * 100, 2
        ) AS reconciliation_rate
    FROM daily_transactions dt
    WHERE EXTRACT(YEAR FROM dt.transaction_date) = p_year
    AND EXTRACT(MONTH FROM dt.transaction_date) = p_month
    GROUP BY dt.transaction_type;
END;
$$ LANGUAGE plpgsql;
```

---

### 9๏ธโฃ ูุงุฌูุงุช ุงููุณุชุฎุฏู ุงูุฅุถุงููุฉ

#### ุดุงุดุฉ ุชูุฑูุฑ ุงูุชูุงุฏู
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ุชูุฑูุฑ ุชูุงุฏู ุงูุนูููุงุช ุงููุนููุฉ                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงููุชุฑุฉ | ุนุฏุฏ ุงูุนูููุงุช | ุงููุจูุบ ุงูุฅุฌูุงูู | ูุณุจุฉ ูู ุงูุฅุฌูุงูู     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ข 0-7 ุฃูุงู    โ     45      โ   2,500,000    โ     35%        โ
โ ๐ก 8-14 ููู    โ     23      โ   1,200,000    โ     17%        โ
โ ๐ 15-30 ููู   โ     18      โ   1,800,000    โ     25%        โ
โ ๐ด 31-60 ููู   โ     12      โ   1,000,000    โ     14%        โ
โ โซ ุฃูุซุฑ ูู 60  โ      8      โ     600,000    โ      9%        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงูุฅุฌูุงูู       โ    106      โ   7,100,000    โ    100%        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุดุงุดุฉ ุงูุฅุดุนุงุฑุงุช
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ุฅุดุนุงุฑุงุช ุงูุชุณููุฉ                           [ุชุญุฏูุซ] [ุฅุนุฏุงุฏุงุช] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ๏ธ [ุฌุฏูุฏ] ุนูููุฉ ูุนููุฉ ููุฐ 35 ููู - ุชูุฑูุฏ ุจูู 500,000 ุฑ.ู      โ
โ    ุงููุฑุฌุน: DEP-2024-156 | ุงููุณุคูู: ุฃุญูุฏ ูุญูุฏ                   โ
โ    [ุนุฑุถ] [ุชุณููุฉ] [ุชุฌุงูู]                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ๏ธ [ุฌุฏูุฏ] ุนูููุฉ ูุนููุฉ ููุฐ 21 ููู - ุชุญุตูู ูุงุชูุฑุฉ 150,000 ุฑ.ู   โ
โ    ุงููุฑุฌุน: RCP-2024-892 | ุงูุนููู: ุดุฑูุฉ ุงูููุฑ                   โ
โ    [ุนุฑุถ] [ุชุณููุฉ] [ุชุฌุงูู]                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ [ููุฑูุก] ุนูููุฉ ูุนููุฉ ููุฐ 14 ููู - ุฏูุนุฉ ููุฑุฏ 300,000 ุฑ.ู      โ
โ    ุงููุฑุฌุน: PAY-2024-445 | ุงูููุฑุฏ: ูุตูุน ุงูููุจูุงุช                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### ๐ APIs ุงูุฅุถุงููุฉ

```yaml
# ุชุณููุฉ ุงูุฅูุฑุงุฏุงุช
GET    /api/v1/reconciliation/revenues                    # ูุงุฆูุฉ ุนูููุงุช ุงูุฅูุฑุงุฏุงุช
POST   /api/v1/reconciliation/revenues/auto-match         # ูุทุงุจูุฉ ุชููุงุฆูุฉ ููุฅูุฑุงุฏุงุช

# ุชุณููุฉ ุงููุตุฑููุงุช
GET    /api/v1/reconciliation/expenses                    # ูุงุฆูุฉ ุนูููุงุช ุงููุตุฑููุงุช
POST   /api/v1/reconciliation/expenses/auto-match         # ูุทุงุจูุฉ ุชููุงุฆูุฉ ูููุตุฑููุงุช

# ุชูุงุฑูุฑ ุงูุชูุงุฏู
GET    /api/v1/reconciliation/reports/aging               # ุชูุฑูุฑ ุงูุชูุงุฏู
GET    /api/v1/reconciliation/reports/aging/summary       # ููุฎุต ุงูุชูุงุฏู

# ุงูุฅุดุนุงุฑุงุช
GET    /api/v1/reconciliation/alerts                      # ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
PUT    /api/v1/reconciliation/alerts/{id}/read            # ุชุญุฏูุฏ ูููุฑูุก
GET    /api/v1/reconciliation/alerts/settings             # ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
PUT    /api/v1/reconciliation/alerts/settings/{id}        # ุชุญุฏูุซ ุฅุนุฏุงุฏ
POST   /api/v1/reconciliation/alerts/generate             # ุฅูุดุงุก ุฅุดุนุงุฑุงุช ุฌุฏูุฏุฉ

# ุงูุชูุฑูุฑ ุงูุดูุฑู
GET    /api/v1/reconciliation/reports/monthly             # ุงูุชูุฑูุฑ ุงูุดูุฑู
GET    /api/v1/reconciliation/reports/monthly/{year}/{month} # ุชูุฑูุฑ ุดูุฑ ูุญุฏุฏ
```

---

### ููุงุท ุงูุฃูู ุงูุฅุถุงููุฉ ุงููุนุงูุฌุฉ

| ููุทุฉ ุงูุฃูู | ุงูุญู |
|------------|------|
| ุตุนูุจุฉ ุชุชุจุน ุงูุฅูุฑุงุฏุงุช ูุงูุชุญุตููุงุช | ุชุณููุฉ ุงูุฅูุฑุงุฏุงุช ุงูุชููุงุฆูุฉ |
| ุนุฏู ูุทุงุจูุฉ ุงููุฏููุนุงุช ูุน ููุงุชูุฑ ุงูููุฑุฏูู | ุชุณููุฉ ุงููุตุฑููุงุช ุงูุชููุงุฆูุฉ |
| ูุง ูุนุฑูุฉ ุจุนูุฑ ุงูุนูููุงุช ุงููุนููุฉ | ุชูุฑูุฑ ุงูุชูุงุฏู ุงูุชูุตููู |
| ูุณูุงู ุงูุนูููุงุช ุงููุฏููุฉ | ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ูุชุฏุฑุฌุฉ |
| ุตุนูุจุฉ ููุงุณ ุฃุฏุงุก ุงูุชุณููุฉ | ุชูุฑูุฑ ุดูุฑู ุจูุณุจ ุงูุฅูุฌุงุฒ |


---

## ๐ ููู 42: ูุญุฑู ุงูุชุณููุฉ ุงููุฑู (Flexible Reconciliation Engine)

### ุงููุฏู
ุชุญุณูู ูุญุฑู ุงูุชุณููุฉ ููุฏุนู ุนูุงูุงุช ุงูุฑุจุท ุงููุนูุฏุฉ (1:1, 1:N, N:1, N:M) ูุน ุถูุงู ุงูุชูุงุฒู ุงููุญุงุณุจู ูู ูู ุนูููุฉ ุชุณููุฉ.

### ุงูุชุนุฏููุงุช ุงูุฌููุฑูุฉ ุนูู ููู 41

| # | ุงูุชุนุฏูู | ูุจู | ุจุนุฏ |
|---|---------|-----|-----|
| 1 | ูุณุชูู ุงูุญุณุงุจ ุงููุณูุท | ุญุณุงุจ ุฑุฆูุณู | ุญุณุงุจ ูุฑุนู ูุงุจู ูููุนุงููุงุช |
| 2 | ููุน ุงููุทุงุจูุฉ | ุชููุงุฆูุฉ | ูุฏููุฉ ุฐููุฉ ุจูุงุณุทุฉ ุงููุฑุงุฌุน |
| 3 | ุนูุงูุงุช ุงูุชุณููุฉ | 1:1 ููุท | 1:1, 1:N, N:1, N:M |

---

### 1๏ธโฃ ุงููููุฉ 1.1.1 (ููุนุฏููุฉ): ูุญุฑู ุงูุญุณุงุจุงุช ุงููุณูุทุฉ ุงููุฑู

#### ุชุญุฏูุซ ุฌุฏูู ุงูุญุณุงุจุงุช
```sql
-- ุฅุถุงูุฉ ุฎูุงุฑ ุฅูุดุงุก ุญุณุงุจ ูุณูุท ููุญุณุงุจุงุช ุงููุฑุนูุฉ
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS can_have_clearing BOOLEAN DEFAULT FALSE;
ALTER TABLE accounts ADD COLUMN IF NOT EXISTS is_transactional BOOLEAN DEFAULT FALSE;

-- ุชุญุฏูุซ Trigger ูุฅูุดุงุก ุญุณุงุจ ูุณูุท ููุท ููุญุณุงุจุงุช ุงููุฑุนูุฉ ุงููุงุจูุฉ ูููุนุงููุงุช
CREATE OR REPLACE FUNCTION create_clearing_account_flexible()
RETURNS TRIGGER AS $$
DECLARE
    clearing_id UUID;
BEGIN
    -- ููุท ููุญุณุงุจุงุช ุงููุฑุนูุฉ ุงููุงุจูุฉ ูููุนุงููุงุช
    IF NEW.is_transactional = TRUE AND NEW.can_have_clearing = TRUE AND NEW.is_clearing_account = FALSE THEN
        INSERT INTO accounts (
            account_code, account_name, account_type, parent_id,
            is_clearing_account, linked_permanent_account_id, is_active, is_transactional
        ) VALUES (
            NEW.account_code || '-CLR',
            'ุญ/ ูุณูุท ' || NEW.account_name,
            NEW.account_type, NEW.parent_id,
            TRUE, NEW.id, TRUE, FALSE
        ) RETURNING id INTO clearing_id;
        
        UPDATE accounts SET clearing_account_id = clearing_id WHERE id = NEW.id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_create_clearing_account ON accounts;
CREATE TRIGGER trigger_create_clearing_account_flexible
AFTER INSERT OR UPDATE OF can_have_clearing ON accounts
FOR EACH ROW
EXECUTE FUNCTION create_clearing_account_flexible();
```

#### ุฃูุซูุฉ ุงูุญุณุงุจุงุช ุงููุฑุนูุฉ ูุน ุญุณุงุจุงุชูุง ุงููุณูุทุฉ
```sql
-- ุฅูุดุงุก ุญุณุงุจุงุช ูุฑุนูุฉ ูุงุจูุฉ ูููุนุงููุงุช
INSERT INTO accounts (account_code, account_name, account_type, is_transactional, can_have_clearing) VALUES
('1101-001', 'ุจูู ุงูุญูุดุจู - ุญุณุงุจ 123', 'asset', TRUE, TRUE),
('1101-002', 'ุจูู ุงูุญูุดุจู - ุญุณุงุจ 456', 'asset', TRUE, TRUE),
('1102-001', 'ุตูุฏูู ุงูุชุญุตูู ุงูุฑุฆูุณู', 'asset', TRUE, TRUE),
('1102-002', 'ุตูุฏูู ูุฑุน ุตูุนุงุก', 'asset', TRUE, TRUE),
('4101-001', 'ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ ุงูุนุงุฏูุฉ', 'revenue', TRUE, TRUE),
('4101-002', 'ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู', 'revenue', TRUE, TRUE),
('4101-003', 'ุฅูุฑุงุฏุงุช ุตูุฏูู ุงูุฏุนู', 'revenue', TRUE, TRUE);
```

---

### 2๏ธโฃ ุงููููุฉ 1.1.3 (ููุนุฏููุฉ): ูุฑูุฒ ุงูุชุณููุฉ ุงููุฑู

#### ุฌุฏูู ุณูุฉ ุงูุชุณููุฉ
```sql
-- ุณูุฉ ุงูุชุณููุฉ ุงููุคูุชุฉ ููู ูุณุชุฎุฏู
CREATE TABLE reconciliation_basket (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    session_id UUID REFERENCES reconciliation_sessions(id),
    transaction_id UUID NOT NULL REFERENCES daily_transactions(id),
    side VARCHAR(10) NOT NULL CHECK (side IN ('debit', 'credit')),
    amount DECIMAL(15,2) NOT NULL,
    clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    added_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, transaction_id)
);

CREATE INDEX idx_basket_user ON reconciliation_basket(user_id);
CREATE INDEX idx_basket_session ON reconciliation_basket(session_id);
```

#### ุฌุฏูู ุงูุชุณููุงุช ุงููุฑูุฉ (ุฏุนู N:M)
```sql
-- ุชุญุฏูุซ ุฌุฏูู ุงููุทุงุจูุงุช ูุฏุนู ุงูุนูุงูุงุช ุงููุนูุฏุฉ
CREATE TABLE flexible_reconciliation_groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES reconciliation_sessions(id),
    group_name VARCHAR(200),
    total_debit DECIMAL(15,2) NOT NULL,
    total_credit DECIMAL(15,2) NOT NULL,
    is_balanced BOOLEAN GENERATED ALWAYS AS (total_debit = total_credit) STORED,
    status VARCHAR(20) DEFAULT 'pending',
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    reconciled_at TIMESTAMP,
    reconciled_by UUID REFERENCES users(id),
    notes TEXT
);

-- ุชูุงุตูู ุงููุฌููุนุฉ (ุงูุญุฑูุงุช ุงููุฑุชุจุทุฉ)
CREATE TABLE flexible_reconciliation_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    group_id UUID NOT NULL REFERENCES flexible_reconciliation_groups(id) ON DELETE CASCADE,
    transaction_id UUID NOT NULL REFERENCES daily_transactions(id),
    side VARCHAR(10) NOT NULL CHECK (side IN ('debit', 'credit')),
    amount DECIMAL(15,2) NOT NULL,
    clearing_account_id UUID NOT NULL REFERENCES accounts(id),
    UNIQUE(group_id, transaction_id)
);

CREATE INDEX idx_flex_items_group ON flexible_reconciliation_items(group_id);
CREATE INDEX idx_flex_items_transaction ON flexible_reconciliation_items(transaction_id);
```

#### Function ุฅุถุงูุฉ ุญุฑูุฉ ููุณูุฉ
```sql
CREATE OR REPLACE FUNCTION add_to_reconciliation_basket(
    p_user_id UUID,
    p_transaction_id UUID,
    p_side VARCHAR(10)
)
RETURNS JSONB AS $$
DECLARE
    v_transaction RECORD;
    v_basket_total JSONB;
BEGIN
    -- ุฌูุจ ุจูุงูุงุช ุงูุญุฑูุฉ
    SELECT * INTO v_transaction FROM daily_transactions WHERE id = p_transaction_id;
    
    IF v_transaction.reconciliation_status != 'pending' THEN
        RETURN jsonb_build_object('success', FALSE, 'error', 'ุงูุญุฑูุฉ ุชูุช ุชุณููุชูุง ูุณุจูุงู');
    END IF;
    
    -- ุฅุถุงูุฉ ููุณูุฉ
    INSERT INTO reconciliation_basket (user_id, transaction_id, side, amount, clearing_account_id)
    VALUES (
        p_user_id, p_transaction_id, p_side, v_transaction.amount,
        CASE WHEN p_side = 'debit' THEN v_transaction.debit_clearing_account_id 
             ELSE v_transaction.credit_clearing_account_id END
    )
    ON CONFLICT (user_id, transaction_id) DO UPDATE SET side = p_side;
    
    -- ุญุณุงุจ ุฅุฌูุงููุงุช ุงูุณูุฉ
    SELECT jsonb_build_object(
        'success', TRUE,
        'total_debit', COALESCE(SUM(amount) FILTER (WHERE side = 'debit'), 0),
        'total_credit', COALESCE(SUM(amount) FILTER (WHERE side = 'credit'), 0),
        'item_count', COUNT(*),
        'is_balanced', COALESCE(SUM(amount) FILTER (WHERE side = 'debit'), 0) = 
                       COALESCE(SUM(amount) FILTER (WHERE side = 'credit'), 0)
    ) INTO v_basket_total
    FROM reconciliation_basket WHERE user_id = p_user_id;
    
    RETURN v_basket_total;
END;
$$ LANGUAGE plpgsql;
```

#### Function ุชูููุฐ ุงูุชุณููุฉ ุงููุฑูุฉ
```sql
CREATE OR REPLACE FUNCTION execute_flexible_reconciliation(
    p_user_id UUID,
    p_session_id UUID,
    p_notes TEXT DEFAULT NULL
)
RETURNS JSONB AS $$
DECLARE
    v_group_id UUID;
    v_total_debit DECIMAL(15,2);
    v_total_credit DECIMAL(15,2);
    v_item RECORD;
BEGIN
    -- ุญุณุงุจ ุงูุฅุฌูุงููุงุช
    SELECT 
        COALESCE(SUM(amount) FILTER (WHERE side = 'debit'), 0),
        COALESCE(SUM(amount) FILTER (WHERE side = 'credit'), 0)
    INTO v_total_debit, v_total_credit
    FROM reconciliation_basket WHERE user_id = p_user_id;
    
    -- ุงูุชุญูู ูู ุงูุชูุงุฒู
    IF v_total_debit != v_total_credit THEN
        RETURN jsonb_build_object(
            'success', FALSE, 
            'error', 'ุฅุฌูุงูู ุงููุฏูู (' || v_total_debit || ') ูุง ูุณุงูู ุฅุฌูุงูู ุงูุฏุงุฆู (' || v_total_credit || ')'
        );
    END IF;
    
    IF v_total_debit = 0 THEN
        RETURN jsonb_build_object('success', FALSE, 'error', 'ุงูุณูุฉ ูุงุฑุบุฉ');
    END IF;
    
    -- ุฅูุดุงุก ูุฌููุนุฉ ุงูุชุณููุฉ
    INSERT INTO flexible_reconciliation_groups (
        session_id, total_debit, total_credit, created_by, notes
    ) VALUES (
        p_session_id, v_total_debit, v_total_credit, p_user_id, p_notes
    ) RETURNING id INTO v_group_id;
    
    -- ููู ุงูุนูุงุตุฑ ูู ุงูุณูุฉ ุฅูู ุงููุฌููุนุฉ
    INSERT INTO flexible_reconciliation_items (group_id, transaction_id, side, amount, clearing_account_id)
    SELECT v_group_id, transaction_id, side, amount, clearing_account_id
    FROM reconciliation_basket WHERE user_id = p_user_id;
    
    -- ุชุญุฏูุซ ุญุงูุฉ ุงูุญุฑูุงุช
    UPDATE daily_transactions 
    SET reconciliation_status = 'matched', 
        reconciliation_id = v_group_id,
        updated_at = NOW()
    WHERE id IN (SELECT transaction_id FROM reconciliation_basket WHERE user_id = p_user_id);
    
    -- ุชูุฑูุบ ุงูุณูุฉ
    DELETE FROM reconciliation_basket WHERE user_id = p_user_id;
    
    RETURN jsonb_build_object(
        'success', TRUE,
        'group_id', v_group_id,
        'total_amount', v_total_debit,
        'items_count', (SELECT COUNT(*) FROM flexible_reconciliation_items WHERE group_id = v_group_id)
    );
END;
$$ LANGUAGE plpgsql;
```

#### Function ุฅูุบุงุก ุงูุชุณููุฉ
```sql
CREATE OR REPLACE FUNCTION undo_flexible_reconciliation(
    p_group_id UUID,
    p_user_id UUID
)
RETURNS JSONB AS $$
BEGIN
    -- ุฅุนุงุฏุฉ ุญุงูุฉ ุงูุญุฑูุงุช ุฅูู ูุนููุฉ
    UPDATE daily_transactions 
    SET reconciliation_status = 'pending', 
        reconciliation_id = NULL,
        updated_at = NOW()
    WHERE id IN (SELECT transaction_id FROM flexible_reconciliation_items WHERE group_id = p_group_id);
    
    -- ุญุฐู ุงููุฌููุนุฉ (ุณูุญุฐู ุงูุนูุงุตุฑ ุชููุงุฆูุงู ุจุณุจุจ ON DELETE CASCADE)
    DELETE FROM flexible_reconciliation_groups WHERE id = p_group_id;
    
    RETURN jsonb_build_object('success', TRUE, 'message', 'ุชู ุฅูุบุงุก ุงูุชุณููุฉ ุจูุฌุงุญ');
END;
$$ LANGUAGE plpgsql;
```

---

### 3๏ธโฃ ูุงุฌูุฉ ูุฑูุฒ ุงูุชุณููุฉ ุงููุฑู

#### ุดุงุดุฉ ูุชุนุฏุฏุฉ ุงูุฃููุงุญ
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ูุฑูุฒ ุงูุชุณููุฉ ุงููุฑู                                    [+ ุฅุถุงูุฉ ููุญ] [ุญูุธ ุงูุชุฎุทูุท]  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                        โ
โ โ ๐ ุญ/ ูุณูุท ุตูุฏูู ุงูุชุญุตูู   โ โ ๐ ุญ/ ูุณูุท ุจูู ุงูุญูุดุจู     โ                        โ
โ โ [ร]                        โ โ [ร]                        โ                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                        โ
โ โ โ 15/12 ูุฏูู 100,000 ููุชุฑุฉ โ โ โ 15/12 ูุฏูู 500,000 ุฅูุฏุงุน โ                        โ
โ โ โ 15/12 ูุฏูู 50,000 ูุณุจู   โ โ โ 16/12 ูุฏูู 300,000 ุฅูุฏุงุน โ                        โ
โ โ โ 15/12 ุฏุงุฆู 150,000 ุชูุฑูุฏ โ โ โ 16/12 ูุฏูู 200,000 ุฅูุฏุงุน โ                        โ
โ โ โ 16/12 ุฏุงุฆู 500,000 ุชูุฑูุฏ โ โ โ 17/12 ุฏุงุฆู 100,000 ุณุญุจ   โ                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                        โ
โ โ ๐ ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ โ โ ๐ ุญ/ ูุณูุท ุฅูุฑุงุฏุงุช ุงูุฏูุน   โ                        โ
โ โ [ร]                        โ โ ุงููุณุจู [ร]                 โ                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                        โ
โ โ โ 15/12 ุฏุงุฆู 100,000       โ โ โ 15/12 ุฏุงุฆู 50,000        โ                        โ
โ โ โ 16/12 ุฏุงุฆู 200,000       โ โ โ 16/12 ุฏุงุฆู 80,000        โ                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ุณูุฉ ุงูุชุณููุฉ                                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฅ ูุฏูู                                โ ๐ค ุฏุงุฆู                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โข 100,000 - ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ       โ โข 150,000 - ูุณูุท ุตูุฏูู ุงูุชุญุตูู               โ
โ โข 50,000 - ูุณูุท ุฅูุฑุงุฏุงุช ุงูุฏูุน ุงููุณุจู   โ                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงูุฅุฌูุงูู: 150,000 โ                   โ ุงูุฅุฌูุงูู: 150,000 โ                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [๐๏ธ ุชูุฑูุบ ุงูุณูุฉ]  [โฉ๏ธ ุฅุฒุงูุฉ ุงููุญุฏุฏ]  [โ ุชุณููุฉ] โ ูุชุงุญ (ุงููุฏูู = ุงูุฏุงุฆู)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 4๏ธโฃ ุณููุงุฑูููุงุช ุงูุชุณููุฉ ุงููุฏุนููุฉ

#### ุณููุงุฑูู 1: ูุงุญุฏ ุฅูู ูุงุญุฏ (1:1)
```
ุชูุฑูุฏ 500,000 ูู ุงูุตูุฏูู โ ุฅูุฏุงุน 500,000 ูู ุงูุจูู
```

#### ุณููุงุฑูู 2: ูุชุนุฏุฏ ุฅูู ูุงุญุฏ (N:1)
```
ุฅูุฑุงุฏ ููุชุฑุฉ 100,000 + ุฅูุฑุงุฏ ูุณุจู 50,000 โ ุชูุฑูุฏ 150,000 ููุจูู
```

#### ุณููุงุฑูู 3: ูุงุญุฏ ุฅูู ูุชุนุฏุฏ (1:N)
```
ุชูุฑูุฏ 500,000 ูู ุงูุตูุฏูู โ ุฅูุฏุงุน 300,000 + ุฅูุฏุงุน 200,000 (ุชุฌุฒุฆุฉ ุงูุจูู)
```

#### ุณููุงุฑูู 4: ูุชุนุฏุฏ ุฅูู ูุชุนุฏุฏ (N:M)
```
ุฅูุฑุงุฏ ููุชุฑุฉ 100,000 + ุฅูุฑุงุฏ ูุณุจู 80,000 + ุฅูุฑุงุฏ ุฏุนู 20,000 
    โ ุชูุฑูุฏ 150,000 + ุชูุฑูุฏ 50,000 (ุชูุฑูุฏูู ูููุตููู)
```

---

### 5๏ธโฃ View ุงูุชุณููุงุช ุงููุฑูุฉ

```sql
-- ุนุฑุถ ูุฌููุนุงุช ุงูุชุณููุฉ ูุน ุชูุงุตูููุง
CREATE VIEW flexible_reconciliation_summary AS
SELECT 
    frg.id AS group_id,
    frg.session_id,
    frg.total_debit,
    frg.total_credit,
    frg.is_balanced,
    frg.status,
    frg.created_at,
    frg.notes,
    u.full_name AS created_by_name,
    COUNT(fri.id) AS items_count,
    COUNT(DISTINCT fri.clearing_account_id) AS accounts_count,
    jsonb_agg(jsonb_build_object(
        'transaction_id', fri.transaction_id,
        'side', fri.side,
        'amount', fri.amount,
        'account_name', a.account_name
    )) AS items
FROM flexible_reconciliation_groups frg
JOIN users u ON frg.created_by = u.id
LEFT JOIN flexible_reconciliation_items fri ON frg.id = fri.group_id
LEFT JOIN accounts a ON fri.clearing_account_id = a.id
GROUP BY frg.id, u.full_name;
```

---

### 6๏ธโฃ APIs ุงูุฅุถุงููุฉ

```yaml
# ุณูุฉ ุงูุชุณููุฉ
POST   /api/v1/reconciliation/basket/add                  # ุฅุถุงูุฉ ุญุฑูุฉ ููุณูุฉ
DELETE /api/v1/reconciliation/basket/remove/{id}          # ุฅุฒุงูุฉ ุญุฑูุฉ ูู ุงูุณูุฉ
GET    /api/v1/reconciliation/basket                      # ุนุฑุถ ูุญุชููุงุช ุงูุณูุฉ
DELETE /api/v1/reconciliation/basket/clear                # ุชูุฑูุบ ุงูุณูุฉ

# ุงูุชุณููุฉ ุงููุฑูุฉ
POST   /api/v1/reconciliation/flexible/execute            # ุชูููุฐ ุงูุชุณููุฉ
DELETE /api/v1/reconciliation/flexible/undo/{group_id}    # ุฅูุบุงุก ุชุณููุฉ
GET    /api/v1/reconciliation/flexible/groups             # ูุงุฆูุฉ ูุฌููุนุงุช ุงูุชุณููุฉ
GET    /api/v1/reconciliation/flexible/groups/{id}        # ุชูุงุตูู ูุฌููุนุฉ

# ุงูุฃููุงุญ
GET    /api/v1/reconciliation/panels/accounts             # ุงูุญุณุงุจุงุช ุงููุชุงุญุฉ ููุฃููุงุญ
GET    /api/v1/reconciliation/panels/{account_id}/pending # ุงูุญุฑูุงุช ุงููุนููุฉ ูุญุณุงุจ
POST   /api/v1/reconciliation/panels/layout/save          # ุญูุธ ุชุฎุทูุท ุงูุฃููุงุญ
GET    /api/v1/reconciliation/panels/layout               # ุงุณุชุฑุฌุงุน ุชุฎุทูุท ุงูุฃููุงุญ
```

---

### ููุงุท ุงูุฃูู ุงููุนุงูุฌุฉ (ุฅุถุงูุฉ ุนูู ููู 41)

| ููุทุฉ ุงูุฃูู | ุงูุญู |
|------------|------|
| ุนูุงูุงุช ุงูุชุณููุฉ ูุญุฏูุฏุฉ ุจู 1:1 | ุฏุนู 1:N, N:1, N:M |
| ุงููุทุงุจูุฉ ุงูุชููุงุฆูุฉ ูุฏ ุชุฎุทุฆ | ุงููุฑุงุฌุน ุงูุจุดุฑู ูุญุฏุฏ ุงูุนูุงูุงุช |
| ุตุนูุจุฉ ุฑุคูุฉ ุนุฏุฉ ุญุณุงุจุงุช ูุนุงู | ูุงุฌูุฉ ูุชุนุฏุฏุฉ ุงูุฃููุงุญ |
| ูุง ูุฑููุฉ ูู ุงุฎุชูุงุฑ ุงูุญุฑูุงุช | ุณูุฉ ุงูุชุณููุฉ ูุน ุงูุชุญูู ูู ุงูุชูุงุฒู |
| ุงูุญุณุงุจุงุช ุงููุณูุทุฉ ุนูู ูุณุชูู ุฎุงุทุฆ | ุฑุจุท ุจุงูุญุณุงุจุงุช ุงููุฑุนูุฉ ุงููุงุจูุฉ ูููุนุงููุงุช |


---

## ๐ ููู 42 (ุชูููุฉ): ุงูููุฒุงุช ุงููุชูุฏูุฉ ููุญุฑู ุงูุชุณููุฉ ุงููุฑู

### 7๏ธโฃ ุญูุธ ุชุฎุทูุท ุงูุฃููุงุญ

#### ุฌุฏูู ุชุฎุทูุทุงุช ุงูุฃููุงุญ
```sql
-- ุญูุธ ุชุฎุทูุท ุงูุฃููุงุญ ููู ูุณุชุฎุฏู
CREATE TABLE user_panel_layouts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    layout_name VARCHAR(100) NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,
    panels JSONB NOT NULL, -- [{account_id, position, width, height, is_minimized}]
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, layout_name)
);

CREATE INDEX idx_panel_layouts_user ON user_panel_layouts(user_id);

-- ุชุฎุทูุท ุงูุชุฑุงุถู ูููุณุชุฎุฏููู ุงูุฌุฏุฏ
INSERT INTO user_panel_layouts (user_id, layout_name, is_default, panels) VALUES
(NULL, 'ุงูุชุฎุทูุท ุงูุงูุชุฑุงุถู', TRUE, '[
    {"account_type": "cash", "position": 1, "width": 50, "height": 50, "is_minimized": false},
    {"account_type": "bank", "position": 2, "width": 50, "height": 50, "is_minimized": false},
    {"account_type": "revenue", "position": 3, "width": 50, "height": 50, "is_minimized": false},
    {"account_type": "prepaid", "position": 4, "width": 50, "height": 50, "is_minimized": false}
]');
```

#### Function ุญูุธ ุงูุชุฎุทูุท
```sql
CREATE OR REPLACE FUNCTION save_panel_layout(
    p_user_id UUID,
    p_layout_name VARCHAR(100),
    p_panels JSONB,
    p_is_default BOOLEAN DEFAULT FALSE
)
RETURNS JSONB AS $$
DECLARE
    v_layout_id UUID;
BEGIN
    -- ุฅุฐุง ูุงู ุงูุชุฑุงุถูุ ุฅูุบุงุก ุงูุงูุชุฑุงุถู ุงูุณุงุจู
    IF p_is_default THEN
        UPDATE user_panel_layouts SET is_default = FALSE WHERE user_id = p_user_id;
    END IF;
    
    -- ุฅุฏุฑุงุฌ ุฃู ุชุญุฏูุซ
    INSERT INTO user_panel_layouts (user_id, layout_name, is_default, panels)
    VALUES (p_user_id, p_layout_name, p_is_default, p_panels)
    ON CONFLICT (user_id, layout_name) DO UPDATE SET
        panels = p_panels,
        is_default = p_is_default,
        updated_at = NOW()
    RETURNING id INTO v_layout_id;
    
    RETURN jsonb_build_object('success', TRUE, 'layout_id', v_layout_id);
END;
$$ LANGUAGE plpgsql;
```

---

### 8๏ธโฃ ุงูุจุญุซ ูุงูููุชุฑุฉ ูู ุงูุฃููุงุญ

#### Function ุงูุจุญุซ ุงููุชูุฏู ูู ุงูุญุฑูุงุช
```sql
CREATE OR REPLACE FUNCTION search_panel_transactions(
    p_clearing_account_id UUID,
    p_date_from DATE DEFAULT NULL,
    p_date_to DATE DEFAULT NULL,
    p_amount_min DECIMAL(15,2) DEFAULT NULL,
    p_amount_max DECIMAL(15,2) DEFAULT NULL,
    p_description_search TEXT DEFAULT NULL,
    p_status VARCHAR(20) DEFAULT 'pending', -- pending, matched, all
    p_side VARCHAR(10) DEFAULT NULL, -- debit, credit, NULL for both
    p_limit INT DEFAULT 100,
    p_offset INT DEFAULT 0
)
RETURNS TABLE (
    transaction_id UUID,
    transaction_date DATE,
    amount DECIMAL(15,2),
    side VARCHAR(10),
    description TEXT,
    reference_number VARCHAR(50),
    status VARCHAR(20),
    days_pending INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        dt.id AS transaction_id,
        dt.transaction_date,
        dt.amount,
        CASE 
            WHEN dt.debit_clearing_account_id = p_clearing_account_id THEN 'debit'
            ELSE 'credit'
        END AS side,
        dt.description,
        dt.reference_number,
        dt.reconciliation_status AS status,
        (CURRENT_DATE - dt.transaction_date)::INT AS days_pending
    FROM daily_transactions dt
    WHERE (dt.debit_clearing_account_id = p_clearing_account_id 
           OR dt.credit_clearing_account_id = p_clearing_account_id)
    AND (p_date_from IS NULL OR dt.transaction_date >= p_date_from)
    AND (p_date_to IS NULL OR dt.transaction_date <= p_date_to)
    AND (p_amount_min IS NULL OR dt.amount >= p_amount_min)
    AND (p_amount_max IS NULL OR dt.amount <= p_amount_max)
    AND (p_description_search IS NULL OR dt.description ILIKE '%' || p_description_search || '%')
    AND (p_status = 'all' OR dt.reconciliation_status = p_status)
    AND (p_side IS NULL OR 
         (p_side = 'debit' AND dt.debit_clearing_account_id = p_clearing_account_id) OR
         (p_side = 'credit' AND dt.credit_clearing_account_id = p_clearing_account_id))
    ORDER BY dt.transaction_date DESC, dt.amount DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;
```

#### View ุฅุญุตุงุฆูุงุช ุงูุจุญุซ
```sql
CREATE VIEW panel_search_stats AS
SELECT 
    a.id AS clearing_account_id,
    a.account_name,
    COUNT(*) FILTER (WHERE dt.reconciliation_status = 'pending') AS pending_count,
    COUNT(*) FILTER (WHERE dt.reconciliation_status = 'matched') AS matched_count,
    COALESCE(SUM(dt.amount) FILTER (WHERE dt.reconciliation_status = 'pending' 
        AND dt.debit_clearing_account_id = a.id), 0) AS pending_debit_total,
    COALESCE(SUM(dt.amount) FILTER (WHERE dt.reconciliation_status = 'pending' 
        AND dt.credit_clearing_account_id = a.id), 0) AS pending_credit_total
FROM accounts a
LEFT JOIN daily_transactions dt ON 
    dt.debit_clearing_account_id = a.id OR dt.credit_clearing_account_id = a.id
WHERE a.is_clearing_account = TRUE
GROUP BY a.id, a.account_name;
```

---

### 9๏ธโฃ ุชุตุฏูุฑ ูุฌููุนุฉ ุงูุชุณููุฉ

#### Function ุชุตุฏูุฑ ูุฌููุนุฉ ุงูุชุณููุฉ
```sql
CREATE OR REPLACE FUNCTION export_reconciliation_group(
    p_group_id UUID
)
RETURNS JSONB AS $$
DECLARE
    v_group RECORD;
    v_items JSONB;
BEGIN
    -- ุฌูุจ ุจูุงูุงุช ุงููุฌููุนุฉ
    SELECT 
        frg.*,
        u.full_name AS created_by_name,
        rs.session_name
    INTO v_group
    FROM flexible_reconciliation_groups frg
    JOIN users u ON frg.created_by = u.id
    LEFT JOIN reconciliation_sessions rs ON frg.session_id = rs.id
    WHERE frg.id = p_group_id;
    
    IF v_group IS NULL THEN
        RETURN jsonb_build_object('success', FALSE, 'error', 'ูุฌููุนุฉ ุงูุชุณููุฉ ุบูุฑ ููุฌูุฏุฉ');
    END IF;
    
    -- ุฌูุจ ุงูุนูุงุตุฑ
    SELECT jsonb_agg(jsonb_build_object(
        'transaction_date', dt.transaction_date,
        'description', dt.description,
        'reference_number', dt.reference_number,
        'side', fri.side,
        'amount', fri.amount,
        'account_name', a.account_name,
        'account_code', a.account_code
    ) ORDER BY fri.side, dt.transaction_date)
    INTO v_items
    FROM flexible_reconciliation_items fri
    JOIN daily_transactions dt ON fri.transaction_id = dt.id
    JOIN accounts a ON fri.clearing_account_id = a.id
    WHERE fri.group_id = p_group_id;
    
    RETURN jsonb_build_object(
        'success', TRUE,
        'group', jsonb_build_object(
            'id', v_group.id,
            'session_name', v_group.session_name,
            'total_debit', v_group.total_debit,
            'total_credit', v_group.total_credit,
            'created_at', v_group.created_at,
            'created_by', v_group.created_by_name,
            'notes', v_group.notes
        ),
        'items', v_items,
        'debit_items', (SELECT jsonb_agg(x) FROM jsonb_array_elements(v_items) x WHERE x->>'side' = 'debit'),
        'credit_items', (SELECT jsonb_agg(x) FROM jsonb_array_elements(v_items) x WHERE x->>'side' = 'credit')
    );
END;
$$ LANGUAGE plpgsql;
```

#### ุฌุฏูู ุณุฌู ุงูุชุตุฏูุฑ
```sql
CREATE TABLE reconciliation_exports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    group_id UUID NOT NULL REFERENCES flexible_reconciliation_groups(id),
    export_format VARCHAR(10) NOT NULL CHECK (export_format IN ('pdf', 'excel', 'json')),
    file_path TEXT,
    exported_by UUID NOT NULL REFERENCES users(id),
    exported_at TIMESTAMP DEFAULT NOW()
);
```

---

### ๐ ุณุฌู ุชุงุฑูุฎ ุงูุชุณููุงุช

#### View ุณุฌู ุงูุชุณููุงุช ุงูุดุงูู
```sql
CREATE VIEW reconciliation_history AS
SELECT 
    frg.id AS group_id,
    frg.session_id,
    rs.session_name,
    frg.total_debit,
    frg.total_credit,
    frg.status,
    frg.created_at,
    frg.reconciled_at,
    frg.notes,
    u_created.full_name AS created_by_name,
    u_reconciled.full_name AS reconciled_by_name,
    COUNT(fri.id) AS items_count,
    COUNT(DISTINCT fri.clearing_account_id) AS accounts_count,
    MIN(dt.transaction_date) AS earliest_transaction_date,
    MAX(dt.transaction_date) AS latest_transaction_date,
    jsonb_agg(DISTINCT a.account_name) AS involved_accounts
FROM flexible_reconciliation_groups frg
JOIN users u_created ON frg.created_by = u_created.id
LEFT JOIN users u_reconciled ON frg.reconciled_by = u_reconciled.id
LEFT JOIN reconciliation_sessions rs ON frg.session_id = rs.id
LEFT JOIN flexible_reconciliation_items fri ON frg.id = fri.group_id
LEFT JOIN daily_transactions dt ON fri.transaction_id = dt.id
LEFT JOIN accounts a ON fri.clearing_account_id = a.id
GROUP BY frg.id, rs.session_name, u_created.full_name, u_reconciled.full_name;
```

#### Function ุงูุจุญุซ ูู ุณุฌู ุงูุชุณููุงุช
```sql
CREATE OR REPLACE FUNCTION search_reconciliation_history(
    p_date_from DATE DEFAULT NULL,
    p_date_to DATE DEFAULT NULL,
    p_amount_min DECIMAL(15,2) DEFAULT NULL,
    p_amount_max DECIMAL(15,2) DEFAULT NULL,
    p_account_id UUID DEFAULT NULL,
    p_created_by UUID DEFAULT NULL,
    p_status VARCHAR(20) DEFAULT NULL,
    p_limit INT DEFAULT 50,
    p_offset INT DEFAULT 0
)
RETURNS TABLE (
    group_id UUID,
    session_name VARCHAR(100),
    total_amount DECIMAL(15,2),
    items_count BIGINT,
    accounts_count BIGINT,
    created_at TIMESTAMP,
    created_by_name VARCHAR(100),
    status VARCHAR(20),
    involved_accounts JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        rh.group_id,
        rh.session_name,
        rh.total_debit AS total_amount,
        rh.items_count,
        rh.accounts_count,
        rh.created_at,
        rh.created_by_name,
        rh.status,
        rh.involved_accounts
    FROM reconciliation_history rh
    WHERE (p_date_from IS NULL OR rh.created_at::DATE >= p_date_from)
    AND (p_date_to IS NULL OR rh.created_at::DATE <= p_date_to)
    AND (p_amount_min IS NULL OR rh.total_debit >= p_amount_min)
    AND (p_amount_max IS NULL OR rh.total_debit <= p_amount_max)
    AND (p_status IS NULL OR rh.status = p_status)
    ORDER BY rh.created_at DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;
```

---

### 1๏ธโฃ1๏ธโฃ ุชูุฑูุฑ ุงูุญุฑูุงุช ุงููุนููุฉ ููู ุญุณุงุจ

#### View ููุฎุต ุงูุญุฑูุงุช ุงููุนููุฉ
```sql
CREATE VIEW pending_transactions_summary AS
SELECT 
    a.id AS clearing_account_id,
    a.account_code,
    a.account_name,
    pa.account_name AS permanent_account_name,
    COUNT(*) AS pending_count,
    COALESCE(SUM(dt.amount) FILTER (WHERE dt.debit_clearing_account_id = a.id), 0) AS pending_debit_total,
    COALESCE(SUM(dt.amount) FILTER (WHERE dt.credit_clearing_account_id = a.id), 0) AS pending_credit_total,
    MIN(dt.transaction_date) AS oldest_pending_date,
    MAX(dt.transaction_date) AS newest_pending_date,
    MAX(CURRENT_DATE - dt.transaction_date) AS max_days_pending,
    AVG(CURRENT_DATE - dt.transaction_date)::INT AS avg_days_pending
FROM accounts a
LEFT JOIN accounts pa ON a.linked_permanent_account_id = pa.id
LEFT JOIN daily_transactions dt ON 
    (dt.debit_clearing_account_id = a.id OR dt.credit_clearing_account_id = a.id)
    AND dt.reconciliation_status = 'pending'
WHERE a.is_clearing_account = TRUE
GROUP BY a.id, a.account_code, a.account_name, pa.account_name;
```

#### View ุชูุตูู ุงูุญุฑูุงุช ุงููุนููุฉ ุจุงูุชูุงุฏู
```sql
CREATE VIEW pending_transactions_aging_detail AS
SELECT 
    a.id AS clearing_account_id,
    a.account_name,
    dt.id AS transaction_id,
    dt.transaction_date,
    dt.amount,
    dt.description,
    dt.reference_number,
    CASE 
        WHEN dt.debit_clearing_account_id = a.id THEN 'debit'
        ELSE 'credit'
    END AS side,
    (CURRENT_DATE - dt.transaction_date) AS days_pending,
    CASE 
        WHEN (CURRENT_DATE - dt.transaction_date) <= 7 THEN '0-7 ุฃูุงู'
        WHEN (CURRENT_DATE - dt.transaction_date) <= 14 THEN '8-14 ููู'
        WHEN (CURRENT_DATE - dt.transaction_date) <= 30 THEN '15-30 ููู'
        WHEN (CURRENT_DATE - dt.transaction_date) <= 60 THEN '31-60 ููู'
        ELSE 'ุฃูุซุฑ ูู 60 ููู'
    END AS aging_bucket
FROM accounts a
JOIN daily_transactions dt ON 
    (dt.debit_clearing_account_id = a.id OR dt.credit_clearing_account_id = a.id)
WHERE a.is_clearing_account = TRUE
AND dt.reconciliation_status = 'pending';
```

#### View ููุฎุต ุงูุชูุงุฏู
```sql
CREATE VIEW pending_transactions_aging_summary AS
SELECT 
    clearing_account_id,
    account_name,
    COUNT(*) FILTER (WHERE days_pending <= 7) AS bucket_0_7,
    COUNT(*) FILTER (WHERE days_pending BETWEEN 8 AND 14) AS bucket_8_14,
    COUNT(*) FILTER (WHERE days_pending BETWEEN 15 AND 30) AS bucket_15_30,
    COUNT(*) FILTER (WHERE days_pending BETWEEN 31 AND 60) AS bucket_31_60,
    COUNT(*) FILTER (WHERE days_pending > 60) AS bucket_over_60,
    SUM(amount) FILTER (WHERE days_pending <= 7) AS amount_0_7,
    SUM(amount) FILTER (WHERE days_pending BETWEEN 8 AND 14) AS amount_8_14,
    SUM(amount) FILTER (WHERE days_pending BETWEEN 15 AND 30) AS amount_15_30,
    SUM(amount) FILTER (WHERE days_pending BETWEEN 31 AND 60) AS amount_31_60,
    SUM(amount) FILTER (WHERE days_pending > 60) AS amount_over_60
FROM pending_transactions_aging_detail
GROUP BY clearing_account_id, account_name;
```

---

### 1๏ธโฃ2๏ธโฃ ุฅุดุนุงุฑุงุช ุงูุชูุงู ุงูุชุณููุฉ

#### ุฌุฏูู ุฅุนุฏุงุฏุงุช ุฅุดุนุงุฑุงุช ุงูุชุณููุฉ
```sql
CREATE TABLE reconciliation_notification_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    notification_type VARCHAR(50) NOT NULL,
    threshold_amount DECIMAL(15,2), -- ูููุจุงูุบ ุงููุจูุฑุฉ
    notify_roles TEXT[], -- ุงูุฃุฏูุงุฑ ุงูุชู ุชุณุชูู ุงูุฅุดุนุงุฑ
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ุฅุนุฏุงุฏุงุช ุงูุชุฑุงุถูุฉ
INSERT INTO reconciliation_notification_settings (notification_type, threshold_amount, notify_roles) VALUES
('large_reconciliation', 100000, ARRAY['financial_manager', 'cfo']),
('daily_summary', NULL, ARRAY['accountant', 'financial_manager']),
('pending_alert', NULL, ARRAY['accountant']),
('weekly_report', NULL, ARRAY['financial_manager', 'cfo']);
```

#### ุฌุฏูู ุฅุดุนุงุฑุงุช ุงูุชุณููุฉ
```sql
CREATE TABLE reconciliation_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    notification_type VARCHAR(50) NOT NULL,
    group_id UUID REFERENCES flexible_reconciliation_groups(id),
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    amount DECIMAL(15,2),
    recipient_id UUID REFERENCES users(id),
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    read_at TIMESTAMP
);

CREATE INDEX idx_recon_notif_recipient ON reconciliation_notifications(recipient_id, is_read);
```

#### Trigger ุฅุดุนุงุฑ ุงูุชุณููุฉ ุงููุจูุฑุฉ
```sql
CREATE OR REPLACE FUNCTION notify_large_reconciliation()
RETURNS TRIGGER AS $$
DECLARE
    v_threshold DECIMAL(15,2);
    v_roles TEXT[];
    v_user RECORD;
BEGIN
    -- ุฌูุจ ุงูุญุฏ ุงูุฃุฏูู ููุฅุดุนุงุฑ
    SELECT threshold_amount, notify_roles INTO v_threshold, v_roles
    FROM reconciliation_notification_settings
    WHERE notification_type = 'large_reconciliation' AND is_active = TRUE;
    
    -- ุฅุฐุง ุชุฌุงูุฒ ุงููุจูุบ ุงูุญุฏ
    IF NEW.total_debit >= COALESCE(v_threshold, 100000) THEN
        -- ุฅุฑุณุงู ุฅุดุนุงุฑ ููู ูุณุชุฎุฏู ูู ุงูุฃุฏูุงุฑ ุงููุญุฏุฏุฉ
        FOR v_user IN 
            SELECT u.id, u.full_name 
            FROM users u 
            JOIN user_roles ur ON u.id = ur.user_id
            JOIN roles r ON ur.role_id = r.id
            WHERE r.role_code = ANY(v_roles)
        LOOP
            INSERT INTO reconciliation_notifications (
                notification_type, group_id, title, message, amount, recipient_id
            ) VALUES (
                'large_reconciliation',
                NEW.id,
                'ุชุณููุฉ ูุจูุบ ูุจูุฑ',
                'ุชูุช ุชุณููุฉ ูุจูุบ ' || NEW.total_debit || ' ุฑ.ู',
                NEW.total_debit,
                v_user.id
            );
        END LOOP;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_notify_large_reconciliation
AFTER INSERT ON flexible_reconciliation_groups
FOR EACH ROW
EXECUTE FUNCTION notify_large_reconciliation();
```

#### Function ุฅุฑุณุงู ููุฎุต ูููู
```sql
CREATE OR REPLACE FUNCTION send_daily_reconciliation_summary()
RETURNS VOID AS $$
DECLARE
    v_roles TEXT[];
    v_user RECORD;
    v_summary RECORD;
BEGIN
    -- ุฌูุจ ุงูุฃุฏูุงุฑ
    SELECT notify_roles INTO v_roles
    FROM reconciliation_notification_settings
    WHERE notification_type = 'daily_summary' AND is_active = TRUE;
    
    -- ุญุณุงุจ ุงูููุฎุต
    SELECT 
        COUNT(*) AS total_reconciled,
        COALESCE(SUM(total_debit), 0) AS total_amount,
        (SELECT COUNT(*) FROM daily_transactions WHERE reconciliation_status = 'pending') AS pending_count
    INTO v_summary
    FROM flexible_reconciliation_groups
    WHERE created_at::DATE = CURRENT_DATE;
    
    -- ุฅุฑุณุงู ูููุณุชุฎุฏููู
    FOR v_user IN 
        SELECT u.id FROM users u 
        JOIN user_roles ur ON u.id = ur.user_id
        JOIN roles r ON ur.role_id = r.id
        WHERE r.role_code = ANY(v_roles)
    LOOP
        INSERT INTO reconciliation_notifications (
            notification_type, title, message, recipient_id
        ) VALUES (
            'daily_summary',
            'ููุฎุต ุงูุชุณููุงุช ุงููููู',
            'ุชู ุชุณููุฉ ' || v_summary.total_reconciled || ' ูุฌููุนุฉ ุจุฅุฌูุงูู ' || 
            v_summary.total_amount || ' ุฑ.ู. ุงูุญุฑูุงุช ุงููุนููุฉ: ' || v_summary.pending_count,
            v_user.id
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

### 1๏ธโฃ3๏ธโฃ ุดุงุดุงุช ุฅุถุงููุฉ

#### ุดุงุดุฉ ุณุฌู ุงูุชุณููุงุช
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ุณุฌู ุงูุชุณููุงุช                                                    [ุชุตุฏูุฑ] [ุทุจุงุนุฉ]    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ููุชุฑุฉ: [ูู ุชุงุฑูุฎ ___] [ุฅูู ุชุงุฑูุฎ ___] [ุงููุจูุบ ูู ___] [ุฅูู ___] [ุงูุญุณุงุจ โผ] [ุจุญุซ]   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ # โ ุงูุชุงุฑูุฎ    โ ุงููุจูุบ      โ ุงูุญุณุงุจุงุช          โ ุงูุนูุงุตุฑ โ ุงูููุดุฆ    โ [ุชูุงุตูู]     โ
โโโโโผโโโโโโโโโโโโโผโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโโผโโโโโโโโโโโโโโโค
โ 1 โ 18/12/2025 โ 500,000     โ ุตูุฏููุ ุจูู        โ 3       โ ุฃุญูุฏ      โ [๐๏ธ]         โ
โ 2 โ 18/12/2025 โ 150,000     โ ุตูุฏููุ ููุชุฑุฉุ ูุณุจูโ 4       โ ูุญูุฏ      โ [๐๏ธ]         โ
โ 3 โ 17/12/2025 โ 1,200,000   โ ุจููุ ููุฑุฏูู       โ 5       โ ุฃุญูุฏ      โ [๐๏ธ]         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุดุงุดุฉ ุชูุฑูุฑ ุงูุญุฑูุงุช ุงููุนููุฉ
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โณ ุชูุฑูุฑ ุงูุญุฑูุงุช ุงููุนููุฉ                                           [ุชุตุฏูุฑ] [ุทุจุงุนุฉ]    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงูุญุณุงุจ ุงููุณูุท          โ ุงูุนุฏุฏ โ 0-7 ุฃูุงู โ 8-14 ููู โ 15-30 ููู โ 31-60 ููู โ +60 ููู โ
โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโโผโโโโโโโโโโโโผโโโโโโโโโโค
โ ูุณูุท ุตูุฏูู ุงูุชุญุตูู    โ 45    โ 20       โ 15       โ 7         โ 2         โ 1       โ
โ ูุณูุท ุจูู ุงูุญูุดุจู      โ 32    โ 18       โ 10       โ 3         โ 1         โ 0       โ
โ ูุณูุท ุฅูุฑุงุฏุงุช ุงูููุชุฑุฉ  โ 28    โ 25       โ 3        โ 0         โ 0         โ 0       โ
โ ูุณูุท ุงูููุฑุฏูู         โ 15    โ 8        โ 5        โ 2         โ 0         โ 0       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโโผโโโโโโโโโโโโผโโโโโโโโโโค
โ ุงูุฅุฌูุงูู              โ 120   โ 71       โ 33       โ 12        โ 3         โ 1       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 1๏ธโฃ4๏ธโฃ APIs ุงูุฅุถุงููุฉ ูููู 42

```yaml
# ุชุฎุทูุท ุงูุฃููุงุญ
POST   /api/v1/reconciliation/layouts                     # ุญูุธ ุชุฎุทูุท ุฌุฏูุฏ
GET    /api/v1/reconciliation/layouts                     # ูุงุฆูุฉ ุงูุชุฎุทูุทุงุช
GET    /api/v1/reconciliation/layouts/default             # ุงูุชุฎุทูุท ุงูุงูุชุฑุงุถู
PUT    /api/v1/reconciliation/layouts/{id}                # ุชุญุฏูุซ ุชุฎุทูุท
DELETE /api/v1/reconciliation/layouts/{id}                # ุญุฐู ุชุฎุทูุท

# ุงูุจุญุซ ูุงูููุชุฑุฉ
POST   /api/v1/reconciliation/panels/{account_id}/search  # ุจุญุซ ูู ุญุฑูุงุช ุงูููุญ
GET    /api/v1/reconciliation/panels/stats                # ุฅุญุตุงุฆูุงุช ุงูุฃููุงุญ

# ุงูุชุตุฏูุฑ
GET    /api/v1/reconciliation/groups/{id}/export/pdf      # ุชุตุฏูุฑ PDF
GET    /api/v1/reconciliation/groups/{id}/export/excel    # ุชุตุฏูุฑ Excel
GET    /api/v1/reconciliation/groups/{id}/export/json     # ุชุตุฏูุฑ JSON

# ุณุฌู ุงูุชุณููุงุช
GET    /api/v1/reconciliation/history                     # ุณุฌู ุงูุชุณููุงุช
POST   /api/v1/reconciliation/history/search              # ุจุญุซ ูู ุงูุณุฌู

# ุชูุงุฑูุฑ ุงูุญุฑูุงุช ุงููุนููุฉ
GET    /api/v1/reconciliation/pending/summary             # ููุฎุต ุงููุนููุฉ
GET    /api/v1/reconciliation/pending/aging               # ุชูุงุฏู ุงููุนููุฉ
GET    /api/v1/reconciliation/pending/{account_id}        # ูุนููุฉ ุญุณุงุจ ูุญุฏุฏ

# ุงูุฅุดุนุงุฑุงุช
GET    /api/v1/reconciliation/notifications               # ุฅุดุนุงุฑุงุช ุงููุณุชุฎุฏู
PUT    /api/v1/reconciliation/notifications/{id}/read     # ุชุนููู ูููุฑูุก
GET    /api/v1/reconciliation/notifications/settings      # ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
PUT    /api/v1/reconciliation/notifications/settings      # ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช
```

---

### ููุงุท ุงูุฃูู ุงููุนุงูุฌุฉ (ุงูุฅุถุงูุงุช ุงูููุงุฆูุฉ)

| ููุทุฉ ุงูุฃูู | ุงูุญู |
|------------|------|
| ููุฏุงู ุชุฑุชูุจ ุงูุฃููุงุญ ุนูุฏ ูู ุฏุฎูู | ุญูุธ ุงูุชุฎุทูุท ููู ูุณุชุฎุฏู |
| ุตุนูุจุฉ ุฅูุฌุงุฏ ุญุฑูุฉ ูุนููุฉ | ุจุญุซ ูุชูุฏู ุจุงูุชุงุฑูุฎ ูุงููุจูุบ ูุงููุตู |
| ูุง ุชูุซูู ููุชุณููุงุช | ุชุตุฏูุฑ PDF/Excel ููู ูุฌููุนุฉ |
| ุตุนูุจุฉ ูุฑุงุฌุนุฉ ุงูุชุณููุงุช ุงูุณุงุจูุฉ | ุณุฌู ุชุงุฑูุฎ ุดุงูู ูุน ุจุญุซ |
| ูุง ูุนุฑูุฉ ุจุนุฏุฏ ุงูุญุฑูุงุช ุงููุนููุฉ | ุชูุฑูุฑ ููุฎุต ูุชูุตููู ุจุงูุชูุงุฏู |
| ุงููุดุฑู ูุง ูุนูู ุจุงูุชุณููุงุช ุงููุจูุฑุฉ | ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ูููุจุงูุบ ุงููุจูุฑุฉ |

---

# ๐ ุงูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ (02)

## ูุธุฑุฉ ุนุงูุฉ

ุงููุธุงู ุงูุฃู ูู ุงููุฑูุฒ ุงูุฑุฆูุณู ุงูุฐู ุชุชุตู ุจู ุฌููุน ุงูุฃูุธูุฉ ุนุจุฑ ูุธุงู ุงููุทูุฑ:
1. **ุงููุตุงุฏูุฉ ุงููุฑูุฒูุฉ** - ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ูุงูุฌูุณุงุช
2. **ุดุฌุฑุฉ ุงูุญุณุงุจุงุช** - ุงููุฑุฌุน ุงููุญุงุณุจู ุงูููุญุฏ
3. **ูุญุฑู ุงูุชุณููุฉ** - ุชุณููุฉ ุงููุนุงููุงุช ุจูู ุงูุฃูุธูุฉ
4. **ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ** - ุฅุนุฏุงุฏุงุช ุงููุณุชุฃุฌุฑูู

---

## ๐ก APIs ุงููุณุฌูุฉ ูู ูุธุงู ุงููุทูุฑ

ุฌููุน APIs ุงููุธุงู ุงูุฃู ูุชุงุญุฉ ุนุจุฑ `/api/core/*`:

| ุงููุฌููุนุฉ | Endpoint | ุงููุตู |
|----------|----------|-------|
| ุงููุณุชุฃุฌุฑูู | `/api/core/tenants` | ุฅุฏุงุฑุฉ ุงููุณุชุฃุฌุฑูู |
| ุงููุณุชุฎุฏููู | `/api/core/users` | ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู |
| ุงูุฃุฏูุงุฑ | `/api/core/roles` | ุฅุฏุงุฑุฉ ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช |
| ุงูุญุณุงุจุงุช | `/api/core/accounts` | ุดุฌุฑุฉ ุงูุญุณุงุจุงุช |
| ุงููููุฏ | `/api/core/journal-entries` | ุงููููุฏ ุงููุญุงุณุจูุฉ |
| ุงูุชุณููุฉ | `/api/core/reconciliation` | ูุญุฑู ุงูุชุณููุฉ |

---

## ๐ฏ ุงูุฃุญุฏุงุซ ุงูููุดูุฑุฉ

```
user.created                - ุฅูุดุงุก ูุณุชุฎุฏู
user.updated                - ุชุญุฏูุซ ูุณุชุฎุฏู
user.deactivated            - ุชุนุทูู ูุณุชุฎุฏู
user.login                  - ุชุณุฌูู ุฏุฎูู
user.logout                 - ุชุณุฌูู ุฎุฑูุฌ

account.created             - ุฅูุดุงุก ุญุณุงุจ
account.updated             - ุชุญุฏูุซ ุญุณุงุจ

journal.created             - ุฅูุดุงุก ููุฏ
journal.posted              - ุชุฑุญูู ููุฏ
journal.reversed            - ุนูุณ ููุฏ

period.closed               - ุฅุบูุงู ูุชุฑุฉ
period.reopened             - ุฅุนุงุฏุฉ ูุชุญ ูุชุฑุฉ

reconciliation.completed    - ุฅููุงู ุชุณููุฉ
```

---

## ๐ฅ ุงูุฃุญุฏุงุซ ุงููุณุชูุจูุฉ

ุงููุธุงู ุงูุฃู ูุณุชูุจู ุงูุฃุญุฏุงุซ ูู ุฌููุน ุงูุฃูุธูุฉ ูุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ:

| ุงูุญุฏุซ | ุงููุตุฏุฑ | ุงูุฅุฌุฑุงุก |
|-------|--------|---------|
| `invoice.paid` | ุงูุนููุงุก ูุงูููุชุฑุฉ | ููุฏ ุฅูุฑุงุฏ |
| `payroll.approved` | ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ | ููุฏ ุฑูุงุชุจ |
| `purchase.received` | ุงููุฎุฒูู ูุงููุดุชุฑูุงุช | ููุฏ ูุดุชุฑูุงุช |
| `inventory.issued` | ุงููุฎุฒูู ูุงููุดุชุฑูุงุช | ููุฏ ุตุฑู ูุฎุฒูู |
| `depreciation.calculated` | ุงูุฃุตูู ูุงูุตูุงูุฉ | ููุฏ ุฅููุงู |

---

## ๐ ุงููุตุงุฏูุฉ ุงููุฑูุฒูุฉ

### APIs ุงููุตุงุฏูุฉ (`/api/auth/*`)

```
POST   /api/auth/login              - ุชุณุฌูู ุงูุฏุฎูู
POST   /api/auth/logout             - ุชุณุฌูู ุงูุฎุฑูุฌ
POST   /api/auth/refresh            - ุชุฌุฏูุฏ ุงูุชููู
POST   /api/auth/forgot-password    - ูุณูุช ูููุฉ ุงููุฑูุฑ
POST   /api/auth/reset-password     - ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ
GET    /api/auth/me                 - ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
GET    /api/auth/permissions        - ุตูุงุญูุงุช ุงููุณุชุฎุฏู
```

### ูููู ุงูุชููู (JWT)

```json
{
  "sub": "user_id",
  "tenant_id": "tenant_id",
  "roles": ["admin", "accountant"],
  "permissions": ["invoices.create", "reports.view"],
  "exp": 1734567890,
  "iat": 1734481490
}
```

---

## ๐ ููุงููุณ ุงูุฃุฏุงุก ุงููุฑุณูุฉ ููุธุงู ุงููุทูุฑ

```sql
INSERT INTO performance_metrics (metric_name, metric_type, metric_value, labels)
VALUES
  ('core.active_users', 'gauge', 150, '{}'),
  ('core.active_sessions', 'gauge', 85, '{}'),
  ('core.journal_entries_today', 'counter', 250, '{}'),
  ('core.reconciliation_pending', 'gauge', 15, '{}');
```


---

# ๐ ุงูุญุณุงุจุงุช ุงูุฅุถุงููุฉ (ุชูููุฉ ุดุฌุฑุฉ ุงูุญุณุงุจุงุช)

## ุงูุฃุตูู ุงูุซุงุจุชุฉ (Fixed Assets) - 1400-1600

```
1400 - ุงูุฃุตูู ุงูุซุงุจุชุฉ
  1401 - ุงููููุฏุงุช ุงูููุฑุจุงุฆูุฉ
  1402 - ุงูุฃููุงุญ ุงูุดูุณูุฉ
  1403 - ุงููุญููุงุช ุงูููุฑุจุงุฆูุฉ
  1404 - ุงูููุงุจู ูุงูุดุจูุงุช
  1405 - ุงูุนุฏุงุฏุงุช ุงููุฑูุจุฉ
  1406 - ูุนุฏุงุช SCADA
  1407 - ุงููุจุงูู ูุงูููุดุขุช
  1408 - ุงูุณูุงุฑุงุช ูุงููุฑูุจุงุช
  1409 - ุงูุฃุซุงุซ ูุงูุชุฌููุฒุงุช
  1410 - ุฃุฌูุฒุฉ ุงูุญุงุณูุจ ูุงูุจุฑูุฌูุงุช

1500 - ูุฌูุน ุงูุฅููุงู
  1501 - ูุฌูุน ุฅููุงู ุงููููุฏุงุช
  1502 - ูุฌูุน ุฅููุงู ุงูุฃููุงุญ ุงูุดูุณูุฉ
  1503 - ูุฌูุน ุฅููุงู ุงููุญููุงุช
  1504 - ูุฌูุน ุฅููุงู ุงูููุงุจู
  1505 - ูุฌูุน ุฅููุงู ุงูุนุฏุงุฏุงุช
  1506 - ูุฌูุน ุฅููุงู ูุนุฏุงุช SCADA
  1507 - ูุฌูุน ุฅููุงู ุงููุจุงูู
  1508 - ูุฌูุน ุฅููุงู ุงูุณูุงุฑุงุช
  1509 - ูุฌูุน ุฅููุงู ุงูุฃุซุงุซ
  1510 - ูุฌูุน ุฅููุงู ุงูุญุงุณูุจ

1600 - ุงููุดุงุฑูุน ุชุญุช ุงูุชูููุฐ
  1601 - ูุดุงุฑูุน ุชูุณุนุฉ ุงูุดุจูุฉ
  1602 - ูุดุงุฑูุน ูุญุทุงุช ุฌุฏูุฏุฉ
  1603 - ูุดุงุฑูุน ุงูุทุงูุฉ ุงูุดูุณูุฉ
  1604 - ูุดุงุฑูุน ุชุญุฏูุซ ุงูุจููุฉ ุงูุชุญุชูุฉ
```

## ุงูุนูุฏ ูุงูุณูู - 1700

```
1700 - ุงูุนูุฏ ูุงูุณูู
  1701 - ุนูุฏ ุงูููุธููู
  1702 - ุณูู ุงูููุธููู
  1703 - ุนูุฏ ุงููุดุงุฑูุน
  1704 - ุนูุฏ ุงูุนูููุงุช ุงูููุฏุงููุฉ
```

## ูุณุชุญูุงุช ุงูููุธููู - 2400

```
2400 - ูุณุชุญูุงุช ุงูููุธููู
  2401 - ุฑูุงุชุจ ูุณุชุญูุฉ
  2402 - ููุงูุขุช ูุณุชุญูุฉ
  2403 - ุฅุฌุงุฒุงุช ูุณุชุญูุฉ
  2404 - ููุงูุฉ ุฎุฏูุฉ ูุณุชุญูุฉ
  2405 - ุชุฃูููุงุช ุงุฌุชูุงุนูุฉ ูุณุชุญูุฉ
  2406 - ุถุฑุงุฆุจ ุฏุฎู ูุณุชุญูุฉ
```

## ูุตุฑููุงุช ุงูุฑูุงุชุจ - 5300

```
5300 - ูุตุฑููุงุช ุงูุฑูุงุชุจ ูุงูุฃุฌูุฑ
  5301 - ุงูุฑูุงุชุจ ุงูุฃุณุงุณูุฉ
  5302 - ุงูุจุฏูุงุช
  5303 - ุงูุนูู ุงูุฅุถุงูู
  5304 - ุงูููุงูุขุช ูุงูุญูุงูุฒ
  5305 - ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ (ุญุตุฉ ุงูุดุฑูุฉ)
  5306 - ุงูุชุฃููู ุงูุตุญู
  5307 - ูุตุฑููุงุช ุงูุชุฏุฑูุจ
```

## ูุตุฑููุงุช ุงูุฅููุงู - 5400

```
5400 - ูุตุฑููุงุช ุงูุฅููุงู
  5401 - ุฅููุงู ุงููููุฏุงุช
  5402 - ุฅููุงู ุงูุฃููุงุญ ุงูุดูุณูุฉ
  5403 - ุฅููุงู ุงููุญููุงุช
  5404 - ุฅููุงู ุงูููุงุจู
  5405 - ุฅููุงู ุงูุนุฏุงุฏุงุช
  5406 - ุฅููุงู ูุนุฏุงุช SCADA
  5407 - ุฅููุงู ุงููุจุงูู
  5408 - ุฅููุงู ุงูุณูุงุฑุงุช
  5409 - ุฅููุงู ุงูุฃุซุงุซ
  5410 - ุฅููุงู ุงูุญุงุณูุจ
```

## ูุตุฑููุงุช ุงูุชุดุบูู - 5500

```
5500 - ูุตุฑููุงุช ุงูุชุดุบูู
  5501 - ุงููููุฏ ูุงูุฏูุฒู
  5502 - ุงูุฒููุช ูุงูุดุญูู
  5503 - ูุทุน ุงูุบูุงุฑ
  5504 - ููุงุฏ ุงูุตูุงูุฉ
  5505 - ุฎุฏูุงุช ุงูุตูุงูุฉ ุงูุฎุงุฑุฌูุฉ
  5506 - ุงูููุฑุจุงุก ูุงููุงุก
  5507 - ุงูุงุชุตุงูุงุช ูุงูุฅูุชุฑูุช
```

---

## ุฌุฏูู ุฑุจุท ุงูุญุณุงุจุงุช ุจุงูุฃูุธูุฉ

| ุงููุธุงู | ุงูุญุณุงุจุงุช ุงููุฑุชุจุทุฉ |
|--------|------------------|
| ุงูุฃุตูู ูุงูุตูุงูุฉ (03) | 1400-1410, 1500-1510, 5400-5410 |
| ุงูุนูููุงุช ุงูููุฏุงููุฉ (04) | 1700-1704, 5500-5507 |
| ุงููุฑุงูุจุฉ ูุงูุชุญูู (05) | 1406, 1506, 5406 |
| ุงููุฎุฒูู ูุงููุดุชุฑูุงุช (06) | 1200-1205, 2000-2002, 5000-5002 |
| ุงูุนููุงุก ูุงูููุชุฑุฉ (07) | 1100-1103, 2100-2102, 2200-2202, 4000-4203 |
| ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ (08) | 1702, 2400-2406, 5300-5307 |
| ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10) | 1600-1604, 1703 |


---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ ูููุธุงู

### ูุนูููุงุช ุงููุณุชูุฏุน

| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงุณู ุงููุณุชูุฏุน** | `core-system` |
| **ุงููููุฐ API** | 3001 |
| **ุงููููุฐ Web** | 4201 |
| **ุจุงุฏุฆุฉ ุงูุฌุฏุงูู** | `core_` |
| **ูุณุงุฑ API** | `/api/v1/core` |

### ูููู ุงููุณุชูุฏุน

```
core-system/
โโโ apps/
โ   โโโ web/                          # Angular Frontend
โ   โ   โโโ src/
โ   โ   โ   โโโ app/
โ   โ   โ   โ   โโโ core/             # Auth, Guards, Interceptors
โ   โ   โ   โ   โโโ shared/           # Shared Components
โ   โ   โ   โ   โโโ features/
โ   โ   โ   โ       โโโ dashboard/
โ   โ   โ   โ       โโโ users/
โ   โ   โ   โ       โโโ roles/
โ   โ   โ   โ       โโโ organizations/
โ   โ   โ   โ       โโโ accounts/
โ   โ   โ   โ       โโโ journal-entries/
โ   โ   โ   โ       โโโ reconciliation/
โ   โ   โ   โ       โโโ settings/
โ   โ   โ   โโโ assets/i18n/
โ   โ   โโโ project.json
โ   โ
โ   โโโ api/                          # NestJS Backend
โ       โโโ src/
โ       โ   โโโ modules/
โ       โ   โ   โโโ auth/
โ       โ   โ   โโโ users/
โ       โ   โ   โโโ roles/
โ       โ   โ   โโโ organizations/
โ       โ   โ   โโโ accounts/
โ       โ   โ   โโโ journal-entries/
โ       โ   โ   โโโ reconciliation/
โ       โ   โ   โโโ settings/
โ       โ   โโโ common/
โ       โ   โโโ prisma/
โ       โโโ project.json
โ
โโโ prisma/
โ   โโโ schema.prisma
โโโ docker-compose.yml
โโโ package.json
```

### Prisma Schema (ุงููุธุงู ุงูุฃู)

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Core System Tables ====================

// ุงููุณุชุฎุฏููู
model core_users {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  username      String    @unique @db.VarChar(50)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  
  firstName     String    @map("first_name") @db.VarChar(100)
  lastName      String    @map("last_name") @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  avatar        String?   @db.VarChar(500)
  
  roleId        String    @map("role_id") @db.Uuid
  organizationId String?  @map("organization_id") @db.Uuid
  stationId     String?   @map("station_id") @db.Uuid
  
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")
  
  role          core_roles @relation(fields: [roleId], references: [id])
  organization  core_organizations? @relation(fields: [organizationId], references: [id])
  sessions      core_sessions[]
  
  @@index([email])
  @@index([roleId])
  @@index([organizationId])
  @@map("core_users")
}

// ุงูุฃุฏูุงุฑ
model core_roles {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(50)
  name        String   @db.VarChar(100)
  nameEn      String?  @map("name_en") @db.VarChar(100)
  description String?  @db.Text
  
  isSystem    Boolean  @default(false) @map("is_system")
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  users       core_users[]
  permissions core_role_permissions[]
  
  @@map("core_roles")
}

// ุงูุตูุงุญูุงุช
model core_permissions {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(100)
  name        String   @db.VarChar(100)
  nameEn      String?  @map("name_en") @db.VarChar(100)
  module      String   @db.VarChar(50)
  description String?  @db.Text
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  roles       core_role_permissions[]
  
  @@index([module])
  @@map("core_permissions")
}

// ุฑุจุท ุงูุฃุฏูุงุฑ ุจุงูุตูุงุญูุงุช
model core_role_permissions {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid
  
  role         core_roles @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   core_permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@id([roleId, permissionId])
  @@map("core_role_permissions")
}

// ุฌูุณุงุช ุงููุณุชุฎุฏููู
model core_sessions {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  token        String   @unique @db.VarChar(500)
  refreshToken String?  @map("refresh_token") @db.VarChar(500)
  
  ipAddress    String?  @map("ip_address") @db.VarChar(50)
  userAgent    String?  @map("user_agent") @db.Text
  
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  user         core_users @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("core_sessions")
}

// ุงููููู ุงูุชูุธููู
model core_organizations {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(200)
  nameEn      String?  @map("name_en") @db.VarChar(200)
  type        String   @db.VarChar(50) // group, station
  parentId    String?  @map("parent_id") @db.Uuid
  
  address     String?  @db.Text
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  parent      core_organizations?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children    core_organizations[] @relation("OrgHierarchy")
  users       core_users[]
  
  @@index([parentId])
  @@index([type])
  @@map("core_organizations")
}

// ุดุฌุฑุฉ ุงูุญุณุงุจุงุช
model core_accounts {
  id            String   @id @default(uuid()) @db.Uuid
  code          String   @unique @db.VarChar(20)
  name          String   @db.VarChar(200)
  nameEn        String?  @map("name_en") @db.VarChar(200)
  
  type          String   @db.VarChar(20) // asset, liability, equity, revenue, expense
  nature        String   @db.VarChar(10) // debit, credit
  level         Int      @default(1)
  parentId      String?  @map("parent_id") @db.Uuid
  
  isActive      Boolean  @default(true) @map("is_active")
  isPostable    Boolean  @default(true) @map("is_postable")
  
  openingBalance Decimal @default(0) @map("opening_balance") @db.Decimal(15, 2)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(15, 2)
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  parent        core_accounts?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children      core_accounts[] @relation("AccountHierarchy")
  journalLines  core_journal_lines[]
  
  @@index([parentId])
  @@index([type])
  @@index([code])
  @@map("core_accounts")
}

// ุงููููุฏ ุงููุญุงุณุจูุฉ
model core_journal_entries {
  id              String   @id @default(uuid()) @db.Uuid
  entryNumber     String   @unique @map("entry_number") @db.VarChar(50)
  
  entryDate       DateTime @map("entry_date") @db.Date
  postingDate     DateTime? @map("posting_date") @db.Date
  
  type            String   @db.VarChar(50)
  description     String?  @db.Text
  
  referenceType   String?  @map("reference_type") @db.VarChar(50)
  referenceId     String?  @map("reference_id") @db.Uuid
  referenceNumber String?  @map("reference_number") @db.VarChar(50)
  
  totalDebit      Decimal  @map("total_debit") @db.Decimal(15, 2)
  totalCredit     Decimal  @map("total_credit") @db.Decimal(15, 2)
  
  status          String   @default("draft") @db.VarChar(20)
  
  createdBy       String   @map("created_by") @db.Uuid
  approvedBy      String?  @map("approved_by") @db.Uuid
  approvedAt      DateTime? @map("approved_at")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  lines           core_journal_lines[]
  
  @@index([entryDate])
  @@index([status])
  @@index([type])
  @@map("core_journal_entries")
}

// ุณุทูุฑ ุงููููุฏ
model core_journal_lines {
  id            String   @id @default(uuid()) @db.Uuid
  journalId     String   @map("journal_id") @db.Uuid
  accountId     String   @map("account_id") @db.Uuid
  
  description   String?  @db.VarChar(500)
  
  debit         Decimal  @default(0) @db.Decimal(15, 2)
  credit        Decimal  @default(0) @db.Decimal(15, 2)
  
  costCenterId  String?  @map("cost_center_id") @db.Uuid
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  journal       core_journal_entries @relation(fields: [journalId], references: [id], onDelete: Cascade)
  account       core_accounts @relation(fields: [accountId], references: [id])
  
  @@index([journalId])
  @@index([accountId])
  @@map("core_journal_lines")
}

// ูุฑุงูุฒ ุงูุชูููุฉ
model core_cost_centers {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(200)
  nameEn      String?  @map("name_en") @db.VarChar(200)
  
  type        String   @db.VarChar(50)
  parentId    String?  @map("parent_id") @db.Uuid
  
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  parent      core_cost_centers?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children    core_cost_centers[] @relation("CostCenterHierarchy")
  
  @@index([parentId])
  @@map("core_cost_centers")
}

// ุงููุชุฑุงุช ุงููุงููุฉ
model core_fiscal_periods {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  
  year        Int
  month       Int
  quarter     Int
  
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  
  status      String   @default("open") @db.VarChar(20) // open, closed, locked
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@unique([year, month])
  @@map("core_fiscal_periods")
}

// ุงูุชุณููุงุช
model core_reconciliations {
  id              String   @id @default(uuid()) @db.Uuid
  reconciliationNumber String @unique @map("reconciliation_number") @db.VarChar(50)
  
  type            String   @db.VarChar(50)
  periodId        String   @map("period_id") @db.Uuid
  
  sourceSystem    String   @map("source_system") @db.VarChar(50)
  targetSystem    String   @map("target_system") @db.VarChar(50)
  
  sourceAmount    Decimal  @map("source_amount") @db.Decimal(15, 2)
  targetAmount    Decimal  @map("target_amount") @db.Decimal(15, 2)
  difference      Decimal  @db.Decimal(15, 2)
  
  status          String   @default("pending") @db.VarChar(20)
  notes           String?  @db.Text
  
  reconciledBy    String?  @map("reconciled_by") @db.Uuid
  reconciledAt    DateTime? @map("reconciled_at")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([periodId])
  @@index([status])
  @@map("core_reconciliations")
}

// ุฅุนุฏุงุฏุงุช ุงููุธุงู
model core_settings {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  type        String   @default("string") @db.VarChar(20)
  module      String   @default("general") @db.VarChar(50)
  description String?  @db.Text
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([module])
  @@map("core_settings")
}
```

### NestJS Modules

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { EventEmitterModule } from '@nestjs/event-emitter';

import { PrismaModule } from './prisma/prisma.module';
import { AuthModule } from './modules/auth/auth.module';
import { UsersModule } from './modules/users/users.module';
import { RolesModule } from './modules/roles/roles.module';
import { OrganizationsModule } from './modules/organizations/organizations.module';
import { AccountsModule } from './modules/accounts/accounts.module';
import { JournalEntriesModule } from './modules/journal-entries/journal-entries.module';
import { ReconciliationModule } from './modules/reconciliation/reconciliation.module';
import { SettingsModule } from './modules/settings/settings.module';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    EventEmitterModule.forRoot(),
    PrismaModule,
    AuthModule,
    UsersModule,
    RolesModule,
    OrganizationsModule,
    AccountsModule,
    JournalEntriesModule,
    ReconciliationModule,
    SettingsModule,
  ],
})
export class AppModule {}
```

### Environment Variables

```env
# .env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/electricity_management"

JWT_SECRET="core-system-secret-key-change-in-production"
JWT_EXPIRES_IN="7d"

API_PORT=3001
API_PREFIX="api/v1"

# ููุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู
DEVELOPER_API_URL="http://localhost:3002/api/v1"
```
